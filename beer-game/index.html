<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•¤é…’æ¸¸æˆ (The Beer Game)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            background: linear-gradient(rgba(30, 20, 15, 0.85), rgba(30, 20, 15, 0.95)), 
                        url('https://images.unsplash.com/photo-1514933651103-005eec06c04b?q=80&w=1934&auto=format&fit=crop') center/cover fixed;
            color: #f8fafc; 
            overflow-x: hidden;
        }

        .chart-container { position: relative; width: 100%; height: 350px; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.4s ease-out forwards; }
        
        @keyframes flashDanger { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #fca5a5; } }
        .bg-flash-danger { animation: flashDanger 1s infinite; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px) rotate(-1deg); }
            40% { transform: translateX(8px) rotate(1deg); }
            60% { transform: translateX(-8px) rotate(-1deg); }
            80% { transform: translateX(8px) rotate(1deg); }
        }
        .screen-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes clink {
            0% { transform: scale(1) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.5) rotate(15deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 0; }
        }
        .animate-clink { animation: clink 1s ease-in-out forwards; display: inline-block; }

        .hidden { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .glass-card { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); color: #0f172a; }
        .chat-bubble-me { background-color: #3b82f6; color: white; border-radius: 12px 12px 0 12px; }
        .chat-bubble-sys { background-color: #e2e8f0; color: #1e293b; border-radius: 12px 12px 12px 0; }

        /* Dropdown transition */
        .dropdown-menu { transform-origin: top right; transition: all 0.2s ease; opacity: 0; transform: scale(0.95); pointer-events: none; }
        .dropdown-menu.active { opacity: 1; transform: scale(1); pointer-events: auto; }
    </style>
</head>
<body class="flex flex-col min-h-screen" id="main-body" onclick="closeDropdowns(event)">

    <!-- é¡¶æ  -->
    <header class="bg-black/60 backdrop-blur-md text-amber-500 shadow-md z-10 sticky top-0 border-b border-amber-900/50">
        <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ğŸº</span>
                <h1 class="text-xl font-black tracking-widest text-amber-400" data-i18n="app_title">å•¤é…’æ¸¸æˆ</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- æ¸¸æˆè¿›åº¦çŠ¶æ€ -->
                <div id="header-status" class="hidden items-center gap-4 text-sm mr-4">
                    <div class="flex items-center gap-2">
                        <span class="text-slate-300" data-i18n="player">ç©å®¶:</span>
                        <span id="ui-player-name" class="font-bold text-white tracking-wide">--</span>
                    </div>
                    <div class="bg-amber-900/50 px-4 py-1.5 rounded-full border border-amber-700/50 shadow-inner">
                        <span data-i18n="week">å‘¨æ¬¡</span> <span id="ui-week-counter" class="text-amber-400 font-bold text-lg mx-1">1</span> / 26
                    </div>
                </div>

                <!-- å…³äºæŒ‰é’® -->
                <button onclick="toggleModal('info-modal')" class="w-8 h-8 flex items-center justify-center rounded-full border border-slate-500 text-slate-300 hover:text-white hover:bg-white/20 transition-all" title="About / å…³äº">
                    <span class="text-base leading-none">â„¹ï¸</span>
                </button>

                <!-- è¯­è¨€åˆ‡æ¢ä¸‹æ‹‰ (è¿›å…¥æ¸¸æˆåä¼šè¢«éšè—) -->
                <div class="relative" id="lang-wrapper">
                    <button onclick="toggleDropdown(event, 'lang-dropdown')" class="flex items-center gap-1 text-xl bg-slate-800/80 px-2 py-1 rounded hover:bg-slate-700 transition border border-slate-600">
                        <span id="current-flag">ğŸ‡¨ğŸ‡³</span> <span class="text-[10px] text-slate-300">â–¼</span>
                    </button>
                    <div id="lang-dropdown" class="dropdown-menu absolute right-0 mt-2 w-32 bg-white rounded-lg shadow-xl border border-slate-200 py-1 z-50">
                        <button onclick="setLanguage('zh', 'ğŸ‡¨ğŸ‡³')" class="w-full text-left px-4 py-2 hover:bg-slate-100 text-slate-800 text-sm flex items-center gap-2"><span class="text-lg">ğŸ‡¨ğŸ‡³</span> ä¸­æ–‡</button>
                        <button onclick="setLanguage('en', 'ğŸ‡ºğŸ‡¸')" class="w-full text-left px-4 py-2 hover:bg-slate-100 text-slate-800 text-sm flex items-center gap-2"><span class="text-lg">ğŸ‡ºğŸ‡¸</span> English</button>
                        <button onclick="setLanguage('es', 'ğŸ‡ªğŸ‡¸')" class="w-full text-left px-4 py-2 hover:bg-slate-100 text-slate-800 text-sm flex items-center gap-2"><span class="text-lg">ğŸ‡ªğŸ‡¸</span> EspaÃ±ol</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- é¡¶éƒ¨æ–°é—»æ»šåŠ¨ -->
    <div id="event-banner" class="bg-amber-50 border-b border-amber-200 text-amber-900 px-4 py-2 shadow-sm relative z-0 flex items-center justify-center transition-all duration-500 overflow-hidden max-h-0 opacity-0">
        <div class="flex items-center gap-3">
            <span class="text-xl animate-pulse">ğŸ“°</span>
            <div><strong data-i18n="news_title">å•†ä¸šå¤´æ¡ï¼š</strong> <span id="event-desc" class="text-sm font-bold"></span></div>
        </div>
    </div>

    <!-- ä¸»ä½“åŒºåŸŸ -->
    <main class="flex-grow w-full max-w-7xl mx-auto px-4 py-8 relative">

        <!-- ========================================== -->
        <!-- ç•Œé¢ 1: è®¾ç½®å¤§å…                           -->
        <!-- ========================================== -->
        <div id="screen-setup" class="slide-in max-w-3xl mx-auto glass-card rounded-2xl shadow-2xl overflow-hidden relative">
            
            <button onclick="toggleModal('rules-modal')" class="absolute top-4 right-4 bg-white/20 hover:bg-white/40 text-white border border-white/50 backdrop-blur-sm px-4 py-2 rounded-full text-sm font-bold transition flex items-center gap-2 z-10">
                <span>ğŸ“–</span> <span data-i18n="btn_rules">æ¸¸æˆè§„åˆ™æ‰‹å†Œ</span>
            </button>

            <div class="bg-amber-600 pt-10 pb-8 px-8 text-white text-center relative">
                <h2 class="text-4xl font-black mb-2 tracking-widest" data-i18n="setup_title_new">å•¤é…’æ¸¸æˆ</h2>
                <p class="text-amber-100 text-sm font-medium tracking-wide" data-i18n="setup_desc">ä½ èƒ½å¦åœ¨ä¿¡æ¯çš„è¿·é›¾ä¸å»¶è¿Ÿä¸­ï¼Œæ‰“ç ´ç‰›é­æ•ˆåº”çš„é­”å’’ï¼Ÿ</p>
            </div>
            
            <div class="p-8 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2" data-i18n="char_name">1. è§’è‰²åç§°ï¼š</label>
                        <input type="text" id="input-player-name" class="w-full px-4 py-3 rounded-xl border-2 border-slate-300 focus:border-amber-500 focus:ring-0 outline-none text-lg transition-colors bg-white">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2" data-i18n="story_bg">2. æ•…äº‹èƒŒæ™¯ (å½±å“å­£èŠ‚èµ°åŠ¿)ï¼š</label>
                        <select id="input-start-month" class="w-full px-4 py-3 rounded-xl border-2 border-slate-300 focus:border-amber-500 focus:ring-0 outline-none text-lg transition-colors bg-white">
                            <option value="1" data-i18n="bg_1">å¯’å†¬å¼€å±€ (1æœˆ)</option>
                            <option value="4" data-i18n="bg_4">è¿æˆ˜å¤å­£æ—ºå­£ (4æœˆ)</option>
                            <option value="7" data-i18n="bg_7">æ—ºå­£å·…å³°å¼€å±€ (7æœˆ)</option>
                            <option value="10" data-i18n="bg_10">ç§‹å­£å¹³ç¨³å¼€å±€ (10æœˆ)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-bold text-slate-700 mb-3" data-i18n="setup_step2">3. é€‰æ‹©æ‰®æ¼”è§’è‰²ï¼š</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="role" value="retailer" class="peer sr-only" checked onchange="updateSelectedRole(this.value)">
                            <div class="p-3 rounded-xl border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:bg-amber-50 hover:bg-slate-50 transition-all text-center">
                                <div class="text-2xl mb-1">ğŸª</div><div class="font-bold text-slate-800 text-sm" data-i18n="role_ret">é›¶å”®å•†</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="role" value="wholesaler" class="peer sr-only" onchange="updateSelectedRole(this.value)">
                            <div class="p-3 rounded-xl border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:bg-amber-50 hover:bg-slate-50 transition-all text-center">
                                <div class="text-2xl mb-1">ğŸ¢</div><div class="font-bold text-slate-800 text-sm" data-i18n="role_who">æ‰¹å‘å•†</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="role" value="distributor" class="peer sr-only" onchange="updateSelectedRole(this.value)">
                            <div class="p-3 rounded-xl border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:bg-amber-50 hover:bg-slate-50 transition-all text-center">
                                <div class="text-2xl mb-1">ğŸš›</div><div class="font-bold text-slate-800 text-sm" data-i18n="role_dis">åˆ†é”€å•†</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="role" value="factory" class="peer sr-only" onchange="updateSelectedRole(this.value)">
                            <div class="p-3 rounded-xl border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:bg-amber-50 hover:bg-slate-50 transition-all text-center">
                                <div class="text-2xl mb-1">ğŸ­</div><div class="font-bold text-slate-800 text-sm" data-i18n="role_fac">å·¥å‚</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- AI assignment is now hidden and handled by the system -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-sm text-blue-800 flex gap-3 items-start">
                    <span class="text-xl">ğŸ¤–</span>
                    <div>
                        <strong data-i18n="ai_note_title">AI é˜Ÿå‹å·²å‡†å¤‡å°±ç»ªï¼š</strong><br>
                        <span data-i18n="ai_note_desc">ç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åˆ†é… 3 ä½æ€§æ ¼å„å¼‚çš„ AI é˜Ÿå‹ï¼ˆæ€¥èºã€è¿Ÿé’æˆ–ç†æ€§ï¼‰ã€‚è¯·æ³¨æ„ï¼Œç†æ€§é˜Ÿå‹è‡³å¤šåªæœ‰ 1 ä½ã€‚çœŸå®çš„ä¾›åº”é“¾ä¸­ï¼Œä½ æ°¸è¿œä¸çŸ¥é“ä½ çš„ä¸Šä¸‹æ¸¸åœ¨æƒ³ä»€ä¹ˆã€‚</span>
                    </div>
                </div>

                <button onclick="startIntroAnimation()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-black py-4 rounded-xl text-xl transition-all active:scale-[0.98] shadow-lg" data-i18n="btn_start">
                    è¿›å…¥é…’é¦†å¼€å§‹æ¸¸æˆ
                </button>
            </div>
        </div>

        <!-- å€’åœºåŠ¨ç”» -->
        <div id="screen-intro" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center text-white">
            <div id="countdown-text" class="text-9xl font-black text-amber-500 tracking-widest drop-shadow-[0_0_20px_rgba(245,158,11,0.8)]">3</div>
            <div id="clink-emoji" class="hidden text-9xl">ğŸ»</div>
        </div>

        <!-- ========================================== -->
        <!-- ç•Œé¢ 2: æ¸¸æˆæ§åˆ¶å°                         -->
        <!-- ========================================== -->
        <div id="screen-game" class="hidden slide-in flex flex-col lg:flex-row gap-6">
            <div class="flex-grow space-y-6">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-card rounded-2xl p-5 border-l-4 border-l-indigo-500 flex items-center justify-between shadow-lg">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase" data-i18n="upstream">æˆ‘çš„ä¸Šæ¸¸</div>
                            <div class="text-xl font-black text-slate-800" id="ui-upstream-name">--</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500" data-i18n="transit_title">åœ¨é€”å°†åˆ°è¾¾</div>
                            <div class="text-2xl font-black text-indigo-600"><span id="ui-transit-1">0</span></div>
                            <div class="text-[10px] text-slate-400"><span data-i18n="transit_2">ä¸¤å‘¨å:</span> <span id="ui-transit-2">0</span></div>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 border-l-4 border-l-orange-500 flex items-center justify-between shadow-lg">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase" data-i18n="downstream">æˆ‘çš„ä¸‹æ¸¸ (éœ€æ±‚æ–¹)</div>
                            <div class="text-xl font-black text-slate-800" id="ui-downstream-name">--</div>
                        </div>
                        <div class="text-right bg-orange-50 p-2 rounded-lg border border-orange-100">
                            <div class="text-xs text-orange-800 font-bold" data-i18n="incoming_order">æ”¶åˆ°æ–°è®¢å•</div>
                            <div class="text-3xl font-black text-orange-600" id="ui-incoming-order">0</div>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-8 border-t-4 border-t-amber-500 shadow-2xl relative">
                    <button onclick="toggleModal('history-modal')" class="absolute top-4 right-4 text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-lg flex items-center gap-1 font-bold transition-colors border border-slate-200 z-10">
                        <span>ğŸ“Š</span> <span data-i18n="btn_history">æŸ¥çœ‹è´¦æœ¬</span>
                    </button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-black text-slate-800" id="ui-my-role-name">--</h2>
                        <div class="text-sm font-bold text-slate-500 mt-1" data-i18n="my_dash">ä½ çš„ä»“åº“ä¸è°ƒåº¦ä¸­å¿ƒ</div>
                    </div>

                    <div class="flex justify-center gap-6 mb-8">
                        <div id="inv-box" class="w-1/2 bg-slate-50 rounded-2xl border border-slate-200 flex flex-col overflow-hidden transition-colors">
                            <div class="p-6 text-center">
                                <div class="text-sm text-slate-500 font-bold mb-2" data-i18n="curr_inv">ğŸ“¦ å½“å‰å¯ç”¨åº“å­˜</div>
                                <div id="ui-my-inventory" class="text-7xl font-black text-slate-800">12</div>
                            </div>
                            <div class="bg-blue-100/50 py-2 text-center border-t border-blue-200">
                                <div class="text-xs text-blue-800 font-bold"><span data-i18n="cost_inv_label">ç»´æŒè´¹: {c}1.0/ä»¶</span> â” <span class="curr-symbol">Â¥</span><span id="ui-cost-inv">12.0</span></div>
                            </div>
                        </div>

                        <div id="backlog-box" class="w-1/2 bg-slate-50 rounded-2xl border border-slate-200 flex flex-col overflow-hidden transition-colors">
                            <div class="p-6 text-center">
                                <div class="text-sm text-slate-500 font-bold mb-2" data-i18n="curr_backlog">âš ï¸ ä¸¥é‡æ¬ å•</div>
                                <div id="ui-my-backlog" class="text-7xl font-black text-red-600">0</div>
                            </div>
                            <div class="bg-red-100/50 py-2 text-center border-t border-red-200">
                                <div class="text-xs text-red-800 font-bold"><span data-i18n="cost_backlog_label">è¿çº¦é‡‘: {c}2.0/ä»¶</span> â” <span class="curr-symbol">Â¥</span><span id="ui-cost-backlog">0.0</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-100 rounded-xl p-6 text-center border border-slate-200 shadow-inner max-w-md mx-auto">
                        <label class="block text-base font-bold text-slate-800 mb-4" data-i18n="order_prompt">å†³ç­–ï¼šæœ¬å‘¨å‘ä½ çš„ä¸Šæ¸¸è®¢è´­å¤šå°‘ï¼Ÿ</label>
                        <div class="flex gap-2">
                            <input type="number" id="ui-order-input" min="0" class="w-full text-center text-4xl font-black font-mono border-2 border-slate-300 rounded-xl focus:border-amber-500 focus:ring-0 outline-none p-2 text-slate-800 bg-white">
                            <button onclick="triggerTurnProcess()" class="bg-amber-600 hover:bg-amber-700 text-white font-black px-8 py-3 rounded-xl shadow-lg transition-transform active:scale-95 text-xl tracking-wide" data-i18n="btn_submit">
                                æäº¤
                            </button>
                        </div>
                        <div class="mt-3 text-xs text-slate-500 font-bold bg-white py-1 rounded border border-slate-200">
                            <span data-i18n="order_delay_note">â³ è®¢å•å»¶è¿Ÿ: 1å‘¨</span> | <span data-i18n="intransit_order">å½“å‰åœ¨é€”è®¢å•:</span> <span id="ui-intransit-order" class="text-amber-600">4</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¾®ä¿¡ç”©é”…èŠå¤©æ¡† -->
            <div class="w-full lg:w-80 flex flex-col h-[600px] lg:h-auto glass-card rounded-2xl border border-slate-200 shadow-2xl flex-shrink-0">
                <div class="bg-slate-800 text-white p-3 flex items-center justify-between rounded-t-2xl">
                    <div class="font-bold flex items-center gap-2"><span>ğŸ’¬</span> <span data-i18n="chat_title">ä¾›åº”é“¾å†…éƒ¨ç¾¤</span></div>
                    <span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full animate-pulse">Online</span>
                </div>
                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4 custom-scroll bg-slate-50/50">
                    <div class="text-center text-xs text-slate-400 mb-2" data-i18n="chat_sys_msg">â€”â€” æ¸¸æˆå¼€å§‹ï¼Œå¯åœ¨æ­¤ä¸ä¸Šä¸‹æ¸¸æ²Ÿé€š â€”â€”</div>
                </div>
                <div class="p-3 bg-white border-t border-slate-200 rounded-b-2xl flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow px-3 py-2 border border-slate-300 rounded-lg text-sm outline-none focus:border-amber-500" onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-black transition">Send</button>
                </div>
            </div>

        </div>

        <!-- ========================================== -->
        <!-- ç•Œé¢ 3: æœ€ç»ˆå¤ç›˜                           -->
        <!-- ========================================== -->
        <div id="screen-result" class="hidden slide-in space-y-6">
            <div id="pdf-content-wrapper" class="glass-card p-8 rounded-2xl shadow-2xl border border-slate-200">
                
                <div class="flex justify-between items-start mb-8 border-b border-slate-200 pb-6">
                    <div>
                        <h2 class="text-4xl font-black text-slate-900 mb-2 tracking-tight" data-i18n="result_title">æ¨¡æ‹Ÿç»“æŸï¼šå›šå¾’å›°å¢ƒä¸çœŸç›¸</h2>
                        <p class="text-slate-600 text-lg" data-i18n="result_desc">ä¸Šå¸è§†è§’å·²å¼€å¯ï¼Œæ¥çœ‹çœ‹å› ä¸ºå»¶è¿Ÿäº§ç”Ÿçš„ææ…Œï¼Œæ˜¯å¦‚ä½•æ‘§æ¯æ•´ä¸ªä¾›åº”é“¾çš„ã€‚</p>
                    </div>
                    <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center gap-2" id="btn-export">
                        <span>ğŸ“¥</span> <span data-i18n="btn_export">å¯¼å‡º PDF æŠ¥å‘Š</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <h3 class="text-lg font-black text-slate-800 mb-1" data-i18n="my_total_cost">ğŸ§‘â€ğŸ’¼ ä½ ä¸ªäººçš„æ€»æˆæœ¬</h3>
                        <div class="text-5xl font-black text-blue-600"><span class="curr-symbol">Â¥</span><span id="final-cost">0</span></div>
                        <div class="text-sm font-bold text-slate-500 mt-2"><span data-i18n="inv_cost_label">ä»“å‚¨:</span> <span class="curr-symbol">Â¥</span><span id="final-cost-inv">0</span> | <span data-i18n="backlog_cost_label">è¿çº¦:</span> <span class="curr-symbol">Â¥</span><span id="final-cost-backlog">0</span></div>
                    </div>
                    <div class="bg-red-50 p-6 rounded-2xl border border-red-200">
                        <h3 class="text-lg font-black text-red-900 mb-1" data-i18n="system_total_cost">ğŸŒ ä¾›åº”é“¾å…¨å±€æ€»æˆæœ¬</h3>
                        <div class="text-5xl font-black text-red-600"><span class="curr-symbol">Â¥</span><span id="final-system-cost">0</span></div>
                        <p class="text-xs font-bold text-red-800 mt-2" data-i18n="system_cost_desc">å¦‚æœä½ çš„æˆæœ¬å¾ˆä½ï¼Œä½†å…¨å±€æˆæœ¬æé«˜ï¼Œè¯´æ˜ä½ åœ¨ç©é›¶å’Œåšå¼ˆï¼šé€šè¿‡å›¤è´§å°†é£é™©è½¬å«ç»™äº†ä¸Šæ¸¸ï¼Œå¯¼è‡´ä¾›åº”é“¾ç ´äº§ã€‚</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm mb-8">
                    <div class="mb-4">
                        <h3 class="text-xl font-black text-slate-800" data-i18n="bullwhip_chart_title">ğŸ“ˆ ç‰›é­æ•ˆåº”æ£€æµ‹å›¾</h3>
                        <p class="text-sm text-slate-500" data-i18n="bullwhip_desc">å¯¹æ¯”â€œç»ˆç«¯éœ€æ±‚â€ï¼ˆè™šçº¿ï¼‰ä¸å„èŠ‚ç‚¹çš„â€œè®¢å•é‡â€ã€‚æ³¢å¹…è¢«æ”¾å¤§çš„å€æ•°å³ä¸ºç‰›é­æŒ‡æ•°ã€‚</p>
                    </div>
                    <div class="chart-container"><canvas id="bullwhipChart"></canvas></div>
                </div>

                <div class="bg-slate-800 p-6 rounded-2xl text-white shadow-xl">
                    <h3 class="text-lg font-black text-amber-400 mb-3" data-i18n="eval_title">ğŸ“‰ å¯¼å¸ˆå¤ç›˜ç‚¹è¯„ï¼š</h3>
                    <div class="text-sm leading-relaxed font-medium" id="variance-evaluation"></div>
                </div>

                <div id="pdf-history-table" class="hidden pt-8 border-t border-slate-200 mt-8">
                    <h3 class="text-2xl font-black text-slate-800 mb-4" data-i18n="history_title">åº“å­˜æµæ°´è´¦</h3>
                    <div id="pdf-history-content"></div>
                </div>
            </div>

            <div class="text-center pt-4 pb-8">
                <button onclick="location.reload()" class="bg-amber-600 hover:bg-amber-700 text-white font-black py-4 px-10 rounded-2xl shadow-xl hover:-translate-y-1 text-xl" data-i18n="btn_restart">
                    å†æ¥ä¸€å±€
                </button>
            </div>
        </div>

    </main>

    <!-- ========================================== -->
    <!-- æ¨¡æ€æ¡† (Modals)                            -->
    <!-- ========================================== -->

    <!-- è¿‡åœºåŠ¨ç”» Mask -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl text-center">
            <h3 class="text-3xl font-black mb-2 text-slate-800"><span data-i18n="processing">å¤„ç†ç¬¬</span> <span id="anim-week" class="text-amber-500"></span> <span data-i18n="week_suffix">å‘¨</span></h3>
            <p class="text-sm text-slate-500 mb-8 font-bold animate-pulse" data-i18n="anim_loading">è´§è½¦æ­£åœ¨è·¯ä¸Šï¼Œè®¢å•æ­£åœ¨ä¼ é€’...</p>
            <button id="btn-confirm-turn" class="hidden w-full bg-amber-600 hover:bg-amber-700 text-white font-black py-4 rounded-xl shadow-lg text-xl" onclick="finalizeTurn()" data-i18n="btn_confirm">
                ç¡®è®¤ï¼Œè¿›å…¥ä¸‹ä¸€å‘¨
            </button>
        </div>
    </div>

    <!-- è´¦æœ¬å¼¹çª— -->
    <div id="history-modal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[85vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-slate-50">
                <h3 class="text-2xl font-black text-slate-800 flex items-center gap-3"><span>ğŸ“Š</span> <span data-i18n="history_title">ä½ çš„è´¦æœ¬</span></h3>
                <button onclick="toggleModal('history-modal')" class="text-slate-400 hover:text-red-500 text-4xl font-black leading-none transition-colors">&times;</button>
            </div>
            <div class="p-0 overflow-y-auto custom-scroll flex-grow bg-white">
                <table class="w-full text-center" id="main-history-table"></table>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™æ‰‹å†Œå¼¹çª— -->
    <div id="rules-modal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-amber-50 text-amber-900">
                <h3 class="text-xl font-black flex items-center gap-2"><span>ğŸ“–</span> <span data-i18n="rules_title">æ¸¸æˆåŸºæœ¬è§„åˆ™</span></h3>
                <button onclick="toggleModal('rules-modal')" class="text-amber-700 hover:text-red-500 text-3xl font-black leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll flex-grow space-y-5 text-slate-700 text-sm leading-relaxed">
                <div>
                    <strong class="text-slate-900 text-base" data-i18n="rule_1_title">ğŸ¯ æ¸¸æˆç›®æ ‡</strong>
                    <p class="mt-1" data-i18n="rule_1_desc">åœ¨æ»¡è¶³ä¸‹æ¸¸éœ€æ±‚çš„å‰æä¸‹ï¼Œå°½é‡<strong>é™ä½ç³»ç»Ÿæ€»æˆæœ¬</strong>ã€‚ä½ åªèƒ½æ§åˆ¶è‡ªå·±èŠ‚ç‚¹å‘ä¸Šçš„è®¢è´§é‡ã€‚</p>
                </div>
                <div>
                    <strong class="text-slate-900 text-base" data-i18n="rule_2_title">ğŸ’° æˆæœ¬ç»“æ„</strong>
                    <ul class="list-disc pl-5 mt-1 space-y-1">
                        <li data-i18n="rule_2_1"><strong>ä»“å‚¨è´¹ï¼š</strong> æ¯ä»¶ç§¯å‹åœ¨åº“çš„å•†å“ï¼Œæ¯å‘¨æ‰£é™¤ {c}1.0ã€‚</li>
                        <li data-i18n="rule_2_2"><strong>ç¼ºè´§è¿çº¦é‡‘ï¼š</strong> å½“æ— æ³•æ»¡è¶³ä¸‹æ¸¸è®¢å•äº§ç”Ÿæ¬ å•æ—¶ï¼Œæ¯ä»¶æ¯å‘¨æ‰£é™¤ {c}2.0ã€‚ç¼ºè´§æƒ©ç½šæ¯”ç§¯å‹æ›´é‡ï¼</li>
                    </ul>
                </div>
                <div>
                    <strong class="text-slate-900 text-base" data-i18n="rule_3_title">â³ å‘¨æœŸä¸å»¶è¿Ÿ</strong>
                    <p class="mt-1" data-i18n="rule_3_desc">æ¸¸æˆæ€»è®¡è¿›è¡Œ <strong>26 å‘¨</strong> (åŠå¹´)ã€‚ä½ å‘å‡ºçš„è®¢å•éœ€è¦ <strong>1 å‘¨</strong> é€è¾¾ä¸Šæ¸¸ï¼›ä¸Šæ¸¸å‘å‡ºçš„å®ç‰©éœ€è¦ <strong>2 å‘¨</strong> ç‰©æµæ—¶é—´æ‰èƒ½åˆ°è¾¾ä½ çš„ä»“åº“ã€‚</p>
                </div>
                <div>
                    <strong class="text-slate-900 text-base" data-i18n="rule_4_title">ğŸ•¹ï¸ æ¯å‘¨è¡ŒåŠ¨</strong>
                    <p class="mt-1" data-i18n="rule_4_desc">1. æŸ¥æ”¶æœ¬å‘¨åˆ°è´§ä¸ä¸‹æ¸¸çš„æ–°è®¢å•ã€‚<br>2. ç•™æ„å±å¹•é¡¶éƒ¨çš„â€œå•†ä¸šå¤´æ¡â€æ–°é—»é¢„è­¦ã€‚<br>3. å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥åœ¨å³ä¾§â€œä¾›åº”é“¾å†…éƒ¨ç¾¤â€æ²Ÿé€šã€‚<br>4. åœ¨æ§åˆ¶å°è¾“å…¥æœ¬å‘¨æ¬²è®¢è´­çš„æ•°é‡ï¼Œç‚¹å‡»â€œæäº¤â€è¿›å…¥ä¸‹ä¸€å‘¨ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Info (å…³äº) å¼¹çª— -->
    <div id="info-modal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-slate-800 text-white">
                <h3 class="text-lg font-bold" data-i18n="info_title">å…³äºå•¤é…’æ¸¸æˆ</h3>
                <button onclick="toggleModal('info-modal')" class="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4 text-slate-300 text-sm">
                <p data-i18n="info_p1">æœ¬æ¸¸æˆæ˜¯å¯¹éº»çœç†å·¥å­¦é™¢ (MIT) æ–¯éš†å•†å­¦é™¢äº 1960 å¹´ä»£è®¾è®¡çš„ç»å…¸ä¾›åº”é“¾æ²™ç›˜â€œBeer Distribution Gameâ€çš„è‡´æ•¬ä¸ç°ä»£ç½‘é¡µç‰ˆæ”¹ç¼–ã€‚</p>
                <p data-i18n="info_p2">åˆ›æ„ä¸ä»£ç æ¡†æ¶ç”± Google Gemini äººå·¥æ™ºèƒ½è¾…åŠ©å®Œæˆæ„å»ºã€‚</p>
                <div class="bg-slate-800 p-4 rounded-lg mt-4 border border-slate-700">
                    <p class="text-xs text-slate-400 mb-1" data-i18n="info_contact">åé¦ˆæˆ–å»ºè®®è¯·è”ç³»ï¼š</p>
                    <p class="font-mono text-amber-400">usrex7746@gmail.com</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- I18N Engine ---
        const DICT = {
            zh: {
                app_title: "å•¤é…’æ¸¸æˆ", setup_title_new: "å•¤é…’æ¸¸æˆ", setup_desc: "ä½ èƒ½å¦åœ¨ä¿¡æ¯çš„è¿·é›¾ä¸å»¶è¿Ÿä¸­ï¼Œæ‰“ç ´ç‰›é­æ•ˆåº”çš„é­”å’’ï¼Ÿ",
                player: "ç©å®¶:", week: "å‘¨æ¬¡", char_name: "1. è§’è‰²åç§°ï¼š", story_bg: "2. æ•…äº‹èƒŒæ™¯ (å½±å“å­£èŠ‚èµ°åŠ¿)ï¼š", setup_step2: "3. é€‰æ‹©æ‰®æ¼”è§’è‰²ï¼š",
                bg_1: "å¯’å†¬å¼€å±€ (1æœˆ)", bg_4: "è¿æˆ˜å¤å­£æ—ºå­£ (4æœˆ)", bg_7: "æ—ºå­£å·…å³°å¼€å±€ (7æœˆ)", bg_10: "ç§‹å­£å¹³ç¨³å¼€å±€ (10æœˆ)",
                role_ret: "é›¶å”®å•†", role_who: "æ‰¹å‘å•†", role_dis: "åˆ†é”€å•†", role_fac: "å·¥å‚", role_con: "ç»ˆç«¯æ¶ˆè´¹è€…", role_sup: "å¤–éƒ¨ææ–™å•†",
                btn_start: "è¿›å…¥é…’é¦†å¼€å§‹æ¸¸æˆ", btn_confirm: "ç¡®è®¤ï¼Œè¿›å…¥ä¸‹ä¸€å‘¨",
                btn_rules: "æ¸¸æˆè§„åˆ™æ‰‹å†Œ", rules_title: "æ¸¸æˆåŸºæœ¬è§„åˆ™",
                rule_1_title: "ğŸ¯ æ¸¸æˆç›®æ ‡", rule_1_desc: "åœ¨æ»¡è¶³ä¸‹æ¸¸éœ€æ±‚çš„å‰æä¸‹ï¼Œå°½é‡<strong>é™ä½ç³»ç»Ÿæ€»æˆæœ¬</strong>ã€‚ä½ åªèƒ½æ§åˆ¶è‡ªå·±èŠ‚ç‚¹å‘ä¸Šçš„è®¢è´§é‡ã€‚",
                rule_2_title: "ğŸ’° æˆæœ¬ç»“æ„", rule_2_1: "<strong>ä»“å‚¨è´¹ï¼š</strong> æ¯ä»¶ç§¯å‹åœ¨åº“çš„å•†å“ï¼Œæ¯å‘¨æ‰£é™¤ {c}1.0ã€‚", rule_2_2: "<strong>ç¼ºè´§è¿çº¦é‡‘ï¼š</strong> å½“æ— æ³•æ»¡è¶³ä¸‹æ¸¸è®¢å•äº§ç”Ÿæ¬ å•æ—¶ï¼Œæ¯ä»¶æ¯å‘¨æ‰£é™¤ {c}2.0ã€‚ç¼ºè´§æƒ©ç½šæ¯”ç§¯å‹æ›´é‡ï¼",
                rule_3_title: "â³ å‘¨æœŸä¸å»¶è¿Ÿ", rule_3_desc: "æ¸¸æˆæ€»è®¡è¿›è¡Œ <strong>26 å‘¨</strong> (åŠå¹´)ã€‚ä½ å‘å‡ºçš„è®¢å•éœ€è¦ <strong>1 å‘¨</strong> é€è¾¾ä¸Šæ¸¸ï¼›ä¸Šæ¸¸å‘å‡ºçš„å®ç‰©éœ€è¦ <strong>2 å‘¨</strong> ç‰©æµæ—¶é—´æ‰èƒ½åˆ°è¾¾ä½ çš„ä»“åº“ã€‚",
                rule_4_title: "ğŸ•¹ï¸ æ¯å‘¨è¡ŒåŠ¨", rule_4_desc: "1. æŸ¥æ”¶æœ¬å‘¨åˆ°è´§ä¸ä¸‹æ¸¸çš„æ–°è®¢å•ã€‚<br>2. ç•™æ„å±å¹•é¡¶éƒ¨çš„â€œå•†ä¸šå¤´æ¡â€æ–°é—»é¢„è­¦ã€‚<br>3. å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥åœ¨å³ä¾§â€œä¾›åº”é“¾å†…éƒ¨ç¾¤â€æ²Ÿé€šã€‚<br>4. åœ¨æ§åˆ¶å°è¾“å…¥æœ¬å‘¨æ¬²è®¢è´­çš„æ•°é‡ï¼Œç‚¹å‡»â€œæäº¤â€è¿›å…¥ä¸‹ä¸€å‘¨ã€‚",
                info_title: "å…³äºå•¤é…’æ¸¸æˆ", info_p1: "æœ¬æ¸¸æˆæ˜¯å¯¹éº»çœç†å·¥å­¦é™¢ (MIT) æ–¯éš†å•†å­¦é™¢äº 1960 å¹´ä»£è®¾è®¡çš„ç»å…¸ä¾›åº”é“¾æ²™ç›˜â€œBeer Distribution Gameâ€çš„è‡´æ•¬ä¸ç°ä»£ç½‘é¡µç‰ˆæ”¹ç¼–ã€‚", info_p2: "åˆ›æ„ä¸ä»£ç æ¡†æ¶ç”± Google Gemini äººå·¥æ™ºèƒ½è¾…åŠ©å®Œæˆæ„å»ºã€‚", info_contact: "åé¦ˆæˆ–å»ºè®®è¯·è”ç³»ï¼š",
                ai_note_title: "AI é˜Ÿå‹å·²å‡†å¤‡å°±ç»ªï¼š", ai_note_desc: "ç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åˆ†é… 3 ä½æ€§æ ¼å„å¼‚çš„ AI é˜Ÿå‹ï¼ˆæ€¥èºã€è¿Ÿé’æˆ–ç†æ€§ï¼‰ã€‚è¯·æ³¨æ„ï¼Œç†æ€§é˜Ÿå‹è‡³å¤šåªæœ‰ 1 ä½ã€‚çœŸå®çš„ä¾›åº”é“¾ä¸­ï¼Œä½ æ°¸è¿œä¸çŸ¥é“ä½ çš„ä¸Šä¸‹æ¸¸åœ¨æƒ³ä»€ä¹ˆã€‚",
                upstream: "æˆ‘çš„ä¸Šæ¸¸", transit_title: "åœ¨é€”å°†åˆ°è¾¾", transit_1: "ä»¶", transit_2: "ä¸¤å‘¨å:",
                my_dash: "ä½ çš„ä»“åº“ä¸è°ƒåº¦ä¸­å¿ƒ", current_role: "å½“å‰æ‰®æ¼”", btn_history: "æŸ¥çœ‹è´¦æœ¬", curr_inv: "ğŸ“¦ å½“å‰å¯ç”¨åº“å­˜", curr_backlog: "âš ï¸ ä¸¥é‡æ¬ å•",
                cost_inv_label: "ç»´æŒè´¹: {c}1.0/ä»¶", cost_backlog_label: "è¿çº¦é‡‘: {c}2.0/ä»¶", last_cost: "ä¸Šå‘¨äº§ç”Ÿçš„æ€»ç»´æŒæˆæœ¬:",
                order_prompt: "å†³ç­–ï¼šæœ¬å‘¨å‘ä½ çš„ä¸Šæ¸¸è®¢è´­å¤šå°‘ï¼Ÿ", btn_submit: "æäº¤", order_delay_note: "â³ è®¢å•å»¶è¿Ÿ: 1å‘¨", intransit_order: "å½“å‰åœ¨é€”è®¢å•:",
                downstream: "æˆ‘çš„ä¸‹æ¸¸ (éœ€æ±‚æ–¹)", incoming_order: "æ”¶åˆ°æ–°è®¢å•", result_title: "æ¨¡æ‹Ÿç»“æŸï¼šå›šå¾’å›°å¢ƒä¸çœŸç›¸", result_desc: "ä¸Šå¸è§†è§’å·²å¼€å¯ï¼Œæ¥çœ‹çœ‹å› ä¸ºå»¶è¿Ÿäº§ç”Ÿçš„ææ…Œï¼Œæ˜¯å¦‚ä½•æ‘§æ¯æ•´ä¸ªä¾›åº”é“¾çš„ã€‚",
                btn_export: "å¯¼å‡º PDF æŠ¥å‘Š", my_total_cost: "ğŸ§‘â€ğŸ’¼ ä½ ä¸ªäººçš„æ€»æˆæœ¬", system_total_cost: "ğŸŒ ä¾›åº”é“¾å…¨å±€æ€»æˆæœ¬",
                system_cost_desc: "å¦‚æœä½ çš„æˆæœ¬å¾ˆä½ï¼Œä½†å…¨å±€æˆæœ¬æé«˜ï¼Œè¯´æ˜ä½ åœ¨ç©é›¶å’Œåšå¼ˆï¼šé€šè¿‡å›¤è´§å°†é£é™©è½¬å«ç»™äº†ä¸Šæ¸¸ï¼Œå¯¼è‡´ä¾›åº”é“¾ç ´äº§ã€‚",
                inv_cost_label: "ä»“å‚¨:", backlog_cost_label: "è¿çº¦:",
                bullwhip_chart_title: "ğŸ“ˆ ç‰›é­æ•ˆåº”æ£€æµ‹å›¾", bullwhip_desc: "å¯¹æ¯”â€œç»ˆç«¯éœ€æ±‚â€ï¼ˆè™šçº¿ï¼‰ä¸å„èŠ‚ç‚¹çš„â€œè®¢å•é‡â€ã€‚æ³¢å¹…è¢«æ”¾å¤§çš„å€æ•°å³ä¸ºç‰›é­æŒ‡æ•°ã€‚", history_title: "ä½ çš„è´¦æœ¬", btn_restart: "å†æ¥ä¸€å±€",
                processing: "å¤„ç†ç¬¬", week_suffix: "å‘¨", anim_loading: "è´§è½¦æ­£åœ¨è·¯ä¸Šï¼Œè®¢å•æ­£åœ¨ä¼ é€’...", anim_receive: "å…¥åº“ (æ”¶è´§)", anim_ship: "å‡ºåº“ (å‘è´§)", anim_order: "å‘å‡ºè®¢å•",
                table_w: "å‘¨æ¬¡", table_start: "æœŸåˆ", table_in: "+å…¥åº“", table_out: "-å‘è´§", table_end: "æœŸæœ«", table_backlog: "æ¬ å•", table_order: "å‘å•", table_cost: "æˆæœ¬",
                eval_title: "ğŸ“‰ å¯¼å¸ˆå¤ç›˜ç‚¹è¯„ï¼š", eval_prefix: "è¯„ä»·ï¼š", summary_prefix: "å…¨é“¾è·¯æ€»ç»“ï¼š",
                eval_p1: "<strong class='text-red-400 block mb-2 text-xl'>å›šå¾’å›°å¢ƒä¸å†…å·çš„ä»£ä»·</strong><p class='mb-2'>ä½ åœ¨æ¸¸æˆä¸­çœ‹åˆ°äº†çœŸå®çš„å­£èŠ‚æ€§æ³¢åŠ¨ã€‚ç»ˆç«¯éœ€æ±‚å…¶å®åªåœ¨å°èŒƒå›´æ³¢åŠ¨ï¼ˆæ–¹å·® {dvar}ï¼‰ï¼Œä½†ç”±äºä¿¡æ¯ä¸é€æ˜ï¼Œä½ ä»¬äº’ç›¸ææ…ŒçŒœç–‘ã€‚</p>",
                eval_p2: "<p class='mb-2'>å…¨é“¾è·¯ä¸­ï¼Œ<strong>{mrole}</strong> ç–¯å¾—æœ€å‰å®³ï¼Œè®¢å•æ³¢åŠ¨æ”¾å¤§äº† <strong>{ratio}å€</strong>ã€‚</p>",
                eval_p3: "<p class='text-amber-400 font-bold'>å¦‚æœä½ è§‰å¾—ä½ çš„ä¸ªäººæˆæœ¬å¾ˆä½ï¼Œè¯·çœ‹å³ä¸Šè§’çš„â€œå…¨å±€æ€»æˆæœ¬â€ï¼šé‚£æ˜¯ä½ çš„é˜Ÿå‹ä»¬å› ä¸ºä½ çš„ææ…Œè¶…è®¢ï¼Œæˆ–è€…ä½ çš„è¿Ÿé’æ–­ä¾›ï¼Œè€Œä»˜å‡ºçš„è¡€çš„ä»£ä»·ã€‚åœ¨çœŸå®çš„å•†ä¸šä¸–ç•Œé‡Œï¼Œä»–ä»¬ç ´äº§äº†ï¼Œä½ æ˜å¹´ä¹Ÿå¾—æ­»ã€‚è¿™å°±æ˜¯è‘—åçš„â€œç‰›é­æ•ˆåº”â€ä¸çº³ä»€å‡è¡¡é™·é˜±ã€‚</p>",
                news_title: "å•†ä¸šå¤´æ¡ï¼š", evt_sport_prep: "å¬è¯´è¿‘æœŸå°†æœ‰å¤§å‹èµ›äº‹ä¸¾åŠï¼Œä¹Ÿè®¸ä¼šå¸¦åŠ¨æ¶ˆè´¹æ°›å›´ã€‚", evt_sport: "èµ›äº‹ç«çƒ­è¿›è¡Œä¸­ï¼Œéœ€æ±‚å‡ºç°æ˜æ˜¾ä¸Šæ¶¨ï¼",
                evt_weather_prep: "æ°”è±¡å°å‘å¸ƒç½•è§å¯’æ½®é¢„è­¦ï¼Œæ³¨æ„é˜²èŒƒã€‚", evt_weather: "å¯’æ½®æ¥è¢­ï¼Œæ¶ˆè´¹è€…å¤§å¹…å‡å°‘å¤–å‡ºã€‚",
                evt_normal: "å¤©æ°”å›æš–ï¼ŒåŸå¸‚æ¢å¤å¾€å¸¸è¿ä½œã€‚", evt_promo_prep: "å¹´åº¦è´­ç‰©ç‹‚æ¬¢èŠ‚å³å°†å¼€å¯ï¼Œå•†å®¶å¼€å§‹å¤‡è´§ã€‚", evt_promo: "ç‹‚æ¬¢èŠ‚å¼•çˆ†ï¼Œéœ€æ±‚å‰§å¢ï¼",
                chat_title: "ä¾›åº”é“¾å†…éƒ¨ç¾¤", chat_sys_msg: "â€”â€” æ¸¸æˆå¼€å§‹ï¼Œå¯åœ¨æ­¤ä¸ä¸Šä¸‹æ¸¸æ²Ÿé€š â€”â€”", chat_me: "æˆ‘", chat_sys: "ç³»ç»Ÿ/é˜Ÿå‹",
                chat_r1: "å¤§å®¶éƒ½åœ¨å¿™ç€ç†è´§ï¼Œæ²¡äººæœ‰ç©ºç†ä½ ã€‚", chat_r2: "[{up}] å…„å¼Ÿåˆ«å‚¬äº†ï¼ä½ ä¸Šå‘¨çªç„¶è¦é‚£ä¹ˆå¤šï¼Œæˆ‘è¿™é‡Œå…¨ç©ºäº†ï¼ä¸Šæ¸¸æ ¹æœ¬ä¸å‘è´§ï¼", chat_r3: "[{up}] å·²ç»åœ¨è·¯ä¸Šäº†ï¼Œç‰©æµéœ€è¦2å‘¨ï¼Œåˆ«çå«å”¤ï¼", chat_r4: "[{down}] å“¥ä»¬ï¼Œç»ˆç«¯æ ¹æœ¬æ²¡éœ€æ±‚å•Šï¼Œåˆ«é€¼æˆ‘è¿›è´§äº†ï¼Œæˆ‘å¿«ç ´äº§äº†ï¼", chat_r5: "ç³»ç»Ÿè‡ªåŠ¨å›å¤ï¼šè¯·æ ¹æ®æ•°æ®ç†æ€§å†³ç­–ï¼Œæ‹’ç»ææ…Œã€‚"
            },
            en: {
                app_title: "The Beer Game", setup_title_new: "The Beer Game", setup_desc: "Can you break the curse of the Bullwhip Effect in the fog of information delay?",
                player: "Player:", week: "Week", char_name: "1. Character Name:", story_bg: "2. Story Background (Seasonality):", setup_step2: "3. Select Role:",
                bg_1: "Winter Start (Jan)", bg_4: "Pre-Summer Start (Apr)", bg_7: "Peak Summer Start (Jul)", bg_10: "Autumn Start (Oct)",
                role_ret: "Retailer", role_who: "Wholesaler", role_dis: "Distributor", role_fac: "Factory", role_con: "Consumer", role_sup: "Supplier",
                btn_start: "Enter Tavern & Start", btn_confirm: "Confirm & Next Week",
                btn_rules: "Rulebook", rules_title: "Basic Rules",
                rule_1_title: "ğŸ¯ Goal", rule_1_desc: "Minimize <strong>Total System Cost</strong> while fulfilling downstream demand. You only control orders to your upstream.",
                rule_2_title: "ğŸ’° Cost Structure", rule_2_1: "<strong>Holding Cost:</strong> {c}1.0 per unit of inventory left at the end of the week.", rule_2_2: "<strong>Backlog Cost:</strong> {c}2.0 per unit of unfilled order. Stockouts punish harder than overstocking!",
                rule_3_title: "â³ Delays", rule_3_desc: "Game lasts <strong>26 weeks</strong>. Orders take <strong>1 week</strong> to reach upstream. Shipments take <strong>2 weeks</strong> to reach your warehouse.",
                rule_4_title: "ğŸ•¹ï¸ Actions", rule_4_desc: "1. Check incoming shipments and orders.<br>2. Watch the News Ticker.<br>3. Chat with partners if needed.<br>4. Submit your order quantity to proceed.",
                info_title: "About The Beer Game", info_p1: "A modern web adaptation of the classic Beer Distribution Game created by MIT Sloan School of Management in the 1960s.", info_p2: "Conceptualized and coded with the assistance of Google Gemini AI.", info_contact: "Feedback or suggestions:",
                ai_note_title: "AI Teammates Ready:", ai_note_desc: "The system has randomly assigned personalities (Aggressive, Sluggish, or Rational) to your 3 AI partners. Note: Max 1 Rational AI. In a real supply chain, you never truly know what your partners are thinking.",
                upstream: "My Upstream", transit_title: "Arriving Soon", transit_1: "units", transit_2: "In 2 Wks:",
                my_dash: "Warehouse & Control", current_role: "Playing As", btn_history: "Ledger", curr_inv: "ğŸ“¦ Available Inventory", curr_backlog: "âš ï¸ Severe Backlog",
                cost_inv_label: "Holding: {c}1.0/u", cost_backlog_label: "Backlog: {c}2.0/u", last_cost: "Last Week Total Cost:",
                order_prompt: "Decision: Order amount to upstream?", btn_submit: "Submit", order_delay_note: "â³ Order Delay: 1 Wk", intransit_order: "In-Transit Orders:",
                downstream: "My Downstream", incoming_order: "New Incoming Order", result_title: "Debrief: The Prisoner's Dilemma", result_desc: "God-mode unlocked. See how panic destroyed the supply chain.",
                btn_export: "Export PDF", my_total_cost: "ğŸ§‘â€ğŸ’¼ Your Personal Cost", system_total_cost: "ğŸŒ Total System Cost",
                system_cost_desc: "If your cost is low but system cost is huge, you played a zero-sum game: hoarding transferred the risk upstream, bankrupting the chain.",
                inv_cost_label: "Hold:", backlog_cost_label: "Back:",
                bullwhip_chart_title: "ğŸ“ˆ Bullwhip Effect Chart", bullwhip_desc: "Compare end demand (dashed) vs orders. Amplification ratio = Bullwhip Index.", history_title: "Your Ledger", btn_restart: "Play Again",
                processing: "Processing Wk", week_suffix: "", anim_loading: "Trucks on the road, orders transmitting...", anim_receive: "Received", anim_ship: "Shipped", anim_order: "Order Placed",
                table_w: "Wk", table_start: "Start", table_in: "+In", table_out: "-Out", table_end: "End", table_backlog: "Backlog", table_order: "Order", table_cost: "Cost",
                eval_title: "ğŸ“‰ Mentor's Debrief:", eval_prefix: "Evaluation: ", summary_prefix: "Chain Summary: ",
                eval_p1: "<strong class='text-red-400 block mb-2 text-xl'>Prisoner's Dilemma & The Cost of Panic</strong><p class='mb-2'>You saw real seasonal fluctuations. End demand varied slightly (Variance {dvar}), but opacity led to mutual suspicion.</p>",
                eval_p2: "<p class='mb-2'>Across the chain, <strong>{mrole}</strong> panicked the most, amplifying demand by <strong>{ratio}x</strong>.</p>",
                eval_p3: "<p class='text-amber-400 font-bold'>If you think your personal cost is low, look at the System Cost. That's the blood price your partners paid for your panic over-ordering or sluggish supply. In the real world, they go bankrupt, and next year, you die too. This is the Bullwhip Effect and Nash Equilibrium.</p>",
                news_title: "Headline:", evt_sport_prep: "Rumors of a big sports event upcoming. Might boost sales.", evt_sport: "Sports event ongoing, demand is surging!",
                evt_weather_prep: "Meteorologists issue a rare cold wave warning.", evt_weather: "Cold wave hits, consumers stay home.",
                evt_normal: "Weather warms up, city returns to normal.", evt_promo_prep: "Annual shopping festival approaches, merchants stocking up.", evt_promo: "Shopping festival explodes, massive demand!",
                chat_title: "Supply Chain Group", chat_sys_msg: "â€”â€” Game started. Chat with partners here â€”â€”", chat_me: "Me", chat_sys: "System/Partner",
                chat_r1: "Everyone is busy managing inventory. No time to chat.", chat_r2: "[{up}] Stop rushing me! You ordered a ton last week, I'm empty! Upstream isn't shipping!", chat_r3: "[{up}] It's on the way. Logistics takes 2 weeks, chill out!", chat_r4: "[{down}] Bro, there's no end demand. Stop forcing me to take stock, I'm going bankrupt!", chat_r5: "System Auto-Reply: Please make rational decisions based on data. Refuse panic."
            },
            es: {
                app_title: "Juego de la Cerveza", setup_title_new: "Juego de la Cerveza", setup_desc: "Â¿PodrÃ¡s romper la maldiciÃ³n del Efecto LÃ¡tigo en la niebla del retraso?",
                player: "Jugador:", week: "Semana", char_name: "1. Nombre del Personaje:", story_bg: "2. Fondo (Estacionalidad):", setup_step2: "3. Selecciona Rol:",
                bg_1: "Inicio Invierno (Ene)", bg_4: "Pre-Verano (Abr)", bg_7: "Pico Verano (Jul)", bg_10: "Inicio OtoÃ±o (Oct)",
                role_ret: "Minorista", role_who: "Mayorista", role_dis: "Distribuidor", role_fac: "FÃ¡brica", role_con: "Consumidor", role_sup: "Proveedor",
                btn_start: "Entrar a la Taberna", btn_confirm: "Confirmar y Siguiente",
                btn_rules: "Reglas", rules_title: "Reglas BÃ¡sicas",
                rule_1_title: "ğŸ¯ Objetivo", rule_1_desc: "Minimiza el <strong>Costo Total del Sistema</strong>. Solo controlas tus pedidos hacia arriba.",
                rule_2_title: "ğŸ’° Costos", rule_2_1: "<strong>Almacenaje:</strong> {c}1.0 por unidad guardada.", rule_2_2: "<strong>Pendientes (Falta):</strong> {c}2.0 por unidad no entregada. Â¡La falta castiga mÃ¡s!",
                rule_3_title: "â³ Retrasos", rule_3_desc: "El juego dura <strong>26 semanas</strong>. Pedidos tardan <strong>1 semana</strong> en llegar. EnvÃ­os tardan <strong>2 semanas</strong> en llegar a ti.",
                rule_4_title: "ğŸ•¹ï¸ Acciones", rule_4_desc: "1. Revisa inventario y pedidos.<br>2. Lee las Noticias.<br>3. Chatea si es necesario.<br>4. EnvÃ­a tu pedido.",
                info_title: "Sobre el Juego", info_p1: "AdaptaciÃ³n web moderna del clÃ¡sico Beer Distribution Game del MIT Sloan (1960s).", info_p2: "Conceptualizado y programado con asistencia de Google Gemini AI.", info_contact: "Comentarios o sugerencias:",
                ai_note_title: "CompaÃ±eros IA Listos:", ai_note_desc: "El sistema asignÃ³ personalidades aleatorias (Agresivo, Lento, Racional) a los 3 IA. Nota: MÃ¡x 1 Racional. En la realidad, nunca sabes quÃ© piensan tus socios.",
                upstream: "Mi Proveedor", transit_title: "Llegando Pronto", transit_1: "unid.", transit_2: "En 2 Sem:",
                my_dash: "AlmacÃ©n y Control", current_role: "Jugando como", btn_history: "Libro", curr_inv: "ğŸ“¦ Inventario Disponible", curr_backlog: "âš ï¸ Falta Severa",
                cost_inv_label: "AlmacÃ©n: {c}1.0/u", cost_backlog_label: "Falta: {c}2.0/u", last_cost: "Costo Total Sem. Pasada:",
                order_prompt: "DecisiÃ³n: Â¿CuÃ¡nto pedir arriba?", btn_submit: "Enviar", order_delay_note: "â³ Retraso: 1 Sem", intransit_order: "Pedidos en trÃ¡nsito:",
                downstream: "Mi Demanda", incoming_order: "Nuevo Pedido", result_title: "AnÃ¡lisis: Dilema del Prisionero", result_desc: "Modo Dios. Mira cÃ³mo el pÃ¡nico destruyÃ³ la cadena.",
                btn_export: "Exportar PDF", my_total_cost: "ğŸ§‘â€ğŸ’¼ Tu Costo Personal", system_total_cost: "ğŸŒ Costo Total del Sistema",
                system_cost_desc: "Si tu costo es bajo pero el del sistema es alto, jugaste un juego de suma cero: pasaste el riesgo, quebrando la cadena.",
                inv_cost_label: "Alm:", backlog_cost_label: "Falta:",
                bullwhip_chart_title: "ğŸ“ˆ Efecto LÃ¡tigo", bullwhip_desc: "Compara demanda final (lÃ­nea) vs pedidos. AmplificaciÃ³n = Ãndice LÃ¡tigo.", history_title: "Tu Libro", btn_restart: "Jugar de Nuevo",
                processing: "Proc. Sem", week_suffix: "", anim_loading: "Camiones en ruta, pedidos en camino...", anim_receive: "Recibido", anim_ship: "Enviado", anim_order: "Pedido Enviado",
                table_w: "Sem", table_start: "Inicio", table_in: "+Entra", table_out: "-Sale", table_end: "Final", table_backlog: "Falta", table_order: "Pedido", table_cost: "Costo",
                eval_title: "ğŸ“‰ AnÃ¡lisis del Mentor:", eval_prefix: "EvaluaciÃ³n: ", summary_prefix: "Resumen: ",
                eval_p1: "<strong class='text-red-400 block mb-2 text-xl'>Dilema del Prisionero</strong><p class='mb-2'>Viste fluctuaciones reales. La demanda variÃ³ poco (Varianza {dvar}), pero la opacidad causÃ³ pÃ¡nico mutuo.</p>",
                eval_p2: "<p class='mb-2'>En la cadena, <strong>{mrole}</strong> entrÃ³ en mÃ¡s pÃ¡nico, amplificando demanda <strong>{ratio}x</strong>.</p>",
                eval_p3: "<p class='text-amber-400 font-bold'>Si crees que tu costo es bajo, mira el Costo del Sistema. Es el precio de sangre que pagaron tus socios por tu pÃ¡nico. En la realidad, quiebran, y el prÃ³ximo aÃ±o, tÃº tambiÃ©n. Esto es el Efecto LÃ¡tigo y el Equilibrio de Nash.</p>",
                news_title: "Titular:", evt_sport_prep: "Rumores de un gran evento deportivo. PodrÃ­a subir ventas.", evt_sport: "Evento activo, Â¡la demanda aumenta!",
                evt_weather_prep: "Alerta de ola de frÃ­o severa.", evt_weather: "Ola de frÃ­o, consumidores en casa.",
                evt_normal: "El clima mejora, la ciudad vuelve a la normalidad.", evt_promo_prep: "Festival de compras se acerca, comercios se preparan.", evt_promo: "Â¡Festival explota, demanda masiva!",
                chat_title: "Grupo Cadena Suministro", chat_sys_msg: "â€”â€” Juego iniciado. Chatea aquÃ­ â€”â€”", chat_me: "Yo", chat_sys: "Sistema/Socio",
                chat_r1: "Todos estÃ¡n ocupados. No hay tiempo para chatear.", chat_r2: "[{up}] Â¡No me presiones! Â¡Pediste mucho la semana pasada, estoy vacÃ­o! Â¡Arriba no envÃ­an!", chat_r3: "[{up}] EstÃ¡ en camino. Tarda 2 semanas, Â¡cÃ¡lmate!", chat_r4: "[{down}] Amigo, no hay demanda. Â¡No me obligues a recibir, voy a quebrar!", chat_r5: "Respuesta del Sistema: Toma decisiones racionales con datos. Rechaza el pÃ¡nico."
            }
        };

        let currentLang = 'zh';
        function c() { return { zh: 'Â¥', en: '$', es: 'â‚¬' }[currentLang]; }
        function t(key) { return DICT[currentLang][key] || key; }

        function setLanguage(lang, flag) {
            currentLang = lang;
            document.getElementById('current-flag').innerText = flag;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                let key = el.getAttribute('data-i18n');
                let translated = t(key).replace(/{c}/g, c());
                if (el.tagName === 'INPUT' && el.type === 'text') { el.placeholder = translated; } else { el.innerHTML = translated; }
            });
            document.querySelectorAll('.curr-symbol').forEach(el => el.innerText = c());
            
            const select = document.getElementById('input-start-month');
            const val = select.value;
            select.options[0].text = t('bg_1'); select.options[1].text = t('bg_4');
            select.options[2].text = t('bg_7'); select.options[3].text = t('bg_10');
            select.value = val;

            renderRoleSelector();
            document.getElementById('lang-dropdown').classList.remove('active');
        }

        // --- Modals & Dropdowns ---
        function toggleDropdown(e, id) { e.stopPropagation(); document.getElementById(id).classList.toggle('active'); }
        function closeDropdowns(e) { if(!e.target.closest('.relative')) { document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active')); } }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        // --- éŸ³æ•ˆå¼•æ“ ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol=0.1) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            let osc = audioCtx.createOscillator(); let gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        function playClick() { playTone(600, 'sine', 0.1, 0.05); }
        function playError() { playTone(150, 'sawtooth', 0.4, 0.1); }
        function playClink() { playTone(1200, 'sine', 0.5, 0.1); setTimeout(()=>playTone(1400, 'sine', 0.5, 0.1), 50); }

        // --- æ ¸å¿ƒé…ç½® ---
        const CONFIG = { maxWeeks: 26, costInv: 1.0, costBacklog: 2.0, initialInv: 12, initialOrder: 4, roles: ['retailer', 'wholesaler', 'distributor', 'factory'] };
        const MONTHLY_BASE = { 1:3, 2:3, 3:4, 4:5, 5:6, 6:8, 7:12, 8:10, 9:6, 10:4, 11:3, 12:4 };
        const EVENTS = [
            { start: 4, end: 4, effect: 0, key: "evt_sport_prep" }, { start: 5, end: 10, effect: 4, key: "evt_sport" },
            { start: 17, end: 17, effect: 0, key: "evt_weather_prep" }, { start: 18, end: 19, effect: -2, key: "evt_weather" },
            { start: 20, end: 20, effect: 0, key: "evt_normal" }, { start: 22, end: 22, effect: 0, key: "evt_promo_prep" },
            { start: 23, end: 24, effect: 8, key: "evt_promo" }
        ];

        let state = {
            playerName: '', userRole: 'retailer', aiSettings: {}, week: 1, startMonth: 1,
            myTotalCost: 0, myTotalInvCost: 0, myTotalBacklogCost: 0, lastWeekCost: 0, systemTotalCost: 0,
            nodes: {}, myHistoryLog: [], 
            chartData: { labels: [], demand: [], orders: { retailer: [], wholesaler: [], distributor: [], factory: [] } },
            tempTurnData: null, currentEventKey: null 
        };

        function getRoleName(r) { return t('role_' + r.substring(0,3)); }

        window.onload = function() { setLanguage('zh', 'ğŸ‡¨ğŸ‡³'); };

        function renderRoleSelector() {
            const icons = ['ğŸª', 'ğŸ¢', 'ğŸš›', 'ğŸ­'];
            document.querySelectorAll('input[name="role"]').forEach((r, i) => {
                r.nextElementSibling.querySelector('div:last-child').innerText = getRoleName(r.value);
            });
        }
        function updateSelectedRole(val) { state.userRole = val; }

        function assignRandomAI() {
            let roles = CONFIG.roles.filter(r => r !== state.userRole);
            let assigned = {}; let rationalCount = 0;
            roles.forEach(role => {
                let avail = rationalCount >= 1 ? ['aggressive', 'sluggish'] : ['aggressive', 'sluggish', 'rational'];
                let chosen = avail[Math.floor(Math.random() * avail.length)];
                if (chosen === 'rational') rationalCount++;
                assigned[role] = chosen;
            });
            state.aiSettings = assigned;
        }

        function startIntroAnimation() {
            const nameInput = document.getElementById('input-player-name').value.trim();
            if (!nameInput) { alert("Please enter your name!"); return; }
            state.playerName = nameInput;
            state.userRole = document.querySelector('input[name="role"]:checked').value;
            state.startMonth = parseInt(document.getElementById('input-start-month').value);
            
            assignRandomAI();

            // å½»åº•éšè—è¯­è¨€åˆ‡æ¢æŒ‰é’® (è¿›å…¥æ¸¸æˆåé”å®š)
            document.getElementById('lang-wrapper').classList.add('hidden');

            document.getElementById('screen-setup').classList.add('hidden');
            const intro = document.getElementById('screen-intro');
            const cdText = document.getElementById('countdown-text');
            const clink = document.getElementById('clink-emoji');
            intro.classList.remove('hidden');
            
            if(audioCtx.state === 'suspended') audioCtx.resume();
            let cnt = 3; cdText.innerText = cnt; playClick();
            let iv = setInterval(() => {
                cnt--;
                if (cnt > 0) { cdText.innerText = cnt; playClick(); } 
                else if (cnt === 0) {
                    clearInterval(iv); cdText.classList.add('hidden');
                    clink.classList.remove('hidden'); clink.classList.add('animate-clink');
                    playClink();
                    setTimeout(() => { intro.classList.add('hidden'); initGameEngine(); }, 1200);
                }
            }, 800);
        }

        function initGameEngine() {
            CONFIG.roles.forEach(role => {
                state.nodes[role] = { inv: CONFIG.initialInv, backlog: 0, incomingShipmentQueue: [CONFIG.initialOrder, CONFIG.initialOrder], incomingOrderQueue: [CONFIG.initialOrder], lastOrderPlaced: CONFIG.initialOrder, inTransitOrderVisible: CONFIG.initialOrder };
            });
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('header-status').classList.remove('hidden');
            document.getElementById('header-status').classList.add('flex');
            document.getElementById('ui-player-name').innerText = state.playerName;
            setupDashboardLabels(); updateDashboardUI();
        }

        function getDemandForWeek(week) {
            let m = state.startMonth + Math.floor((week - 1) / 4);
            if (m > 12) m = m % 12 || 12;
            let d = MONTHLY_BASE[m] + (Math.floor(Math.random() * 3) - 1);
            let evt = EVENTS.find(e => week >= e.start && week <= e.end);
            if (evt) d += evt.effect;
            return Math.max(0, d);
        }

        function setupDashboardLabels() {
            document.getElementById('ui-my-role-name').innerText = getRoleName(state.userRole);
            let idx = CONFIG.roles.indexOf(state.userRole);
            document.getElementById('ui-downstream-name').innerText = idx === 0 ? t('role_con') : getRoleName(CONFIG.roles[idx-1]);
            document.getElementById('ui-upstream-name').innerText = idx === CONFIG.roles.length - 1 ? t('role_sup') : getRoleName(CONFIG.roles[idx+1]);
        }

        function updateDashboardUI() {
            document.getElementById('ui-week-counter').innerText = state.week;
            
            const banner = document.getElementById('event-banner');
            let evt = EVENTS.find(e => state.week >= e.start && state.week <= e.end);
            if (evt) {
                if (state.currentEventKey !== evt.key) {
                    document.getElementById('event-desc').innerText = t(evt.key);
                    banner.classList.add('active'); state.currentEventKey = evt.key;
                }
            } else if (state.currentEventKey !== null) {
                banner.classList.remove('active'); state.currentEventKey = null;
            }

            let myNode = state.nodes[state.userRole];

            const invBox = document.getElementById('inv-box'); const blBox = document.getElementById('backlog-box');
            if (myNode.backlog > 0) {
                blBox.classList.add('border-red-500', 'bg-flash-danger');
                document.getElementById('main-body').classList.add('screen-shake');
                playError(); setTimeout(()=>document.getElementById('main-body').classList.remove('screen-shake'), 500);
            } else { blBox.classList.remove('border-red-500', 'bg-flash-danger'); }

            if (myNode.inv > 30) { invBox.classList.add('border-amber-500', 'bg-amber-100'); }
            else { invBox.classList.remove('border-amber-500', 'bg-amber-100'); }

            document.getElementById('ui-my-inventory').innerText = myNode.inv;
            document.getElementById('ui-my-backlog').innerText = myNode.backlog;
            document.getElementById('ui-cost-inv').innerText = (myNode.inv * CONFIG.costInv).toFixed(1);
            document.getElementById('ui-cost-backlog').innerText = (myNode.backlog * CONFIG.costBacklog).toFixed(1);
            document.getElementById('ui-last-week-cost').innerText = state.lastWeekCost.toFixed(1);

            document.getElementById('ui-transit-1').innerText = myNode.incomingShipmentQueue[0] || 0;
            document.getElementById('ui-transit-2').innerText = myNode.incomingShipmentQueue[1] || 0;
            document.getElementById('ui-intransit-order').innerText = myNode.inTransitOrderVisible;
            document.getElementById('ui-incoming-order').innerText = state.userRole === 'retailer' ? getDemandForWeek(state.week) : myNode.incomingOrderQueue[0];
            document.getElementById('ui-order-input').value = myNode.lastOrderPlaced;
        }

        function appendChat(sender, msg) {
            const chatBox = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `p-3 text-sm shadow-sm w-[85%] ${sender==='me' ? 'chat-bubble-me ml-auto' : 'chat-bubble-sys mr-auto'}`;
            div.innerHTML = `<strong>${sender==='me'?t('chat_me'): t('chat_sys')}:</strong><br>${msg}`;
            chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim(); if(!msg) return;
            appendChat('me', msg); input.value = '';
            
            setTimeout(() => {
                let myNode = state.nodes[state.userRole]; let idx = CONFIG.roles.indexOf(state.userRole);
                let upRole = idx < 3 ? CONFIG.roles[idx+1] : null; let downRole = idx > 0 ? CONFIG.roles[idx-1] : null;
                
                let reply = t('chat_r1');
                if (myNode.backlog > 0 && upRole) {
                    if (state.nodes[upRole].backlog > 10) reply = t('chat_r2').replace('{up}', getRoleName(upRole));
                    else if (state.nodes[upRole].inv > 0) reply = t('chat_r3').replace('{up}', getRoleName(upRole));
                } else if (myNode.inv > 30 && downRole) {
                    reply = t('chat_r4').replace('{down}', getRoleName(downRole));
                } else if (msg.length > 5) {
                    reply = t('chat_r5');
                }
                appendChat('sys', reply); playClick();
            }, 1000 + Math.random()*1000);
        }

        function calcAIOrder(role, incomingDemand) {
            let node = state.nodes[role];
            let behavior = state.aiSettings[role];
            let gap = CONFIG.initialInv - (node.inv - node.backlog);
            let pipeline = node.incomingShipmentQueue.reduce((a, b) => a + b, 0);
            
            let rawOrder = 0;
            if (behavior === 'rational') {
                rawOrder = incomingDemand + (gap * 0.5) - pipeline;
            } else if (behavior === 'aggressive') {
                rawOrder = incomingDemand + (gap * 1.5);
                if (node.backlog > 0) rawOrder += 5;
            } else {
                if (node.backlog > 5) rawOrder = incomingDemand + gap * 2;
                else rawOrder = incomingDemand * 0.8;
            }
            return Math.min(Math.max(0, Math.round(rawOrder)), 100);
        }

        function triggerTurnProcess() {
            let order = parseInt(document.getElementById('ui-order-input').value);
            if (isNaN(order) || order < 0) return;
            state.tempTurnData = { order }; playClick();
            
            document.getElementById('anim-week').innerText = state.week;
            const overlay = document.getElementById('processing-overlay');
            const btn = document.getElementById('btn-confirm-turn');
            const s1 = document.getElementById('anim-step-1'); const s2 = document.getElementById('anim-step-2'); const s3 = document.getElementById('anim-step-3');
            
            document.getElementById('anim-val-1').innerText = state.nodes[state.userRole].incomingShipmentQueue[0];
            document.getElementById('anim-val-2').innerText = Math.min(state.nodes[state.userRole].inv + state.nodes[state.userRole].incomingShipmentQueue[0], (state.userRole==='retailer'?getDemandForWeek(state.week):state.nodes[state.userRole].incomingOrderQueue[0]) + state.nodes[state.userRole].backlog);
            document.getElementById('anim-val-3').innerText = order;

            s1.className = 'step-hidden flex items-center justify-between text-green-600 bg-green-50 p-3 rounded-lg border border-green-100';
            s2.className = 'step-hidden flex items-center justify-between text-orange-600 bg-orange-50 p-3 rounded-lg border border-orange-100';
            s3.className = 'step-hidden flex items-center justify-between text-purple-600 bg-purple-50 p-3 rounded-lg border border-purple-100';
            btn.classList.add('hidden'); overlay.classList.remove('hidden');

            setTimeout(() => { s1.classList.replace('step-hidden', 'step-visible'); }, 300);
            setTimeout(() => { s2.classList.replace('step-hidden', 'step-visible'); }, 900);
            setTimeout(() => { s3.classList.replace('step-hidden', 'step-visible'); }, 1500);
            setTimeout(() => { btn.classList.remove('hidden'); }, 2000);
        }

        function finalizeTurn() {
            document.getElementById('processing-overlay').classList.add('hidden');
            let order = state.tempTurnData.order; state.tempTurnData = null;

            let demand = getDemandForWeek(state.week);
            let startStates = {}; CONFIG.roles.forEach(r => startStates[r] = { inv: state.nodes[r].inv, backlog: state.nodes[r].backlog });

            let inOrders = {}; CONFIG.roles.forEach(r => inOrders[r] = r === 'retailer' ? demand : state.nodes[r].incomingOrderQueue.shift());
            let arriving = {}; CONFIG.roles.forEach(r => { arriving[r] = state.nodes[r].incomingShipmentQueue.shift(); state.nodes[r].inv += arriving[r]; });
            
            let shipped = {};
            CONFIG.roles.forEach(r => {
                let need = inOrders[r] + state.nodes[r].backlog;
                let s = Math.min(state.nodes[r].inv, need);
                state.nodes[r].inv -= s; state.nodes[r].backlog = need - s; shipped[r] = s;
            });

            let placed = {};
            CONFIG.roles.forEach(r => {
                if (r === state.userRole) { placed[r] = order; state.nodes[r].inTransitOrderVisible = order; } 
                else { placed[r] = calcAIOrder(r, inOrders[r]); }
                state.nodes[r].lastOrderPlaced = placed[r];
            });

            state.nodes.distributor.incomingShipmentQueue.push(shipped.factory);
            state.nodes.wholesaler.incomingShipmentQueue.push(shipped.distributor);
            state.nodes.retailer.incomingShipmentQueue.push(shipped.wholesaler);
            state.nodes.factory.incomingShipmentQueue.push(placed.factory); // Infinite capacity

            state.nodes.wholesaler.incomingOrderQueue.push(placed.retailer);
            state.nodes.distributor.incomingOrderQueue.push(placed.wholesaler);
            state.nodes.factory.incomingOrderQueue.push(placed.distributor);

            let sysCost = 0;
            CONFIG.roles.forEach(r => {
                let n = state.nodes[r]; let c = (n.inv * CONFIG.costInv) + (n.backlog * CONFIG.costBacklog);
                sysCost += c;
                if(r === state.userRole) { state.lastWeekCost = c; state.myTotalInvCost += n.inv * CONFIG.costInv; state.myTotalBacklogCost += n.backlog * CONFIG.costBacklog; state.myTotalCost += c; }
            });
            state.systemTotalCost += sysCost;

            state.myHistoryLog.push({ week: state.week, startInv: startStates[state.userRole].inv, received: arriving[state.userRole], shipped: shipped[state.userRole], endInv: state.nodes[state.userRole].inv, backlog: state.nodes[state.userRole].backlog, orderPlaced: placed[state.userRole], cost: state.lastWeekCost });
            buildTable();

            state.chartData.labels.push(`W${state.week}`); state.chartData.demand.push(demand);
            CONFIG.roles.forEach(r => state.chartData.orders[r].push(placed[r]));

            state.week++;
            if (state.week > CONFIG.maxWeeks) endGame(); else updateDashboardUI();
        }

        function buildTable() {
            let html = `<thead class="bg-slate-100 text-sm font-bold"><tr><th class="py-3 px-2">${t('table_w')}</th><th class="px-2">${t('table_start')}</th><th class="text-green-600 px-2">${t('table_in')}</th><th class="text-orange-600 px-2">${t('table_out')}</th><th class="bg-slate-200 px-2">${t('table_end')}</th><th class="text-red-600 px-2">${t('table_backlog')}</th><th class="text-blue-600 px-2">${t('table_order')}</th><th class="px-2">${t('table_cost')}</th></tr></thead><tbody class="divide-y font-mono text-sm">`;
            [...state.myHistoryLog].reverse().forEach(r => {
                html += `<tr><td class="py-2">W${r.week}</td><td>${r.startInv}</td><td class="text-green-600">+${r.received}</td><td class="text-orange-600">-${r.shipped}</td><td class="bg-slate-50 font-bold">${r.endInv}</td><td class="text-red-600 font-bold">${r.backlog}</td><td class="text-blue-600 font-bold">${r.orderPlaced}</td><td>${c()}${r.cost}</td></tr>`;
            });
            html += `</tbody>`;
            document.getElementById('main-history-table').innerHTML = html;
            
            // For PDF, generate in normal order
            let pdfHtml = `<thead class="bg-slate-100 text-sm font-bold"><tr><th class="py-3 px-2">${t('table_w')}</th><th class="px-2">${t('table_start')}</th><th class="text-green-600 px-2">${t('table_in')}</th><th class="text-orange-600 px-2">${t('table_out')}</th><th class="bg-slate-200 px-2">${t('table_end')}</th><th class="text-red-600 px-2">${t('table_backlog')}</th><th class="text-blue-600 px-2">${t('table_order')}</th><th class="px-2">${t('table_cost')}</th></tr></thead><tbody class="divide-y font-mono text-sm">`;
            state.myHistoryLog.forEach(r => {
                pdfHtml += `<tr><td class="py-2">W${r.week}</td><td>${r.startInv}</td><td class="text-green-600">+${r.received}</td><td class="text-orange-600">-${r.shipped}</td><td class="bg-slate-50 font-bold">${r.endInv}</td><td class="text-red-600 font-bold">${r.backlog}</td><td class="text-blue-600 font-bold">${r.orderPlaced}</td><td>${c()}${r.cost}</td></tr>`;
            });
            pdfHtml += `</tbody>`;
            document.getElementById('pdf-history-content').innerHTML = `<table class="w-full text-center border-collapse border border-slate-300">${pdfHtml}</table>`;
        }

        function calcVar(arr) { let m=arr.reduce((a,b)=>a+b,0)/arr.length; return arr.map(v=>Math.pow(v-m,2)).reduce((a,b)=>a+b,0)/arr.length; }

        function endGame() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('hidden');
            
            document.getElementById('final-cost').innerText = state.myTotalCost.toFixed(0);
            document.getElementById('final-cost-inv').innerText = state.myTotalInvCost.toFixed(0);
            document.getElementById('final-cost-backlog').innerText = state.myTotalBacklogCost.toFixed(0);
            document.getElementById('final-system-cost').innerText = state.systemTotalCost.toFixed(0);

            const dVar = calcVar(state.chartData.demand);
            let vars = {}; CONFIG.roles.forEach(r => vars[r] = calcVar(state.chartData.orders[r]));
            let mRole = Object.keys(vars).reduce((a, b) => vars[a] > vars[b] ? a : b);
            
            // Dynamic text using current locked language
            let evalTxt = t('eval_p1').replace('{dvar}', dVar.toFixed(1));
            evalTxt += t('eval_p2').replace('{mrole}', getRoleName(mRole)).replace('{ratio}', (dVar===0?0:(vars[mRole]/dVar)).toFixed(1));
            evalTxt += t('eval_p3');
            document.getElementById('variance-evaluation').innerHTML = evalTxt;

            new Chart(document.getElementById('bullwhipChart').getContext('2d'), {
                type: 'line',
                data: { labels: state.chartData.labels, datasets: [
                    { label: t('role_con'), data: state.chartData.demand, borderColor: '#000', borderDash: [5, 5], borderWidth: 3 },
                    { label: getRoleName(state.userRole), data: state.chartData.orders[state.userRole], borderColor: '#3b82f6', borderWidth: 4 },
                    { label: getRoleName(mRole), data: state.chartData.orders[mRole], borderColor: '#ef4444', backgroundColor:'rgba(239,68,68,0.1)', fill:true, borderWidth: 2 }
                ]},
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function exportToPDF() {
            const btn = document.getElementById('btn-export');
            btn.innerHTML = '...'; btn.disabled = true;
            document.getElementById('pdf-history-table').classList.remove('hidden');
            
            // Allow slightly longer for rendering before export
            setTimeout(() => {
                html2pdf().set({ margin: 10, filename: `BeerGame_${state.playerName}.pdf` }).from(document.getElementById('pdf-content-wrapper')).save().then(() => {
                    btn.innerHTML = `ğŸ“¥ ${t('btn_export')}`; btn.disabled = false;
                    document.getElementById('pdf-history-table').classList.add('hidden');
                });
            }, 300);
        }
    </script>
</body>
</html>