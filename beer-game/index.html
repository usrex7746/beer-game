<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•¤é…’æ¸¸æˆ (The Beer Game)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            background: linear-gradient(rgba(30, 20, 15, 0.85), rgba(30, 20, 15, 0.95)), 
                        url('https://images.unsplash.com/photo-1514933651103-005eec06c04b?q=80&w=1934&auto=format&fit=crop') center/cover fixed;
            color: #f8fafc; 
            overflow-x: hidden;
        }

        .chart-container { position: relative; width: 100%; height: 350px; }
        .chart-container-large { position: relative; width: 100%; height: 500px; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.4s ease-out forwards; }
        
        @keyframes flashDanger { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #fca5a5; } }
        .bg-flash-danger { animation: flashDanger 1s infinite; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px) rotate(-1deg); }
            40% { transform: translateX(8px) rotate(1deg); }
            60% { transform: translateX(-8px) rotate(-1deg); }
            80% { transform: translateX(8px) rotate(1deg); }
        }
        .screen-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes clink {
            0% { transform: scale(1) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.5) rotate(15deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 0; }
        }
        .animate-clink { animation: clink 1s ease-in-out forwards; display: inline-block; }

        /* æ–°å¢ï¼šæ»šåŠ¨å­—å¹•åŠ¨ç”» */
        @keyframes ticker {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
        .animate-ticker {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 20s linear infinite;
            will-change: transform;
        }

        .hidden { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .glass-card { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); color: #0f172a; }
        .chat-bubble-me { background-color: #3b82f6; color: white; border-radius: 12px 12px 0 12px; }
        .chat-bubble-sys { background-color: #e2e8f0; color: #1e293b; border-radius: 12px 12px 12px 0; }

        .dropdown-menu { transform-origin: top right; transition: all 0.2s ease; opacity: 0; transform: scale(0.95); pointer-events: none; }
        .dropdown-menu.active { opacity: 1; transform: scale(1); pointer-events: auto; }

        .step-hidden { opacity: 0; transform: translateX(-20px); transition: all 0.4s ease; }
        .step-visible { opacity: 1; transform: translateX(0); }
    </style>
</head>
<body class="flex flex-col min-h-screen" id="main-body" onclick="closeDropdowns(event)">

    <!-- é¡¶æ  -->
    <header class="bg-black/60 backdrop-blur-md text-amber-500 shadow-md z-10 sticky top-0 border-b border-amber-900/50">
        <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ğŸº</span>
                <h1 class="text-xl font-black tracking-widest text-amber-400" data-i18n="app_title">å•¤é…’æ¸¸æˆ</h1>
            </div>
            
            <div class="flex items-center gap-3 md:gap-4">
                <div id="header-status" class="hidden items-center gap-3 text-sm mr-2">
                    <div class="hidden md:flex items-center gap-2">
                        <span class="text-slate-300" data-i18n="player">ç©å®¶:</span>
                        <span id="ui-player-name" class="font-bold text-white tracking-wide">--</span>
                    </div>
                    
                    <div class="bg-blue-900/60 px-3 py-1 rounded-full border border-blue-700/50 shadow-inner flex items-center gap-1.5 text-blue-100">
                        <span class="text-lg">ğŸ—“ï¸</span>
                        <span id="ui-month-display" class="font-bold">1æœˆ</span>
                        <span class="text-slate-400">|</span>
                        <span id="ui-temp-display" class="font-black text-amber-400">2Â°C</span>
                    </div>

                    <div class="bg-amber-900/50 px-4 py-1 rounded-full border border-amber-700/50 shadow-inner">
                        <span data-i18n="week">å‘¨æ¬¡</span> <span id="ui-week-counter" class="text-amber-400 font-bold text-lg mx-1">1</span> / 26
                    </div>
                </div>

                <button onclick="toggleModal('info-modal')" class="text-slate-300 hover:text-white transition-colors" title="About / å…³äº">
                    <span class="text-xl">â„¹ï¸</span>
                </button>

                <div class="relative" id="lang-wrapper">
                    <button onclick="toggleDropdown(event, 'lang-dropdown')" class="flex items-center gap-1 text-xl bg-slate-800/80 px-2 py-1 rounded hover:bg-slate-700 transition border border-slate-600">
                        <span id="current-flag">ğŸ‡¨ğŸ‡³</span> <span class="text-[10px] text-slate-300">â–¼</span>
                    </button>
                    <div id="lang-dropdown" class="dropdown-menu absolute right-0 mt-2 w-32 bg-white rounded-lg shadow-xl border border-slate-200 py-1 z-50">
                        <button onclick="setLanguage('zh', 'ğŸ‡¨ğŸ‡³')" class="w-full text-left px-4 py-2 hover:bg-slate-100 text-slate-800 text-sm flex items-center gap-2"><span class="text-lg">ğŸ‡¨ğŸ‡³</span> ä¸­æ–‡</button>
                        <button onclick="setLanguage('en', 'ğŸ‡ºğŸ‡¸')" class="w-full text-left px-4 py-2 hover:bg-slate-100 text-slate-800 text-sm flex items-center gap-2"><span class="text-lg">ğŸ‡ºğŸ‡¸</span> English</button>
                        <button onclick="setLanguage('es', 'ğŸ‡ªğŸ‡¸')" class="w-full text-left px-4 py-2 hover:bg-slate-100 text-slate-800 text-sm flex items-center gap-2"><span class="text-lg">ğŸ‡ªğŸ‡¸</span> EspaÃ±ol</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- é¡¶éƒ¨æ–°é—»æ»šåŠ¨å­—å¹• (æ–°ç‰ˆ) -->
    <div id="event-banner" class="hidden bg-amber-500 text-white shadow-md relative z-0 w-full h-9 flex items-center overflow-hidden">
        <div class="absolute left-0 top-0 h-full bg-amber-600 px-4 flex items-center gap-2 font-black z-30 shadow-[2px_0_5px_rgba(0,0,0,0.2)]">
            <span class="text-xl animate-pulse">ğŸ“°</span>
            <span data-i18n="news_title">å•†ä¸šå¤´æ¡ï¼š</span>
        </div>
        <div class="flex h-full items-center flex-grow">
            <!-- æ»šåŠ¨å†…å®¹ -->
            <div class="animate-ticker font-bold text-sm md:text-base tracking-wide" id="event-desc"></div>
        </div>
    </div>

    <!-- ä¸»ä½“åŒºåŸŸ -->
    <main class="flex-grow w-full max-w-5xl mx-auto px-4 py-4 relative">

        <!-- ========================================== -->
        <!-- ç•Œé¢ 1: è®¾ç½®å¤§å…                           -->
        <!-- ========================================== -->
        <div id="screen-setup" class="slide-in max-w-3xl mx-auto glass-card rounded-2xl shadow-2xl overflow-hidden relative mt-4">
            
            <button onclick="toggleModal('rules-modal')" class="absolute top-4 right-4 bg-white/20 hover:bg-white/40 text-white border border-white/50 backdrop-blur-sm px-4 py-2 rounded-full text-sm font-bold transition flex items-center gap-2 z-10">
                <span>ğŸ“–</span> <span data-i18n="btn_rules">æ¸¸æˆè§„åˆ™æ‰‹å†Œ</span>
            </button>

            <div class="bg-amber-600 pt-10 pb-6 px-8 text-white text-center relative">
                <h2 class="text-4xl font-black mb-2 tracking-widest" data-i18n="setup_title_new">å•¤é…’æ¸¸æˆ</h2>
                <p class="text-amber-100 text-sm font-medium tracking-wide" data-i18n="setup_desc">ä½ èƒ½å¦åœ¨ä¿¡æ¯çš„è¿·é›¾ä¸å»¶è¿Ÿä¸­ï¼Œæ‰“ç ´ç‰›é­æ•ˆåº”çš„é­”å’’ï¼Ÿ</p>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2" data-i18n="char_name">1. è§’è‰²åç§°ï¼š</label>
                        <input type="text" id="input-player-name" class="w-full px-4 py-2.5 rounded-xl border-2 border-slate-300 focus:border-amber-500 focus:ring-0 outline-none text-base transition-colors bg-white">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2" data-i18n="story_bg">2. æ•…äº‹èƒŒæ™¯ (å½±å“å­£èŠ‚èµ°åŠ¿)ï¼š</label>
                        <select id="input-start-month" class="w-full px-4 py-2.5 rounded-xl border-2 border-slate-300 focus:border-amber-500 focus:ring-0 outline-none text-base transition-colors bg-white">
                            <option value="1" data-i18n="bg_1">å¯’å†¬å¼€å±€ (1æœˆ)</option>
                            <option value="4" data-i18n="bg_4">è¿æˆ˜å¤å­£æ—ºå­£ (4æœˆ)</option>
                            <option value="7" data-i18n="bg_7">æ—ºå­£å·…å³°å¼€å±€ (7æœˆ)</option>
                            <option value="10" data-i18n="bg_10">ç§‹å­£å¹³ç¨³å¼€å±€ (10æœˆ)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-bold text-slate-700 mb-3" data-i18n="setup_step2">3. é€‰æ‹©æ‰®æ¼”è§’è‰²ï¼š</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="role" value="retailer" class="peer sr-only" checked onchange="updateSelectedRole(this.value)">
                            <div class="p-3 rounded-xl border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:bg-amber-50 hover:bg-slate-50 transition-all text-center">
                                <div class="text-2xl mb-1">ğŸª</div><div class="font-bold text-slate-800 text-sm" data-i18n="role_ret">é›¶å”®å•†</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="role" value="wholesaler" class="peer sr-only" onchange="updateSelectedRole(this.value)">
                            <div class="p-3 rounded-xl border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:bg-amber-50 hover:bg-slate-50 transition-all text-center">
                                <div class="text-2xl mb-1">ğŸ¢</div><div class="font-bold text-slate-800 text-sm" data-i18n="role_who">æ‰¹å‘å•†</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="role" value="distributor" class="peer sr-only" onchange="updateSelectedRole(this.value)">
                            <div class="p-3 rounded-xl border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:bg-amber-50 hover:bg-slate-50 transition-all text-center">
                                <div class="text-2xl mb-1">ğŸš›</div><div class="font-bold text-slate-800 text-sm" data-i18n="role_dis">åˆ†é”€å•†</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="role" value="factory" class="peer sr-only" onchange="updateSelectedRole(this.value)">
                            <div class="p-3 rounded-xl border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:bg-amber-50 hover:bg-slate-50 transition-all text-center">
                                <div class="text-2xl mb-1">ğŸ­</div><div class="font-bold text-slate-800 text-sm" data-i18n="role_fac">å·¥å‚</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-sm text-blue-800 flex gap-3 items-start">
                    <span class="text-xl">ğŸ¤–</span>
                    <div>
                        <strong data-i18n="ai_note_title">AI é˜Ÿå‹å·²å‡†å¤‡å°±ç»ªï¼š</strong><br>
                        <span data-i18n="ai_note_desc">ç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åˆ†é… 3 ä½æ€§æ ¼å„å¼‚çš„ AI é˜Ÿå‹ï¼ˆæ€¥èºã€è¿Ÿé’æˆ–ç†æ€§ï¼‰ã€‚è¯·æ³¨æ„ï¼Œç†æ€§é˜Ÿå‹è‡³å¤šåªæœ‰ 1 ä½ã€‚çœŸå®çš„ä¾›åº”é“¾ä¸­ï¼Œä½ æ°¸è¿œä¸çŸ¥é“ä½ çš„ä¸Šä¸‹æ¸¸åœ¨æƒ³ä»€ä¹ˆã€‚</span>
                    </div>
                </div>

                <button onclick="startIntroAnimation()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-black py-3.5 rounded-xl text-lg transition-all active:scale-[0.98] shadow-lg" data-i18n="btn_start">
                    è¿›å…¥é…’é¦†å¼€å§‹æ¸¸æˆ
                </button>
            </div>
        </div>

        <!-- å€’åœºåŠ¨ç”» -->
        <div id="screen-intro" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center text-white">
            <div id="countdown-text" class="text-9xl font-black text-amber-500 tracking-widest drop-shadow-[0_0_20px_rgba(245,158,11,0.8)]">3</div>
            <div id="clink-emoji" class="hidden text-9xl">ğŸ»</div>
        </div>

        <!-- ========================================== -->
        <!-- ç•Œé¢ 2: æ¸¸æˆæ§åˆ¶å° (ç´§å‡‘ä¸€å±ç‰ˆ)            -->
        <!-- ========================================== -->
        <div id="screen-game" class="hidden slide-in flex flex-col gap-5">
            
            <!-- ä¸Šä¸‹æ¸¸å¹¶æ’æ¨¡å— -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <!-- å·¦ä¾§: ä¸Šæ¸¸ -->
                <div class="glass-card rounded-2xl p-4 border-l-4 border-l-indigo-500 flex flex-col justify-between shadow-lg relative">
                    <div class="mb-2">
                        <div class="text-[11px] font-bold text-slate-500 uppercase" data-i18n="upstream">æˆ‘çš„ä¸Šæ¸¸</div>
                        <div class="text-lg font-black text-slate-800" id="ui-upstream-name">--</div>
                    </div>
                    
                    <div class="bg-slate-50 rounded-xl p-2.5 border border-slate-200 mt-1">
                        <div class="text-[10px] text-slate-500 font-bold mb-1.5 uppercase tracking-wider text-center" data-i18n="transit_title">ğŸšš åœ¨é€”å®ç‰©æ˜ç»†</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-white p-2 rounded-lg border border-slate-200 text-center shadow-sm">
                                <div class="text-[10px] text-slate-500 font-bold uppercase mb-0.5" data-i18n="transit_1">ä¸‹å‘¨åˆ°è¾¾</div>
                                <div class="text-2xl font-black text-indigo-600" id="ui-transit-1">0</div>
                            </div>
                            <div class="bg-white p-2 rounded-lg border border-slate-200 text-center shadow-sm">
                                <div class="text-[10px] text-slate-500 font-bold uppercase mb-0.5" data-i18n="transit_2">ä¸¤å‘¨ååˆ°è¾¾</div>
                                <div class="text-2xl font-black text-blue-500" id="ui-transit-2">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§: ä¸‹æ¸¸ -->
                <div class="glass-card rounded-2xl p-4 border-l-4 border-l-orange-500 flex flex-col justify-between shadow-lg">
                    <div>
                        <div class="text-[11px] font-bold text-slate-500 uppercase" data-i18n="downstream">æˆ‘çš„ä¸‹æ¸¸ (éœ€æ±‚æ–¹)</div>
                        <div class="text-lg font-black text-slate-800" id="ui-downstream-name">--</div>
                    </div>
                    <div class="text-center bg-orange-50 p-4 rounded-xl border border-orange-100 shadow-inner mt-2 flex-grow flex flex-col justify-center">
                        <div class="text-xs text-orange-800 font-bold uppercase mb-1" data-i18n="incoming_order">æ”¶åˆ°æ–°è®¢å•</div>
                        <div class="text-5xl font-black text-orange-600" id="ui-incoming-order">0</div>
                    </div>
                </div>
            </div>

            <!-- ä¸­å¿ƒ: ç©å®¶ä»“åº“ -->
            <div class="glass-card rounded-2xl p-6 border-t-4 border-t-amber-500 shadow-2xl relative flex-grow">
                <button onclick="toggleModal('history-modal')" class="absolute top-4 right-4 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-lg flex items-center gap-1 font-bold transition-colors border border-slate-200 z-10">
                    <span>ğŸ“Š</span> <span data-i18n="btn_history">æŸ¥çœ‹åº“å­˜è¡¨</span>
                </button>
                
                <div class="text-center mb-5">
                    <h2 class="text-2xl font-black text-slate-800" id="ui-my-role-name">--</h2>
                    <div class="text-xs font-bold text-slate-500 mt-1" data-i18n="my_dash">ä½ çš„ä»“åº“ä¸è°ƒåº¦ä¸­å¿ƒ</div>
                </div>

                <div class="flex justify-center gap-5 mb-6">
                    <div id="inv-box" class="w-1/2 bg-slate-50 rounded-2xl border border-slate-200 flex flex-col overflow-hidden transition-colors">
                        <div class="p-4 text-center">
                            <div class="text-xs text-slate-500 font-bold mb-1" data-i18n="curr_inv">ğŸ“¦ å½“å‰å¯ç”¨åº“å­˜</div>
                            <div id="ui-my-inventory" class="text-5xl font-black text-slate-800">12</div>
                        </div>
                        <div class="bg-blue-100/50 py-1.5 text-center border-t border-blue-200">
                            <div class="text-[11px] text-blue-800 font-bold"><span data-i18n="cost_inv_label">ç»´æŒè´¹: {c}1.0/ä»¶</span> â” <span class="curr-symbol">Â¥</span><span id="ui-cost-inv">12.0</span></div>
                        </div>
                    </div>

                    <div id="backlog-box" class="w-1/2 bg-slate-50 rounded-2xl border border-slate-200 flex flex-col overflow-hidden transition-colors relative">
                        <div class="p-4 text-center">
                            <div class="text-xs text-slate-500 font-bold mb-1" data-i18n="curr_backlog">âš ï¸ ä¸¥é‡æ¬ å•</div>
                            <div id="ui-my-backlog" class="text-5xl font-black text-red-600">0</div>
                        </div>
                        <div class="bg-red-100/50 py-1.5 text-center border-t border-red-200">
                            <div class="text-[11px] text-red-800 font-bold"><span data-i18n="cost_backlog_label">è¿çº¦é‡‘: {c}2.0/ä»¶</span> â” <span class="curr-symbol">Â¥</span><span id="ui-cost-backlog">0.0</span></div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-100 rounded-xl p-5 text-center border border-slate-200 shadow-inner max-w-md mx-auto">
                    <label class="block text-sm font-bold text-slate-800 mb-3" data-i18n="order_prompt">å†³ç­–ï¼šæœ¬å‘¨å‘ä½ çš„ä¸Šæ¸¸è®¢è´­å¤šå°‘ï¼Ÿ</label>
                    <div class="flex gap-2">
                        <input type="number" id="ui-order-input" min="0" class="w-full text-center text-3xl font-black font-mono border-2 border-slate-300 rounded-xl focus:border-amber-500 focus:ring-0 outline-none p-2 text-slate-800 bg-white">
                        <button onclick="triggerTurnProcess()" class="bg-amber-600 hover:bg-amber-700 text-white font-black px-6 py-2 rounded-xl shadow-lg transition-transform active:scale-95 text-lg tracking-wide" data-i18n="btn_submit">
                            æäº¤
                        </button>
                    </div>
                    <div class="mt-2 text-[11px] text-slate-500 font-bold bg-white py-1 rounded border border-slate-200">
                        <span data-i18n="order_delay_note">â³ è®¢å•å»¶è¿Ÿ: 1å‘¨</span> | <span data-i18n="intransit_order">å½“å‰åœ¨é€”è®¢å•:</span> <span id="ui-intransit-order" class="text-amber-600">4</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- ç•Œé¢ 3: æœ€ç»ˆå¤ç›˜                           -->
        <!-- ========================================== -->
        <div id="screen-result" class="hidden slide-in space-y-6">
            <div id="pdf-content-wrapper" class="glass-card p-6 md:p-8 rounded-2xl shadow-2xl border border-slate-200">
                
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-slate-200 pb-4 gap-4">
                    <div>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-900 mb-1 tracking-tight" data-i18n="result_title">æ¨¡æ‹Ÿç»“æŸï¼šç‰›é­æ•ˆåº”å…¨é“¾è·¯å¤ç›˜</h2>
                        <p class="text-slate-600 text-sm md:text-base" data-i18n="result_desc">ä¸Šå¸è§†è§’å·²å¼€å¯ï¼Œæ¥çœ‹çœ‹å„èŠ‚ç‚¹æ˜¯å¦‚ä½•åº”å¯¹å»¶è¿Ÿä¸æ³¢åŠ¨çš„ã€‚</p>
                    </div>
                    <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center gap-2 whitespace-nowrap" id="btn-export">
                        <span>ğŸ“¥</span> <span data-i18n="btn_export">å¯¼å‡º PDF æŠ¥å‘Š</span>
                    </button>
                </div>

                <!-- ç©å®¶æ‰“åˆ†è¯„çº§æ¨¡å— (åŠ¨æ€é˜ˆå€¼ç‰ˆ) -->
                <div class="bg-gradient-to-br from-amber-100 to-amber-50 p-5 md:p-6 rounded-2xl border border-amber-300 shadow-sm flex flex-col md:flex-row items-center gap-6 mb-8">
                    <div class="text-center w-full md:w-auto md:border-r md:border-amber-200 md:pr-6">
                        <div class="text-sm font-bold text-amber-800 mb-1" data-i18n="grade_title">ç»¼åˆæ“ä½œè¯„çº§</div>
                        <div id="final-grade" class="text-6xl md:text-7xl font-black text-amber-500 drop-shadow-md leading-none">--</div>
                    </div>
                    <div class="flex-grow w-full">
                        <ul class="text-sm text-amber-900 space-y-2 mb-3">
                            <li class="flex justify-between border-b border-amber-200/50 pb-1">
                                <span data-i18n="grade_var_lbl">ğŸ¯ æ‚¨çš„éœ€æ±‚æ³¢åŠ¨æ”¾å¤§å€æ•°ï¼š</span>
                                <strong id="grade-var-ratio" class="text-lg">--</strong>
                            </li>
                            <li class="flex justify-between border-b border-amber-200/50 pb-1">
                                <span data-i18n="grade_cost_lbl">ğŸ’° æ‚¨çš„æˆæœ¬å å…¨é“¾è·¯æ¯”ä¾‹ï¼š</span>
                                <strong id="grade-cost-ratio" class="text-lg">--</strong>
                            </li>
                        </ul>
                        <div class="text-[11px] text-amber-700/80 bg-white/50 p-2.5 rounded-lg leading-relaxed">
                            <strong data-i18n="grade_criteria_title">è¯„çº§æ ‡å‡†ï¼š</strong><br>
                            <span id="ui-grade-s">--</span> | 
                            <span id="ui-grade-a">--</span><br>
                            <span id="ui-grade-b">--</span> | 
                            <span id="ui-grade-c" data-i18n="grade_c">Cçº§ï¼šè¶…å‡ºä»¥ä¸ŠèŒƒå›´</span>
                        </div>
                    </div>
                </div>

                <!-- æˆæœ¬ç»Ÿè®¡ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-1" data-i18n="my_total_cost">ğŸ§‘â€ğŸ’¼ ä½ ä¸ªäººçš„æ€»æˆæœ¬</h3>
                        <div class="text-4xl font-black text-blue-600 mb-1"><span class="curr-symbol">Â¥</span><span id="final-cost">0</span></div>
                        <div class="text-xs font-bold text-slate-500"><span data-i18n="inv_cost_label">ä»“å‚¨:</span> <span class="curr-symbol">Â¥</span><span id="final-cost-inv">0</span> | <span data-i18n="backlog_cost_label">è¿çº¦:</span> <span class="curr-symbol">Â¥</span><span id="final-cost-backlog">0</span></div>
                    </div>
                    <div class="bg-red-50 p-5 rounded-2xl border border-red-200">
                        <h3 class="text-sm font-bold text-red-800 uppercase tracking-wider mb-1" data-i18n="system_total_cost">ğŸŒ ä¾›åº”é“¾å…¨å±€æ€»æˆæœ¬</h3>
                        <div class="text-4xl font-black text-red-600 mb-1"><span class="curr-symbol">Â¥</span><span id="final-system-cost">0</span></div>
                        <p class="text-[11px] font-bold text-red-700 leading-tight" data-i18n="system_cost_desc">å…¨å±€æ€»æˆæœ¬åæ˜ äº†æ•´ä¸ªä¾›åº”é“¾åœ¨æ­¤æ¬¡æ¨¡æ‹Ÿä¸­ä»˜å‡ºçš„æ€»ä»£ä»·ã€‚</p>
                    </div>
                </div>

                <!-- ç‰›é­æ•ˆåº”å¤§å›¾ -->
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm mb-8">
                    <div class="mb-4">
                        <h3 class="text-xl font-black text-slate-800" data-i18n="bullwhip_chart_title">ğŸ“ˆ ç‰›é­æ•ˆåº”æ£€æµ‹å›¾</h3>
                        <p class="text-sm text-slate-500 mt-0.5" data-i18n="bullwhip_desc">å¯¹æ¯”â€œç»ˆç«¯éœ€æ±‚â€ï¼ˆè™šçº¿ï¼‰ä¸å„èŠ‚ç‚¹çš„â€œè®¢å•é‡â€ã€‚æ³¢å¹…è¢«æ”¾å¤§çš„å€æ•°å³ä¸ºç‰›é­æŒ‡æ•°ã€‚</p>
                    </div>
                    <div class="chart-container-large">
                        <canvas id="bullwhipChart"></canvas>
                    </div>
                    <div class="mt-4 bg-slate-50 p-3 rounded-lg text-xs text-slate-600 border border-slate-100" data-i18n="bullwhip_comment">
                        <strong>å›¾è¡¨ç‚¹è¯„ï¼š</strong>ç‰›é­æ•ˆåº”å›¾è¡¨æ¸…æ™°åœ°å±•ç¤ºäº†éœ€æ±‚æ˜¯å¦‚ä½•éšç€ä¾›åº”é“¾å‘ä¸Šæ¸¸ä¼ é€’è€Œé€çº§æ”¾å¤§çš„ã€‚å¦‚æœæ‚¨çœ‹åˆ°çº¢è‰²çš„å·¥å‚æ›²çº¿å‡ºç°å·¨å¤§å³°å€¼ï¼Œè¿™æ„å‘³ç€ä¿¡æ¯å»¶è¿Ÿå’Œææ…Œå¯¼è‡´äº†ä¸¥é‡çš„è¿‡åº¦ååº”ã€‚
                    </div>
                </div>

                <!-- æˆæœ¬åŒè½´å›¾ & æ–¹å·®æ•°æ® -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="mb-4">
                            <h3 class="text-xl font-black text-slate-800" data-i18n="cost_chart_title">ğŸ“Š æˆæœ¬èµ°åŠ¿åˆ†æ (åŒè½´)</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="costChart"></canvas>
                        </div>
                        <div class="mt-4 text-xs text-slate-600 leading-relaxed" data-i18n="cost_comment">
                            <strong>å›¾è¡¨ç‚¹è¯„ï¼š</strong>åŒè½´æˆæœ¬å›¾åæ˜ äº†æ‚¨ä¸ªäººçš„æˆæœ¬éšæ—¶é—´çš„å˜åŒ–ã€‚ç”±äºç´¯ç§¯æ•ˆåº”ï¼ŒåæœŸçš„æˆæœ¬å¾€å¾€å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚
                        </div>
                    </div>

                    <div class="bg-blue-50 p-5 rounded-2xl border border-blue-200 shadow-sm flex flex-col justify-between">
                        <div>
                            <h3 class="text-xl font-black text-blue-900 mb-4" data-i18n="variance_title">ğŸ“‰ å…¨é“¾è·¯æ³¢åŠ¨æ–¹å·®å¯¹æ¯”</h3>
                            <div class="grid grid-cols-2 gap-3 mb-2" id="variance-cards-container"></div>
                        </div>
                        <div class="mt-4 bg-white/60 p-3 rounded-lg text-xs text-blue-800 leading-relaxed border border-blue-100" data-i18n="variance_comment">
                            <strong>æ•°æ®ç‚¹è¯„ï¼š</strong>æ–¹å·®å€æ•°ç›´è§‚é‡åŒ–äº†è®¢å•æ³¢åŠ¨å¹…åº¦ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨çš„æ–¹å·®å€æ•°åº”æ¥è¿‘æˆ–å°äº 1ï¼Œå³å¸æ”¶æ³¢åŠ¨è€Œä¸æ˜¯æ”¾å¤§æ³¢åŠ¨ã€‚
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 p-6 rounded-2xl text-white shadow-xl">
                    <h3 class="text-lg font-black text-amber-400 mb-3" data-i18n="eval_title">ğŸ“‰ æ ¸å¿ƒæ´å¯Ÿä¸å¤ç›˜ï¼š</h3>
                    <div class="text-sm leading-relaxed font-medium" id="variance-evaluation"></div>
                </div>

                <div id="pdf-history-table" class="hidden pt-8 border-t border-slate-200 mt-8">
                    <h3 class="text-2xl font-black text-slate-800 mb-4" data-i18n="history_title">ä½ çš„åº“å­˜è¡¨</h3>
                    <div id="pdf-history-content"></div>
                </div>
            </div>

            <div class="text-center pt-4 pb-8">
                <button onclick="location.reload()" class="bg-amber-600 hover:bg-amber-700 text-white font-black py-4 px-10 rounded-2xl shadow-xl hover:-translate-y-1 text-xl" data-i18n="btn_restart">
                    å†æ¥ä¸€å±€
                </button>
            </div>
        </div>

    </main>

    <!-- ========================================== -->
    <!-- æ¨¡æ€æ¡†ä¸æ‚¬æµ®çª— (Modals & Floating Widgets)    -->
    <!-- ========================================== -->

    <!-- å¾®ä¿¡èŠå¤©æ‚¬æµ®æŒ‰é’® -->
    <button id="chat-toggle-btn" onclick="toggleChat()" class="hidden fixed bottom-6 right-6 bg-slate-800 text-white w-14 h-14 rounded-full shadow-2xl hover:scale-105 transition-transform z-40 items-center justify-center">
        <span class="text-2xl">ğŸ’¬</span>
        <span id="chat-badge" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden border-2 border-white">!</span>
    </button>

    <!-- å¾®ä¿¡èŠå¤©å¼¹çª— -->
    <div id="chat-widget" class="fixed bottom-24 right-6 w-80 glass-card rounded-2xl border border-slate-200 shadow-2xl flex-col h-[420px] z-50 hidden">
        <div class="bg-slate-800 text-white p-3 flex items-center justify-between rounded-t-2xl">
            <div class="font-bold flex items-center gap-2"><span>ğŸ’¬</span> <span data-i18n="chat_title">ä¾›åº”é“¾å†…éƒ¨ç¾¤</span></div>
            <div class="flex items-center gap-3">
                <span class="text-[10px] bg-green-500 text-white px-2 py-0.5 rounded-full animate-pulse">Online</span>
                <button onclick="toggleChat()" class="text-slate-300 hover:text-white text-2xl leading-none">&times;</button>
            </div>
        </div>
        <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4 custom-scroll bg-slate-50/50">
            <div class="text-center text-xs text-slate-400 mb-2" data-i18n="chat_sys_msg">â€”â€” æ¸¸æˆå¼€å§‹ï¼Œå¯åœ¨æ­¤ä¸ä¸Šä¸‹æ¸¸æ²Ÿé€š â€”â€”</div>
        </div>
        <div class="p-3 bg-white border-t border-slate-200 rounded-b-2xl flex gap-2">
            <input type="text" id="chat-input" class="flex-grow px-3 py-2 border border-slate-300 rounded-lg text-sm outline-none focus:border-amber-500" onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-black transition">Send</button>
        </div>
    </div>

    <!-- è¿‡åœºåŠ¨ç”» Mask -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-amber-500"></div>
            <h3 class="text-3xl font-black text-center mb-8 text-slate-800"><span data-i18n="processing">å¤„ç†ç¬¬</span> <span id="anim-week" class="text-amber-500 mx-1"></span> <span data-i18n="week_suffix">å‘¨</span></h3>
            
            <div class="space-y-5 font-bold text-lg mb-8 px-2">
                <div id="anim-step-1" class="step-hidden flex items-center justify-between text-green-600 bg-green-50 p-4 rounded-xl border border-green-100">
                    <div class="flex items-center gap-3"><span class="text-2xl">ğŸšš</span> <span data-i18n="anim_receive">å…¥åº“ (æ”¶è´§)</span></div>
                    <span class="text-2xl font-black">+<span id="anim-val-1"></span></span>
                </div>
                <div id="anim-step-2" class="step-hidden flex items-center justify-between text-orange-600 bg-orange-50 p-4 rounded-xl border border-orange-100">
                    <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“¦</span> <span data-i18n="anim_ship">å‡ºåº“ (å‘è´§)</span></div>
                    <span class="text-2xl font-black">-<span id="anim-val-2"></span></span>
                </div>
                <div id="anim-step-3" class="step-hidden flex items-center justify-between text-purple-600 bg-purple-50 p-4 rounded-xl border border-purple-100">
                    <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“„</span> <span data-i18n="anim_order">å‘å‡ºè®¢å•</span></div>
                    <span class="text-2xl font-black"><span id="anim-val-3"></span></span>
                </div>
            </div>

            <button id="btn-confirm-turn" class="hidden w-full bg-amber-600 hover:bg-amber-700 text-white font-black py-4 rounded-xl shadow-lg transition-transform active:scale-95 text-xl" onclick="finalizeTurn()" data-i18n="btn_confirm">
                ç¡®è®¤ï¼Œè¿›å…¥ä¸‹ä¸€å‘¨
            </button>
        </div>
    </div>

    <!-- è´¦æœ¬å¼¹çª— -->
    <div id="history-modal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[85vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-slate-50">
                <h3 class="text-2xl font-black text-slate-800 flex items-center gap-3"><span>ğŸ“Š</span> <span data-i18n="history_title">ä½ çš„åº“å­˜è¡¨</span></h3>
                <button onclick="toggleModal('history-modal')" class="text-slate-400 hover:text-red-500 text-4xl font-black leading-none transition-colors">&times;</button>
            </div>
            <div class="p-0 overflow-y-auto custom-scroll flex-grow bg-white">
                <table class="w-full text-center" id="main-history-table"></table>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™æ‰‹å†Œå¼¹çª— -->
    <div id="rules-modal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-amber-50 text-amber-900">
                <h3 class="text-xl font-black flex items-center gap-2"><span>ğŸ“–</span> <span data-i18n="rules_title">æ¸¸æˆåŸºæœ¬è§„åˆ™</span></h3>
                <button onclick="toggleModal('rules-modal')" class="text-amber-700 hover:text-red-500 text-3xl font-black leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll flex-grow space-y-5 text-slate-700 text-sm leading-relaxed">
                <div>
                    <strong class="text-slate-900 text-base" data-i18n="rule_1_title">ğŸ¯ æ¸¸æˆç›®æ ‡</strong>
                    <p class="mt-1" data-i18n="rule_1_desc">åœ¨æ»¡è¶³ä¸‹æ¸¸éœ€æ±‚çš„å‰æä¸‹ï¼Œå°½é‡<strong>é™ä½ç³»ç»Ÿæ€»æˆæœ¬</strong>ã€‚ä½ åªèƒ½æ§åˆ¶è‡ªå·±èŠ‚ç‚¹å‘ä¸Šçš„è®¢è´§é‡ã€‚</p>
                </div>
                <div>
                    <strong class="text-slate-900 text-base" data-i18n="rule_2_title">ğŸ’° æˆæœ¬ç»“æ„</strong>
                    <ul class="list-disc pl-5 mt-1 space-y-1">
                        <li data-i18n="rule_2_1"><strong>ä»“å‚¨è´¹ï¼š</strong> æ¯ä»¶ç§¯å‹åœ¨åº“çš„å•†å“ï¼Œæ¯å‘¨æ‰£é™¤ {c}1.0ã€‚</li>
                        <li data-i18n="rule_2_2"><strong>ç¼ºè´§è¿çº¦é‡‘ï¼š</strong> å½“æ— æ³•æ»¡è¶³ä¸‹æ¸¸è®¢å•äº§ç”Ÿæ¬ å•æ—¶ï¼Œæ¯ä»¶æ¯å‘¨æ‰£é™¤ {c}2.0ã€‚ç¼ºè´§æƒ©ç½šæ¯”ç§¯å‹æ›´é‡ï¼</li>
                    </ul>
                </div>
                <div>
                    <strong class="text-slate-900 text-base" data-i18n="rule_3_title">â³ å‘¨æœŸä¸å»¶è¿Ÿ</strong>
                    <p class="mt-1" data-i18n="rule_3_desc">æ¸¸æˆæ€»è®¡è¿›è¡Œ <strong>26 å‘¨</strong> (åŠå¹´)ã€‚ä½ å‘å‡ºçš„è®¢å•éœ€è¦ <strong>1 å‘¨</strong> é€è¾¾ä¸Šæ¸¸ï¼›ä¸Šæ¸¸å‘å‡ºçš„å®ç‰©éœ€è¦ <strong>2 å‘¨</strong> ç‰©æµæ—¶é—´æ‰èƒ½åˆ°è¾¾ä½ çš„ä»“åº“ã€‚</p>
                </div>
                <div>
                    <strong class="text-slate-900 text-base" data-i18n="rule_4_title">ğŸ•¹ï¸ æ¯å‘¨è¡ŒåŠ¨</strong>
                    <p class="mt-1" data-i18n="rule_4_desc">1. æŸ¥æ”¶æœ¬å‘¨åˆ°è´§ä¸ä¸‹æ¸¸çš„æ–°è®¢å•ã€‚<br>2. ç•™æ„å±å¹•é¡¶éƒ¨çš„â€œå•†ä¸šå¤´æ¡â€æ–°é—»é¢„è­¦ã€‚<br>3. å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥åœ¨å³ä¾§çš„â€œä¾›åº”é“¾å†…éƒ¨ç¾¤â€æ²Ÿé€šã€‚<br>4. åœ¨æ§åˆ¶å°è¾“å…¥æœ¬å‘¨æ¬²è®¢è´­çš„æ•°é‡ï¼Œç‚¹å‡»â€œæäº¤â€è¿›å…¥ä¸‹ä¸€å‘¨ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Info (å…³äº) å¼¹çª— -->
    <div id="info-modal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-slate-800 text-white">
                <h3 class="text-lg font-bold" data-i18n="info_title">å…³äºå•¤é…’æ¸¸æˆ</h3>
                <button onclick="toggleModal('info-modal')" class="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4 text-slate-300 text-sm">
                <p data-i18n="info_p1">æœ¬æ¸¸æˆæ˜¯å¯¹éº»çœç†å·¥å­¦é™¢ (MIT) æ–¯éš†å•†å­¦é™¢äº 1960 å¹´ä»£è®¾è®¡çš„ç»å…¸ä¾›åº”é“¾æ²™ç›˜â€œBeer Distribution Gameâ€çš„è‡´æ•¬ä¸ç°ä»£ç½‘é¡µç‰ˆæ”¹ç¼–ã€‚</p>
                <p data-i18n="info_p2">åˆ›æ„ä¸ä»£ç æ¡†æ¶ç”± Google Gemini äººå·¥æ™ºèƒ½è¾…åŠ©å®Œæˆæ„å»ºã€‚</p>
                <div class="bg-slate-800 p-4 rounded-lg mt-4 border border-slate-700">
                    <p class="text-xs text-slate-400 mb-1" data-i18n="info_contact">åé¦ˆæˆ–å»ºè®®è¯·è”ç³»ï¼š</p>
                    <p class="font-mono text-amber-400">usrex7746@gmail.com (Rex)</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- I18N Engine ---
        const DICT = {
            zh: {
                app_title: "å•¤é…’æ¸¸æˆ", setup_title_new: "å•¤é…’æ¸¸æˆ", setup_desc: "ä½ èƒ½å¦åœ¨ä¿¡æ¯çš„è¿·é›¾ä¸å»¶è¿Ÿä¸­ï¼Œæ‰“ç ´ç‰›é­æ•ˆåº”çš„é­”å’’ï¼Ÿ",
                player: "ç©å®¶:", week: "å‘¨æ¬¡", char_name: "1. è§’è‰²åç§°ï¼š", story_bg: "2. æ•…äº‹èƒŒæ™¯ (å½±å“å­£èŠ‚èµ°åŠ¿)ï¼š", setup_step2: "3. é€‰æ‹©æ‰®æ¼”è§’è‰²ï¼š",
                bg_1: "å¯’å†¬å¼€å±€ (1æœˆ)", bg_4: "è¿æˆ˜å¤å­£æ—ºå­£ (4æœˆ)", bg_7: "æ—ºå­£å·…å³°å¼€å±€ (7æœˆ)", bg_10: "ç§‹å­£å¹³ç¨³å¼€å±€ (10æœˆ)",
                role_ret: "é›¶å”®å•†", role_who: "æ‰¹å‘å•†", role_dis: "åˆ†é”€å•†", role_fac: "å·¥å‚", role_con: "ç»ˆç«¯æ¶ˆè´¹è€…", role_sup: "å¤–éƒ¨ææ–™å•†",
                invalid_order: "è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢å•æ•°é‡ï¼",
                btn_start: "è¿›å…¥é…’é¦†å¼€å§‹æ¸¸æˆ", btn_confirm: "ç¡®è®¤ï¼Œè¿›å…¥ä¸‹ä¸€å‘¨",
                btn_rules: "æ¸¸æˆè§„åˆ™æ‰‹å†Œ", rules_title: "æ¸¸æˆåŸºæœ¬è§„åˆ™",
                rule_1_title: "ğŸ¯ æ¸¸æˆç›®æ ‡", rule_1_desc: "åœ¨æ»¡è¶³ä¸‹æ¸¸éœ€æ±‚çš„å‰æä¸‹ï¼Œå°½é‡<strong>é™ä½ç³»ç»Ÿæ€»æˆæœ¬</strong>ã€‚ä½ åªèƒ½æ§åˆ¶è‡ªå·±èŠ‚ç‚¹å‘ä¸Šçš„è®¢è´§é‡ã€‚",
                rule_2_title: "ğŸ’° æˆæœ¬ç»“æ„", rule_2_1: "<strong>ä»“å‚¨è´¹ï¼š</strong> æ¯ä»¶ç§¯å‹åœ¨åº“çš„å•†å“ï¼Œæ¯å‘¨æ‰£é™¤ {c}1.0ã€‚", rule_2_2: "<strong>ç¼ºè´§è¿çº¦é‡‘ï¼š</strong> å½“æ— æ³•æ»¡è¶³ä¸‹æ¸¸è®¢å•äº§ç”Ÿæ¬ å•æ—¶ï¼Œæ¯ä»¶æ¯å‘¨æ‰£é™¤ {c}2.0ã€‚ç¼ºè´§æƒ©ç½šæ¯”ç§¯å‹æ›´é‡ï¼",
                rule_3_title: "â³ å‘¨æœŸä¸å»¶è¿Ÿ", rule_3_desc: "æ¸¸æˆæ€»è®¡è¿›è¡Œ <strong>26 å‘¨</strong> (åŠå¹´)ã€‚ä½ å‘å‡ºçš„è®¢å•éœ€è¦ <strong>1 å‘¨</strong> é€è¾¾ä¸Šæ¸¸ï¼›ä¸Šæ¸¸å‘å‡ºçš„å®ç‰©éœ€è¦ <strong>2 å‘¨</strong> ç‰©æµæ—¶é—´æ‰èƒ½åˆ°è¾¾ä½ çš„ä»“åº“ã€‚",
                rule_4_title: "ğŸ•¹ï¸ æ¯å‘¨è¡ŒåŠ¨", rule_4_desc: "1. æŸ¥æ”¶æœ¬å‘¨åˆ°è´§ä¸ä¸‹æ¸¸çš„æ–°è®¢å•ã€‚<br>2. ç•™æ„å±å¹•é¡¶éƒ¨çš„â€œå•†ä¸šå¤´æ¡â€æ–°é—»é¢„è­¦ã€‚<br>3. å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥åœ¨å³ä¾§çš„â€œä¾›åº”é“¾å†…éƒ¨ç¾¤â€æ²Ÿé€šã€‚<br>4. åœ¨æ§åˆ¶å°è¾“å…¥æœ¬å‘¨æ¬²è®¢è´­çš„æ•°é‡ï¼Œç‚¹å‡»â€œæäº¤â€è¿›å…¥ä¸‹ä¸€å‘¨ã€‚",
                info_title: "å…³äºå•¤é…’æ¸¸æˆ", info_p1: "æœ¬æ¸¸æˆæ˜¯å¯¹éº»çœç†å·¥å­¦é™¢ (MIT) æ–¯éš†å•†å­¦é™¢äº 1960 å¹´ä»£è®¾è®¡çš„ç»å…¸ä¾›åº”é“¾æ²™ç›˜â€œBeer Distribution Gameâ€çš„è‡´æ•¬ä¸ç°ä»£ç½‘é¡µç‰ˆæ”¹ç¼–ã€‚", info_p2: "åˆ›æ„ä¸ä»£ç æ¡†æ¶ç”± Google Gemini äººå·¥æ™ºèƒ½è¾…åŠ©å®Œæˆæ„å»ºã€‚", info_contact: "åé¦ˆæˆ–å»ºè®®è¯·è”ç³»ï¼š",
                ai_note_title: "AI é˜Ÿå‹å·²å‡†å¤‡å°±ç»ªï¼š", ai_note_desc: "ç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åˆ†é… 3 ä½æ€§æ ¼å„å¼‚çš„ AI é˜Ÿå‹ï¼ˆæ€¥èºã€è¿Ÿé’æˆ–ç†æ€§ï¼‰ã€‚è¯·æ³¨æ„ï¼Œç†æ€§é˜Ÿå‹è‡³å¤šåªæœ‰ 1 ä½ã€‚çœŸå®çš„ä¾›åº”é“¾ä¸­ï¼Œä½ æ°¸è¿œä¸çŸ¥é“ä½ çš„ä¸Šä¸‹æ¸¸åœ¨æƒ³ä»€ä¹ˆã€‚",
                upstream: "æˆ‘çš„ä¸Šæ¸¸", transit_title: "åœ¨é€”å°†åˆ°è¾¾", transit_1: "ä¸‹å‘¨åˆ°è¾¾", transit_2: "ä¸¤å‘¨ååˆ°è¾¾",
                my_dash: "ä½ çš„ä»“åº“ä¸è°ƒåº¦ä¸­å¿ƒ", current_role: "å½“å‰æ‰®æ¼”", btn_history: "æŸ¥çœ‹åº“å­˜è¡¨", curr_inv: "ğŸ“¦ å½“å‰å¯ç”¨åº“å­˜", curr_backlog: "âš ï¸ ä¸¥é‡æ¬ å•",
                cost_inv_label: "ç»´æŒè´¹: {c}1.0/ä»¶", cost_backlog_label: "è¿çº¦é‡‘: {c}2.0/ä»¶", 
                order_prompt: "å†³ç­–ï¼šæœ¬å‘¨å‘ä½ çš„ä¸Šæ¸¸è®¢è´­å¤šå°‘ï¼Ÿ", btn_submit: "æäº¤", order_delay_note: "â³ è®¢å•å»¶è¿Ÿ: 1å‘¨", intransit_order: "å½“å‰åœ¨é€”è®¢å•:",
                downstream: "æˆ‘çš„ä¸‹æ¸¸ (éœ€æ±‚æ–¹)", incoming_order: "æ”¶åˆ°æ–°è®¢å•", result_title: "æ¨¡æ‹Ÿç»“æŸï¼šç‰›é­æ•ˆåº”å…¨é“¾è·¯å¤ç›˜", result_desc: "ä¸Šå¸è§†è§’å·²å¼€å¯ï¼Œæ¥çœ‹çœ‹å„èŠ‚ç‚¹æ˜¯å¦‚ä½•åº”å¯¹å»¶è¿Ÿä¸æ³¢åŠ¨çš„ã€‚",
                btn_export: "å¯¼å‡º PDF æŠ¥å‘Š", my_total_cost: "ğŸ§‘â€ğŸ’¼ ä½ ä¸ªäººçš„æ€»æˆæœ¬", system_total_cost: "ğŸŒ ä¾›åº”é“¾å…¨å±€æ€»æˆæœ¬",
                system_cost_desc: "å…¨å±€æ€»æˆæœ¬åæ˜ äº†æ•´ä¸ªä¾›åº”é“¾åœ¨æ­¤æ¬¡æ¨¡æ‹Ÿä¸­ä»˜å‡ºçš„æ€»ä»£ä»·ã€‚",
                inv_cost_label: "ä»“å‚¨:", backlog_cost_label: "è¿çº¦:",
                cost_chart_title: "ğŸ“Š æˆæœ¬èµ°åŠ¿åˆ†æ (åŒè½´)", total_cost_label: "ç´¯è®¡æ€»æˆæœ¬", variance_title: "ğŸ“‰ å…¨é“¾è·¯æ³¢åŠ¨æ–¹å·®å¯¹æ¯”",
                bullwhip_chart_title: "ğŸ“ˆ ç‰›é­æ•ˆåº”æ£€æµ‹å›¾", bullwhip_desc: "å¯¹æ¯”â€œç»ˆç«¯éœ€æ±‚â€ï¼ˆè™šçº¿ï¼‰ä¸å„èŠ‚ç‚¹çš„â€œè®¢å•é‡â€ã€‚æ³¢å¹…è¢«æ”¾å¤§çš„å€æ•°å³ä¸ºç‰›é­æŒ‡æ•°ã€‚", history_title: "ä½ çš„åº“å­˜è¡¨", btn_restart: "å†æ¥ä¸€å±€",
                processing: "å¤„ç†ç¬¬", week_suffix: "å‘¨", anim_loading: "è´§è½¦æ­£åœ¨è·¯ä¸Šï¼Œè®¢å•æ­£åœ¨ä¼ é€’...", anim_receive: "å…¥åº“ (æ”¶è´§)", anim_ship: "å‡ºåº“ (å‘è´§)", anim_order: "å‘å‡ºè®¢å•",
                table_w: "å‘¨æ¬¡", table_start: "æœŸåˆ", table_in: "+å…¥åº“", table_out: "-å‘è´§", table_end: "æœŸæœ«", table_backlog: "æ¬ å•", table_order: "å‘å•", table_cost: "æˆæœ¬",
                grade_title: "ç»¼åˆæ“ä½œè¯„çº§", grade_var_lbl: "ğŸ¯ éœ€æ±‚æ³¢åŠ¨æ”¾å¤§å€æ•°ï¼š", grade_cost_lbl: "ğŸ’° ä¸ªäººæˆæœ¬å å…¨é“¾è·¯æ¯”ä¾‹ï¼š",
                grade_criteria_title: "è¯„çº§æ ‡å‡†ï¼š", grade_c: "Cçº§ï¼šè¶…å‡ºä»¥ä¸ŠèŒƒå›´",
                grade_s_fmt: "Sçº§ï¼šæ–¹å·®å€æ•° < {v} ä¸” æˆæœ¬å æ¯” < {c}%", grade_a_fmt: "Açº§ï¼šæ–¹å·®å€æ•° < {v} ä¸” æˆæœ¬å æ¯” < {c}%", grade_b_fmt: "Bçº§ï¼šæ–¹å·®å€æ•° < {v} ä¸” æˆæœ¬å æ¯” < {c}%",
                bullwhip_comment: "<strong>å›¾è¡¨ç‚¹è¯„ï¼š</strong>ç‰›é­æ•ˆåº”å›¾è¡¨æ¸…æ™°åœ°å±•ç¤ºäº†éœ€æ±‚æ˜¯å¦‚ä½•éšç€ä¾›åº”é“¾å‘ä¸Šæ¸¸ä¼ é€’è€Œé€çº§æ”¾å¤§çš„ã€‚å¦‚æœæ‚¨çœ‹åˆ°çº¢è‰²çš„å·¥å‚æ›²çº¿å‡ºç°å·¨å¤§å³°å€¼ï¼Œè¿™æ„å‘³ç€ä¿¡æ¯å»¶è¿Ÿå’Œææ…Œå¯¼è‡´äº†ä¸¥é‡çš„è¿‡åº¦ååº”ã€‚",
                cost_comment: "<strong>å›¾è¡¨ç‚¹è¯„ï¼š</strong>åŒè½´æˆæœ¬å›¾åæ˜ äº†æ‚¨ä¸ªäººçš„æˆæœ¬éšæ—¶é—´çš„å˜åŒ–ã€‚ç”±äºç´¯ç§¯æ•ˆåº”ï¼ŒåæœŸçš„æˆæœ¬å¾€å¾€å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚",
                variance_comment: "<strong>æ•°æ®ç‚¹è¯„ï¼š</strong>æ–¹å·®å€æ•°ç›´è§‚é‡åŒ–äº†è®¢å•æ³¢åŠ¨å¹…åº¦ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨çš„æ–¹å·®å€æ•°åº”æ¥è¿‘æˆ–å°äº 1ï¼Œå³å¸æ”¶æ³¢åŠ¨è€Œä¸æ˜¯æ”¾å¤§æ³¢åŠ¨ã€‚",
                eval_title: "ğŸ“‰ æ ¸å¿ƒæ´å¯Ÿä¸å¤ç›˜ï¼š",
                eval_p1: "<strong class='text-blue-600 block mb-2 text-xl'>éœ€æ±‚æ”¾å¤§ä¸ä¿¡æ¯å»¶è¿Ÿ</strong><p class='mb-2'>ä½ åœ¨æ¸¸æˆä¸­çœ‹åˆ°äº†çœŸå®çš„å­£èŠ‚æ€§æ³¢åŠ¨ã€‚ç»ˆç«¯éœ€æ±‚å…¶å®åªåœ¨å°èŒƒå›´æ³¢åŠ¨ï¼ˆæ–¹å·® {dvar}ï¼‰ï¼Œä½†ç”±äºä¿¡æ¯ä¸é€æ˜å’Œå»¶è¿Ÿï¼Œå„èŠ‚ç‚¹äº§ç”Ÿäº†å¯¹éœ€æ±‚çš„è¯¯åˆ¤ã€‚</p>",
                eval_p2: "<p class='mb-2'>å…¨é“¾è·¯ä¸­ï¼Œéšç€è·ç¦»æ¶ˆè´¹è€…è¶Šè¿œï¼Œæ³¢åŠ¨è¶Šå‰§çƒˆã€‚<strong>{mrole}</strong> çš„è®¢å•æ³¢åŠ¨æœ€å¤§ï¼Œæ”¾å¤§äº† <strong>{ratio}å€</strong>ã€‚</p>",
                eval_p3: "<p class='text-slate-700 font-medium'>è¯·çœ‹å›¾è¡¨å’Œæ–¹å·®æ•°æ®ï¼šæ‚¨çš„å±€éƒ¨å†³ç­–åœ¨å…¨å±€æ¥çœ‹å¯èƒ½å¼•å‘äº†å·¨å¤§çš„éœ‡è¡ã€‚è¿™æ­£æ˜¯ç»å…¸çš„â€œç‰›é­æ•ˆåº”â€ã€‚æ‰“ç ´å®ƒçš„å…³é”®åœ¨äºå®ç°å…¨é“¾è·¯çš„ä¿¡æ¯å…±äº«ï¼Œå¹¶ç¼©çŸ­äº¤è´§ä¸ä¿¡æ¯å»¶è¿Ÿã€‚</p>",
                news_title: "å•†ä¸šå¤´æ¡ï¼š", evt_sport_prep: "å¬è¯´è¿‘æœŸå°†æœ‰å¤§å‹èµ›äº‹ä¸¾åŠï¼Œä¹Ÿè®¸ä¼šå¸¦åŠ¨æ¶ˆè´¹æ°›å›´ã€‚", evt_sport: "èµ›äº‹ç«çƒ­è¿›è¡Œä¸­ï¼Œéœ€æ±‚å‡ºç°æ˜æ˜¾ä¸Šæ¶¨ï¼",
                evt_weather_prep: "æ°”è±¡å°å‘å¸ƒç½•è§å¯’æ½®é¢„è­¦ï¼Œæ³¨æ„é˜²èŒƒã€‚", evt_weather: "å¯’æ½®æ¥è¢­ï¼Œæ¶ˆè´¹è€…å¤§å¹…å‡å°‘å¤–å‡ºã€‚",
                evt_normal: "å¤©æ°”å›æš–ï¼ŒåŸå¸‚æ¢å¤å¾€å¸¸è¿ä½œã€‚", evt_promo_prep: "å¹´åº¦è´­ç‰©ç‹‚æ¬¢èŠ‚å³å°†å¼€å¯ï¼Œå•†å®¶å¼€å§‹å¤‡è´§ã€‚", evt_promo: "ç‹‚æ¬¢èŠ‚å¼•çˆ†ï¼Œéœ€æ±‚å‰§å¢ï¼",
                chat_r1: "å¤§å®¶éƒ½åœ¨å¿™ç€ç†è´§ï¼Œæ²¡äººæœ‰ç©ºç†ä½ ã€‚", chat_r2: "[{up}] å…„å¼Ÿåˆ«å‚¬äº†ï¼ä½ ä¸Šå‘¨çªç„¶è¦é‚£ä¹ˆå¤šï¼Œæˆ‘è¿™é‡Œå…¨ç©ºäº†ï¼ä¸Šæ¸¸æ ¹æœ¬ä¸å‘è´§ï¼", chat_r3: "[{up}] å·²ç»åœ¨è·¯ä¸Šäº†ï¼Œç‰©æµéœ€è¦2å‘¨ï¼Œåˆ«çå«å”¤ï¼", chat_r4: "[{down}] å“¥ä»¬ï¼Œç»ˆç«¯æ ¹æœ¬æ²¡éœ€æ±‚å•Šï¼Œåˆ«é€¼æˆ‘è¿›è´§äº†ï¼Œæˆ‘å¿«ç ´äº§äº†ï¼", chat_r5: "ç³»ç»Ÿè‡ªåŠ¨å›å¤ï¼šè¯·æ ¹æ®æ•°æ®ç†æ€§å†³ç­–ï¼Œæ‹’ç»ææ…Œã€‚",
                months: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"]
            },
            en: {
                app_title: "The Beer Game", setup_title_new: "The Beer Game", setup_desc: "Can you break the curse of the Bullwhip Effect in the fog of information delay?",
                player: "Player:", week: "Week", char_name: "1. Character Name:", story_bg: "2. Story Background (Season):", setup_step2: "3. Select Role:",
                bg_1: "Winter Start (Jan)", bg_4: "Pre-Summer Start (Apr)", bg_7: "Peak Summer Start (Jul)", bg_10: "Autumn Start (Oct)",
                role_ret: "Retailer", role_who: "Wholesaler", role_dis: "Distributor", role_fac: "Factory", role_con: "Consumer", role_sup: "Supplier",
                invalid_order: "Please enter a valid order quantity!",
                btn_start: "Enter Tavern & Start", btn_confirm: "Confirm & Next Week",
                btn_rules: "Rulebook", rules_title: "Basic Rules",
                rule_1_title: "ğŸ¯ Goal", rule_1_desc: "Minimize <strong>Total System Cost</strong> while fulfilling downstream demand. You only control orders to your upstream.",
                rule_2_title: "ğŸ’° Cost Structure", rule_2_1: "<strong>Holding Cost:</strong> {c}1.0 per unit of inventory left at the end of the week.", rule_2_2: "<strong>Backlog Cost:</strong> {c}2.0 per unit of unfilled order. Stockouts punish harder than overstocking!",
                rule_3_title: "â³ Delays", rule_3_desc: "Game lasts <strong>26 weeks</strong>. Orders take <strong>1 week</strong> to reach upstream. Shipments take <strong>2 weeks</strong> to reach your warehouse.",
                rule_4_title: "ğŸ•¹ï¸ Actions", rule_4_desc: "1. Check incoming shipments and orders.<br>2. Watch the News Ticker.<br>3. Chat with partners if needed.<br>4. Submit your order quantity to proceed.",
                info_title: "About The Beer Game", info_p1: "A modern web adaptation of the classic Beer Distribution Game created by MIT Sloan School of Management in the 1960s.", info_p2: "Conceptualized and coded with the assistance of Google Gemini AI.", info_contact: "Feedback or suggestions:",
                ai_note_title: "AI Teammates Ready:", ai_note_desc: "The system has randomly assigned personalities (Aggressive, Sluggish, or Rational) to your 3 AI partners. Note: Max 1 Rational AI. In a real supply chain, you never truly know what your partners are thinking.",
                upstream: "My Upstream", transit_title: "Arriving Soon", transit_1: "Next Wk", transit_2: "In 2 Wks",
                my_dash: "Warehouse & Control", current_role: "Playing As", btn_history: "Inventory Table", curr_inv: "ğŸ“¦ Available Inventory", curr_backlog: "âš ï¸ Severe Backlog",
                cost_inv_label: "Holding: {c}1.0/u", cost_backlog_label: "Backlog: {c}2.0/u",
                order_prompt: "Decision: Order amount to upstream?", btn_submit: "Submit", order_delay_note: "â³ Order Delay: 1 Wk", intransit_order: "In-Transit Orders:",
                downstream: "My Downstream", incoming_order: "New Incoming Order", result_title: "Debrief: Full Chain Bullwhip Effect", result_desc: "God-mode unlocked. Let's see how each node handled the delay and volatility.",
                btn_export: "Export PDF", my_total_cost: "ğŸ§‘â€ğŸ’¼ Your Personal Cost", system_total_cost: "ğŸŒ Total System Cost",
                system_cost_desc: "The total system cost reflects the collective penalty paid by the entire chain.",
                inv_cost_label: "Hold:", backlog_cost_label: "Back:",
                cost_chart_title: "ğŸ“Š Cost Trend (Dual-Axis)", total_cost_label: "Total Cum. Cost", variance_title: "ğŸ“‰ Variance Comparison",
                bullwhip_chart_title: "ğŸ“ˆ Bullwhip Effect Chart", bullwhip_desc: "Compare end demand (dashed) vs orders. Amplification ratio = Bullwhip Index.", history_title: "Inventory Table", btn_restart: "Play Again",
                processing: "Processing Wk", week_suffix: "", anim_loading: "Trucks on the road, orders transmitting...", anim_receive: "Received", anim_ship: "Shipped", anim_order: "Order Placed",
                table_w: "Wk", table_start: "Start", table_in: "+In", table_out: "-Out", table_end: "End", table_backlog: "Backlog", table_order: "Order", table_cost: "Cost",
                grade_title: "Performance Grade", grade_var_lbl: "ğŸ¯ Demand Amplification Ratio: ", grade_cost_lbl: "ğŸ’° System Cost Proportion: ",
                grade_criteria_title: "Criteria: ", grade_c: "C: Otherwise",
                grade_s_fmt: "S: Var < {v}x & Cost < {c}%", grade_a_fmt: "A: Var < {v}x & Cost < {c}%", grade_b_fmt: "B: Var < {v}x & Cost < {c}%",
                bullwhip_comment: "<strong>Chart Insight:</strong> The Bullwhip chart clearly shows how demand is amplified as it travels upstream. Massive peaks in the red Factory line indicate severe overreaction due to delays and panic.",
                cost_comment: "<strong>Chart Insight:</strong> The dual-axis chart reflects your personal cost over time. Due to cumulative backlog, costs often rise exponentially in later stages.",
                variance_comment: "<strong>Data Insight:</strong> Variance ratio quantifies order volatility. Ideally, your ratio should be near or below 1, absorbing shocks rather than amplifying them.",
                eval_title: "ğŸ“‰ Key Insights & Debrief:",
                eval_p1: "<strong class='text-blue-600 block mb-2 text-xl'>Demand Amplification & Delay</strong><p class='mb-2'>You witnessed real seasonal fluctuations. End demand varied slightly (Variance {dvar}), but opacity and delays caused severe misjudgments.</p>",
                eval_p2: "<p class='mb-2'>Across the chain, volatility increased moving upstream. <strong>{mrole}</strong> fluctuated the most, amplifying demand by <strong>{ratio}x</strong>.</p>",
                eval_p3: "<p class='text-slate-700 font-medium'>Look at the charts and variance data: Your local decisions may have caused massive global oscillations. This is the classic Bullwhip Effect. Breaking it requires end-to-end information sharing and reducing lead times.</p>",
                news_title: "Headline:", evt_sport_prep: "Rumors of a big sports event upcoming. Might boost sales.", evt_sport: "Sports event ongoing, demand is surging!",
                evt_weather_prep: "Meteorologists issue a rare cold wave warning.", evt_weather: "Cold wave hits, consumers stay home.",
                evt_normal: "Weather warms up, city returns to normal.", evt_promo_prep: "Annual shopping festival approaches, merchants stocking up.", evt_promo: "Shopping festival explodes, massive demand!",
                chat_r1: "Everyone is busy managing inventory. No time to chat.", chat_r2: "[{up}] Stop rushing me! You ordered a ton last week, I'm empty! Upstream isn't shipping!", chat_r3: "[{up}] It's on the way. Logistics takes 2 weeks, chill out!", chat_r4: "[{down}] Bro, there's no end demand. Stop forcing me to take stock, I'm going bankrupt!", chat_r5: "System Auto-Reply: Please make rational decisions based on data. Refuse panic.",
                months: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
            },
            es: {
                app_title: "Juego de la Cerveza", setup_title_new: "Juego de la Cerveza", setup_desc: "Â¿PodrÃ¡s romper la maldiciÃ³n del Efecto LÃ¡tigo en la niebla del retraso?",
                player: "Jugador:", week: "Semana", char_name: "1. Nombre:", story_bg: "2. Fondo (Estacionalidad):", setup_step2: "3. Selecciona Rol:",
                bg_1: "Inicio Invierno (Ene)", bg_4: "Pre-Verano (Abr)", bg_7: "Pico Verano (Jul)", bg_10: "Inicio OtoÃ±o (Oct)",
                role_ret: "Minorista", role_who: "Mayorista", role_dis: "Distribuidor", role_fac: "FÃ¡brica", role_con: "Consumidor", role_sup: "Proveedor",
                invalid_order: "Â¡Por favor ingrese una cantidad vÃ¡lida!",
                btn_start: "Entrar a la Taberna", btn_confirm: "Confirmar y Siguiente",
                btn_rules: "Reglas", rules_title: "Reglas BÃ¡sicas",
                rule_1_title: "ğŸ¯ Objetivo", rule_1_desc: "Minimiza el <strong>Costo Total del Sistema</strong>. Solo controlas tus pedidos hacia arriba.",
                rule_2_title: "ğŸ’° Costos", rule_2_1: "<strong>Almacenaje:</strong> {c}1.0 por unidad guardada.", rule_2_2: "<strong>Pendientes (Falta):</strong> {c}2.0 por unidad no entregada. Â¡La falta castiga mÃ¡s!",
                rule_3_title: "â³ Retrasos", rule_3_desc: "El juego dura <strong>26 semanas</strong>. Pedidos tardan <strong>1 semana</strong> en llegar. EnvÃ­os tardan <strong>2 semanas</strong> en llegar a ti.",
                rule_4_title: "ğŸ•¹ï¸ Acciones", rule_4_desc: "1. Revisa inventario y pedidos.<br>2. Lee las Noticias.<br>3. Chatea si es necesario.<br>4. EnvÃ­a tu pedido.",
                info_title: "Sobre el Juego", info_p1: "AdaptaciÃ³n web moderna del clÃ¡sico Beer Distribution Game del MIT Sloan (1960s).", info_p2: "Conceptualizado y programado con asistencia de Google Gemini AI.", info_contact: "Comentarios o sugerencias:",
                ai_note_title: "CompaÃ±eros IA Listos:", ai_note_desc: "El sistema asignÃ³ personalidades aleatorias (Agresivo, Lento, Racional) a los 3 IA. Nota: MÃ¡x 1 Racional. En la realidad, nunca sabes quÃ© piensan tus socios.",
                upstream: "Mi Proveedor", transit_title: "Llegando Pronto", transit_1: "PrÃ³x. Sem", transit_2: "En 2 Sem",
                my_dash: "AlmacÃ©n y Control", current_role: "Jugando como", btn_history: "Tabla de Inventario", curr_inv: "ğŸ“¦ Inventario Disponible", curr_backlog: "âš ï¸ Falta Severa",
                cost_inv_label: "AlmacÃ©n: {c}1.0/u", cost_backlog_label: "Falta: {c}2.0/u",
                order_prompt: "DecisiÃ³n: Â¿CuÃ¡nto pedir arriba?", btn_submit: "Enviar", order_delay_note: "â³ Retraso: 1 Sem", intransit_order: "Pedidos en trÃ¡nsito:",
                downstream: "Mi Demanda", incoming_order: "Nuevo Pedido", result_title: "AnÃ¡lisis: Efecto LÃ¡tigo en la Cadena", result_desc: "Modo Dios. Mira cÃ³mo cada nodo manejÃ³ el retraso.",
                btn_export: "Exportar PDF", my_total_cost: "ğŸ§‘â€ğŸ’¼ Tu Costo Personal", system_total_cost: "ğŸŒ Costo Total del Sistema",
                system_cost_desc: "El costo total del sistema refleja la penalizaciÃ³n colectiva pagada por toda la cadena.",
                inv_cost_label: "Alm:", backlog_cost_label: "Falta:",
                cost_chart_title: "ğŸ“Š Tendencia de Costos (Doble Eje)", total_cost_label: "Costo Total Acum.", variance_title: "ğŸ“‰ ComparaciÃ³n de Varianza",
                bullwhip_chart_title: "ğŸ“ˆ Efecto LÃ¡tigo", bullwhip_desc: "Compara demanda final (lÃ­nea) vs pedidos. AmplificaciÃ³n = Ãndice LÃ¡tigo.", history_title: "Tabla de Inventario", btn_restart: "Jugar de Nuevo",
                processing: "Proc. Sem", week_suffix: "", anim_loading: "Camiones en ruta, pedidos en camino...", anim_receive: "Recibido", anim_ship: "Enviado", anim_order: "Pedido Enviado",
                table_w: "Sem", table_start: "Inicio", table_in: "+Entra", table_out: "-Sale", table_end: "Final", table_backlog: "Falta", table_order: "Pedido", table_cost: "Costo",
                grade_title: "CalificaciÃ³n", grade_var_lbl: "ğŸ¯ AmplificaciÃ³n Demanda: ", grade_cost_lbl: "ğŸ’° ProporciÃ³n Costo: ",
                grade_criteria_title: "Criterios: ", grade_c: "C: Otros",
                grade_s_fmt: "S: Var < {v}x y Costo < {c}%", grade_a_fmt: "A: Var < {v}x y Costo < {c}%", grade_b_fmt: "B: Var < {v}x y Costo < {c}%",
                bullwhip_comment: "<strong>Comentario:</strong> El grÃ¡fico de LÃ¡tigo muestra cÃ³mo la demanda se amplifica aguas arriba. Picos masivos en la lÃ­nea roja indican reacciones exageradas por retrasos.",
                cost_comment: "<strong>Comentario:</strong> El grÃ¡fico de doble eje refleja su costo personal. Debido a los pedidos pendientes, los costos suelen aumentar exponencialmente.",
                variance_comment: "<strong>Comentario:</strong> La varianza cuantifica la volatilidad. Idealmente, su proporciÃ³n deberÃ­a ser < 1, absorbiendo impactos en lugar de amplificarlos.",
                eval_title: "ğŸ“‰ Perspectivas Clave:",
                eval_p1: "<strong class='text-blue-600 block mb-2 text-xl'>AmplificaciÃ³n y Retraso</strong><p class='mb-2'>Viste fluctuaciones reales. La demanda variÃ³ poco (Varianza {dvar}), pero la opacidad y retrasos causaron graves errores.</p>",
                eval_p2: "<p class='mb-2'>En la cadena, la volatilidad aumentÃ³ aguas arriba. <strong>{mrole}</strong> amplificÃ³ mÃ¡s la demanda en <strong>{ratio}x</strong>.</p>",
                eval_p3: "<p class='text-slate-700 font-medium'>Mira los grÃ¡ficos y la varianza: Tus decisiones locales causaron oscilaciones globales. Este es el clÃ¡sico Efecto LÃ¡tigo. Romperlo requiere compartir informaciÃ³n y reducir tiempos de entrega.</p>",
                news_title: "Titular:", evt_sport_prep: "Rumores de un gran evento deportivo. PodrÃ­a subir ventas.", evt_sport: "Evento activo, Â¡la demanda aumenta!",
                evt_weather_prep: "Alerta de ola de frÃ­o severa.", evt_weather: "Ola de frÃ­o, consumidores en casa.",
                evt_normal: "El clima mejora, la ciudad vuelve a la normalidad.", evt_promo_prep: "Festival de compras se acerca, comercios se preparan.", evt_promo: "Â¡Festival explota, demanda masiva!",
                chat_r1: "Todos estÃ¡n ocupados. No hay tiempo para chatear.", chat_r2: "[{up}] Â¡No me presiones! Â¡Pediste mucho la semana pasada, estoy vacÃ­o! Â¡Arriba no envÃ­an!", chat_r3: "[{up}] EstÃ¡ en camino. Tarda 2 semanas, Â¡cÃ¡lmate!", chat_r4: "[{down}] Amigo, no hay demanda. Â¡No me obligues a recibir, voy a quebrar!", chat_r5: "Respuesta del Sistema: Toma decisiones racionales con datos. Rechaza el pÃ¡nico.",
                months: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]
            }
        };

        const TEMP_MAP = {1:2, 2:5, 3:12, 4:18, 5:24, 6:28, 7:32, 8:30, 9:25, 10:18, 11:10, 12:4};

        // è¯„çº§é˜ˆå€¼è¡¨ (æŒ‰è§’è‰²éš¾åº¦åˆ’åˆ†)
        const GRADE_THRESHOLDS = {
            retailer: { S: { var: 1.5, cost: 10 }, A: { var: 3, cost: 15 }, B: { var: 5, cost: 20 } },
            wholesaler: { S: { var: 2.0, cost: 15 }, A: { var: 4, cost: 20 }, B: { var: 7, cost: 25 } },
            distributor: { S: { var: 2.5, cost: 20 }, A: { var: 5, cost: 25 }, B: { var: 9, cost: 30 } },
            factory: { S: { var: 3.5, cost: 25 }, A: { var: 7, cost: 30 }, B: { var: 12, cost: 35 } }
        };

        let currentLang = 'zh';
        function c() { return { zh: 'Â¥', en: '$', es: 'â‚¬' }[currentLang]; }
        function t(key) { 
            let val = DICT[currentLang][key];
            return val !== undefined ? val : key; 
        }

        function setLanguage(lang, flag) {
            currentLang = lang;
            document.getElementById('current-flag').innerText = flag;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                let key = el.getAttribute('data-i18n');
                let translated = t(key).replace(/{c}/g, c());
                if (el.tagName === 'INPUT' && el.type === 'text') { el.placeholder = translated; } else { el.innerHTML = translated; }
            });
            document.querySelectorAll('.curr-symbol').forEach(el => el.innerText = c());
            
            const select = document.getElementById('input-start-month');
            const val = select.value;
            select.options[0].text = t('bg_1'); select.options[1].text = t('bg_4');
            select.options[2].text = t('bg_7'); select.options[3].text = t('bg_10');
            select.value = val;

            renderRoleSelector();
            document.getElementById('lang-dropdown').classList.remove('active');
        }

        // --- Modals & Dropdowns ---
        function toggleDropdown(e, id) { e.stopPropagation(); document.getElementById(id).classList.toggle('active'); }
        function closeDropdowns(e) { if(!e.target.closest('.relative')) { document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active')); } }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        
        function toggleChat() {
            const widget = document.getElementById('chat-widget');
            if (widget.classList.contains('hidden')) {
                widget.classList.remove('hidden');
                widget.classList.add('flex');
                document.getElementById('chat-badge').classList.add('hidden');
                const chatBox = document.getElementById('chat-history');
                chatBox.scrollTop = chatBox.scrollHeight;
            } else {
                widget.classList.add('hidden');
                widget.classList.remove('flex');
            }
        }

        // --- å®¹é”™éŸ³æ•ˆå¼•æ“ (é˜²æ‹¦æˆª) ---
        let audioCtx;
        function initAudio() {
            if (!audioCtx) {
                try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } 
                catch(e) { console.warn("Audio not supported"); }
            }
        }
        function playTone(freq, type, duration, vol=0.1) {
            try {
                initAudio(); if(!audioCtx) return;
                if(audioCtx.state === 'suspended') audioCtx.resume();
                let osc = audioCtx.createOscillator(); let gain = audioCtx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + duration);
            } catch(e) {}
        }
        function playClick() { playTone(600, 'sine', 0.1, 0.05); }
        function playError() { playTone(150, 'sawtooth', 0.4, 0.1); }
        function playClink() { playTone(1200, 'sine', 0.5, 0.1); setTimeout(()=>playTone(1400, 'sine', 0.5, 0.1), 50); }

        // --- æ ¸å¿ƒé…ç½® ---
        const CONFIG = { maxWeeks: 26, costInv: 1.0, costBacklog: 2.0, initialInv: 12, initialOrder: 4, roles: ['retailer', 'wholesaler', 'distributor', 'factory'] };
        const MONTHLY_BASE = { 1:3, 2:3, 3:4, 4:5, 5:6, 6:8, 7:12, 8:10, 9:6, 10:4, 11:3, 12:4 };
        const EVENTS = [
            { start: 4, end: 4, effect: 0, key: "evt_sport_prep" }, { start: 5, end: 10, effect: 4, key: "evt_sport" },
            { start: 17, end: 17, effect: 0, key: "evt_weather_prep" }, { start: 18, end: 19, effect: -2, key: "evt_weather" },
            { start: 20, end: 20, effect: 0, key: "evt_normal" }, { start: 22, end: 22, effect: 0, key: "evt_promo_prep" },
            { start: 23, end: 24, effect: 8, key: "evt_promo" }
        ];

        let state = {
            playerName: '', userRole: 'retailer', aiSettings: {}, week: 1, startMonth: 1,
            myTotalCost: 0, myTotalInvCost: 0, myTotalBacklogCost: 0, lastWeekCost: 0, systemTotalCost: 0,
            nodes: {}, myHistoryLog: [], 
            chartData: { labels: [], demand: [], periodCosts: [], cumCosts: [], orders: { retailer: [], wholesaler: [], distributor: [], factory: [] } },
            tempTurnData: null, currentEventKey: null,
            demandSchedule: {} 
        };

        function getRoleName(r) { return t('role_' + r.substring(0,3)); }

        window.onload = function() { setLanguage('zh', 'ğŸ‡¨ğŸ‡³'); };

        function renderRoleSelector() {
            const icons = ['ğŸª', 'ğŸ¢', 'ğŸš›', 'ğŸ­'];
            document.querySelectorAll('input[name="role"]').forEach((r, i) => {
                r.nextElementSibling.querySelector('div:last-child').innerText = getRoleName(r.value);
            });
        }
        function updateSelectedRole(val) { state.userRole = val; }

        function assignRandomAI() {
            let roles = CONFIG.roles.filter(r => r !== state.userRole);
            let assigned = {}; let rationalCount = 0;
            roles.forEach(role => {
                let avail = rationalCount >= 1 ? ['aggressive', 'sluggish'] : ['aggressive', 'sluggish', 'rational'];
                let chosen = avail[Math.floor(Math.random() * avail.length)];
                if (chosen === 'rational') rationalCount++;
                assigned[role] = chosen;
            });
            state.aiSettings = assigned;
        }

        function startIntroAnimation() {
            const nameInput = document.getElementById('input-player-name').value.trim();
            if (!nameInput) { alert(t('invalid_order') || "Please enter your name!"); return; }
            state.playerName = nameInput;
            state.userRole = document.querySelector('input[name="role"]:checked').value;
            state.startMonth = parseInt(document.getElementById('input-start-month').value) || 1;
            
            assignRandomAI();
            initAudio(); 

            document.getElementById('lang-wrapper').classList.add('hidden');
            document.getElementById('screen-setup').classList.add('hidden');
            
            const intro = document.getElementById('screen-intro');
            const cdText = document.getElementById('countdown-text');
            const clink = document.getElementById('clink-emoji');
            intro.classList.remove('hidden');
            
            let cnt = 3; cdText.innerText = cnt; playClick();
            let iv = setInterval(() => {
                cnt--;
                if (cnt > 0) { cdText.innerText = cnt; playClick(); } 
                else if (cnt === 0) {
                    clearInterval(iv); cdText.classList.add('hidden');
                    clink.classList.remove('hidden'); clink.classList.add('animate-clink');
                    playClink();
                    setTimeout(() => { intro.classList.add('hidden'); initGameEngine(); }, 1200);
                }
            }, 800);
        }

        function initGameEngine() {
            state.demandSchedule = {};
            for(let w = 1; w <= CONFIG.maxWeeks + 2; w++) {
                let m = ((state.startMonth - 1 + Math.floor((w - 1) / 4)) % 12) + 1;
                let d = MONTHLY_BASE[m] + (Math.floor(Math.random() * 3) - 1);
                let evt = EVENTS.find(e => w >= e.start && w <= e.end);
                if (evt) d += evt.effect;
                state.demandSchedule[w] = Math.max(0, d);
            }

            CONFIG.roles.forEach(role => {
                state.nodes[role] = { inv: CONFIG.initialInv, backlog: 0, incomingShipmentQueue: [CONFIG.initialOrder, CONFIG.initialOrder], incomingOrderQueue: [CONFIG.initialOrder], lastOrderPlaced: CONFIG.initialOrder, inTransitOrderVisible: CONFIG.initialOrder };
            });
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('header-status').classList.remove('hidden');
            document.getElementById('header-status').classList.add('flex');
            document.getElementById('chat-toggle-btn').classList.remove('hidden');
            document.getElementById('chat-toggle-btn').classList.add('flex');
            document.getElementById('ui-player-name').innerText = state.playerName;
            setupDashboardLabels(); updateDashboardUI();
        }

        function getDemandForWeek(week) {
            return state.demandSchedule[week] || CONFIG.baseDemand;
        }

        function setupDashboardLabels() {
            document.getElementById('ui-my-role-name').innerText = getRoleName(state.userRole);
            let idx = CONFIG.roles.indexOf(state.userRole);
            document.getElementById('ui-downstream-name').innerText = idx === 0 ? t('role_con') : getRoleName(CONFIG.roles[idx-1]);
            document.getElementById('ui-upstream-name').innerText = idx === CONFIG.roles.length - 1 ? t('role_sup') : getRoleName(CONFIG.roles[idx+1]);
        }

        function updateDashboardUI() {
            document.getElementById('ui-week-counter').innerText = state.week;
            
            // æ›´æ–°æœˆä»½å’Œæ¸©åº¦
            let currentMonth = ((state.startMonth - 1 + Math.floor((state.week - 1) / 4)) % 12) + 1;
            let currentTemp = TEMP_MAP[currentMonth];
            document.getElementById('ui-month-display').innerText = DICT[currentLang].months[currentMonth - 1];
            document.getElementById('ui-temp-display').innerText = currentTemp + "Â°C";

            // æ»šåŠ¨æ–°é—»å¤„ç†
            const banner = document.getElementById('event-banner');
            let evt = EVENTS.find(e => state.week >= e.start && state.week <= e.end);
            if (evt) {
                const descEl = document.getElementById('event-desc');
                if (state.currentEventKey !== evt.key) {
                    descEl.innerText = t(evt.key);
                    banner.classList.remove('hidden');
                    state.currentEventKey = evt.key;
                    
                    // é‡ç½®CSSåŠ¨ç”»ç¡®ä¿ä»å³ä¾§é‡æ–°è¿›å…¥
                    descEl.style.animation = 'none';
                    void descEl.offsetWidth; 
                    descEl.style.animation = null; 
                }
            } else if (state.currentEventKey !== null) {
                banner.classList.add('hidden');
                state.currentEventKey = null;
            }

            let myNode = state.nodes[state.userRole];

            const invBox = document.getElementById('inv-box'); const blBox = document.getElementById('backlog-box');
            if (myNode.backlog > 0) {
                blBox.classList.add('border-red-500', 'bg-flash-danger');
            } else { blBox.classList.remove('border-red-500', 'bg-flash-danger'); }

            if (myNode.inv > 30) { invBox.classList.add('border-amber-500', 'bg-amber-100'); }
            else { invBox.classList.remove('border-amber-500', 'bg-amber-100'); }

            document.getElementById('ui-my-inventory').innerText = myNode.inv;
            document.getElementById('ui-my-backlog').innerText = myNode.backlog;
            document.getElementById('ui-cost-inv').innerText = (myNode.inv * CONFIG.costInv).toFixed(1);
            document.getElementById('ui-cost-backlog').innerText = (myNode.backlog * CONFIG.costBacklog).toFixed(1);

            document.getElementById('ui-transit-1').innerText = myNode.incomingShipmentQueue[0] || 0;
            document.getElementById('ui-transit-2').innerText = myNode.incomingShipmentQueue[1] || 0;
            document.getElementById('ui-intransit-order').innerText = myNode.inTransitOrderVisible;
            document.getElementById('ui-incoming-order').innerText = state.userRole === 'retailer' ? getDemandForWeek(state.week) : myNode.incomingOrderQueue[0];
            document.getElementById('ui-order-input').value = myNode.lastOrderPlaced;
        }

        function appendChat(sender, msg) {
            const chatBox = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `p-3 text-sm shadow-sm w-[85%] ${sender==='me' ? 'chat-bubble-me ml-auto' : 'chat-bubble-sys mr-auto'}`;
            div.innerHTML = `<strong>${sender==='me'?t('chat_me'): t('chat_sys')}:</strong><br>${msg}`;
            chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim(); if(!msg) return;
            appendChat('me', msg); input.value = '';
            
            setTimeout(() => {
                let myNode = state.nodes[state.userRole]; let idx = CONFIG.roles.indexOf(state.userRole);
                let upRole = idx < 3 ? CONFIG.roles[idx+1] : null; let downRole = idx > 0 ? CONFIG.roles[idx-1] : null;
                
                let reply = t('chat_r1');
                if (myNode.backlog > 0 && upRole) {
                    if (state.nodes[upRole].backlog > 10) reply = t('chat_r2').replace('{up}', getRoleName(upRole));
                    else if (state.nodes[upRole].inv > 0) reply = t('chat_r3').replace('{up}', getRoleName(upRole));
                } else if (myNode.inv > 30 && downRole) {
                    reply = t('chat_r4').replace('{down}', getRoleName(downRole));
                } else if (msg.length > 5) {
                    reply = t('chat_r5');
                }
                appendChat('sys', reply); 
                playClick();

                if (document.getElementById('chat-widget').classList.contains('hidden')) {
                    document.getElementById('chat-badge').classList.remove('hidden');
                }
            }, 1000 + Math.random()*1000);
        }

        function calcAIOrder(role, incomingDemand) {
            let node = state.nodes[role];
            let behavior = state.aiSettings[role];
            let gap = CONFIG.initialInv - (node.inv - node.backlog);
            let pipeline = node.incomingShipmentQueue.reduce((a, b) => a + b, 0);
            
            let rawOrder = 0;
            if (behavior === 'rational') {
                rawOrder = incomingDemand + (gap * 0.5) - pipeline;
            } else if (behavior === 'aggressive') {
                rawOrder = incomingDemand + (gap * 1.5);
                if (node.backlog > 0) rawOrder += 5;
            } else {
                if (node.backlog > 5) rawOrder = incomingDemand + gap * 2;
                else rawOrder = incomingDemand * 0.8;
            }
            return Math.max(0, Math.round(rawOrder));
        }

        function triggerTurnProcess() {
            let order = parseInt(document.getElementById('ui-order-input').value);
            if (isNaN(order) || order < 0) {
                alert(t('invalid_order'));
                return;
            }
            
            state.tempTurnData = { order }; playClick();
            
            document.getElementById('anim-week').innerText = state.week;
            const overlay = document.getElementById('processing-overlay');
            const btn = document.getElementById('btn-confirm-turn');
            const s1 = document.getElementById('anim-step-1'); const s2 = document.getElementById('anim-step-2'); const s3 = document.getElementById('anim-step-3');
            
            let arrivingThisWeek = state.nodes[state.userRole].incomingShipmentQueue[0];
            let currentDemand = state.userRole === 'retailer' ? getDemandForWeek(state.week) : state.nodes[state.userRole].incomingOrderQueue[0];
            
            document.getElementById('anim-val-1').innerText = arrivingThisWeek;
            document.getElementById('anim-val-2').innerText = Math.min(state.nodes[state.userRole].inv + arrivingThisWeek, currentDemand + state.nodes[state.userRole].backlog);
            document.getElementById('anim-val-3').innerText = order;

            s1.className = 'step-hidden flex items-center justify-between text-green-600 bg-green-50 p-4 rounded-xl border border-green-100';
            s2.className = 'step-hidden flex items-center justify-between text-orange-600 bg-orange-50 p-4 rounded-xl border border-orange-100';
            s3.className = 'step-hidden flex items-center justify-between text-purple-600 bg-purple-50 p-4 rounded-xl border border-purple-100';
            
            btn.classList.add('hidden'); overlay.classList.remove('hidden');

            setTimeout(() => { s1.classList.replace('step-hidden', 'step-visible'); }, 300);
            setTimeout(() => { s2.classList.replace('step-hidden', 'step-visible'); }, 900);
            setTimeout(() => { s3.classList.replace('step-hidden', 'step-visible'); }, 1500);
            setTimeout(() => { btn.classList.remove('hidden'); }, 2000);
        }

        function finalizeTurn() {
            document.getElementById('processing-overlay').classList.add('hidden');
            let order = state.tempTurnData.order; state.tempTurnData = null;

            let demand = getDemandForWeek(state.week);
            let startStates = {}; CONFIG.roles.forEach(r => startStates[r] = { inv: state.nodes[r].inv, backlog: state.nodes[r].backlog });

            let inOrders = {}; CONFIG.roles.forEach(r => inOrders[r] = r === 'retailer' ? demand : state.nodes[r].incomingOrderQueue.shift());
            let arriving = {}; CONFIG.roles.forEach(r => { arriving[r] = state.nodes[r].incomingShipmentQueue.shift(); state.nodes[r].inv += arriving[r]; });
            
            let shipped = {};
            CONFIG.roles.forEach(r => {
                let need = inOrders[r] + state.nodes[r].backlog;
                let s = Math.min(state.nodes[r].inv, need);
                state.nodes[r].inv -= s; state.nodes[r].backlog = need - s; shipped[r] = s;
            });

            let placed = {};
            CONFIG.roles.forEach(r => {
                if (r === state.userRole) { placed[r] = order; state.nodes[r].inTransitOrderVisible = order; } 
                else { placed[r] = calcAIOrder(r, inOrders[r]); }
                state.nodes[r].lastOrderPlaced = placed[r];
            });

            state.nodes.distributor.incomingShipmentQueue.push(shipped.factory);
            state.nodes.wholesaler.incomingShipmentQueue.push(shipped.distributor);
            state.nodes.retailer.incomingShipmentQueue.push(shipped.wholesaler);
            state.nodes.factory.incomingShipmentQueue.push(placed.factory); 

            state.nodes.wholesaler.incomingOrderQueue.push(placed.retailer);
            state.nodes.distributor.incomingOrderQueue.push(placed.wholesaler);
            state.nodes.factory.incomingOrderQueue.push(placed.distributor);

            let sysCost = 0;
            let myTurnCost = 0;
            CONFIG.roles.forEach(r => {
                let n = state.nodes[r]; let c = (n.inv * CONFIG.costInv) + (n.backlog * CONFIG.costBacklog);
                sysCost += c;
                if(r === state.userRole) { 
                    myTurnCost = c;
                    state.lastWeekCost = c; 
                    state.myTotalInvCost += n.inv * CONFIG.costInv; 
                    state.myTotalBacklogCost += n.backlog * CONFIG.costBacklog; 
                    state.myTotalCost += c; 
                }
            });
            state.systemTotalCost += sysCost;

            state.myHistoryLog.push({ week: state.week, startInv: startStates[state.userRole].inv, received: arriving[state.userRole], shipped: shipped[state.userRole], endInv: state.nodes[state.userRole].inv, backlog: state.nodes[state.userRole].backlog, orderPlaced: placed[state.userRole], cost: state.lastWeekCost });
            buildTable();

            state.chartData.labels.push(`W${state.week}`); 
            state.chartData.demand.push(demand);
            state.chartData.periodCosts.push(myTurnCost);
            state.chartData.cumCosts.push(state.myTotalCost);
            CONFIG.roles.forEach(r => state.chartData.orders[r].push(placed[r]));

            state.week++;
            if (state.week > CONFIG.maxWeeks) endGame(); else updateDashboardUI();
        }

        function buildTable() {
            let html = `<thead class="bg-slate-200 text-sm font-bold text-slate-800"><tr><th class="py-3 px-2">${t('table_w')}</th><th class="px-2">${t('table_start')}</th><th class="text-green-700 px-2">${t('table_in')}</th><th class="text-orange-700 px-2">${t('table_out')}</th><th class="bg-slate-300 px-2">${t('table_end')}</th><th class="text-red-700 px-2">${t('table_backlog')}</th><th class="text-blue-700 px-2">${t('table_order')}</th><th class="px-2">${t('table_cost')}</th></tr></thead><tbody class="divide-y font-mono text-sm text-slate-900 bg-white">`;
            [...state.myHistoryLog].reverse().forEach(r => {
                html += `<tr><td class="py-2 font-bold">W${r.week}</td><td class="font-medium">${r.startInv}</td><td class="text-green-600 font-bold">+${r.received}</td><td class="text-orange-600 font-bold">-${r.shipped}</td><td class="bg-slate-50 font-black">${r.endInv}</td><td class="text-red-600 font-bold">${r.backlog}</td><td class="text-blue-600 font-bold">${r.orderPlaced}</td><td class="font-bold">${c()}${r.cost}</td></tr>`;
            });
            html += `</tbody>`;
            document.getElementById('main-history-table').innerHTML = html;
            
            let pdfHtml = `<thead class="bg-slate-200 text-sm font-bold text-slate-800"><tr><th class="py-3 px-2">${t('table_w')}</th><th class="px-2">${t('table_start')}</th><th class="text-green-700 px-2">${t('table_in')}</th><th class="text-orange-700 px-2">${t('table_out')}</th><th class="bg-slate-300 px-2">${t('table_end')}</th><th class="text-red-700 px-2">${t('table_backlog')}</th><th class="text-blue-700 px-2">${t('table_order')}</th><th class="px-2">${t('table_cost')}</th></tr></thead><tbody class="divide-y font-mono text-sm text-slate-900 bg-white">`;
            state.myHistoryLog.forEach(r => {
                pdfHtml += `<tr><td class="py-2 font-bold">W${r.week}</td><td class="font-medium">${r.startInv}</td><td class="text-green-600 font-bold">+${r.received}</td><td class="text-orange-600 font-bold">-${r.shipped}</td><td class="bg-slate-50 font-black">${r.endInv}</td><td class="text-red-600 font-bold">${r.backlog}</td><td class="text-blue-600 font-bold">${r.orderPlaced}</td><td class="font-bold">${c()}${r.cost}</td></tr>`;
            });
            pdfHtml += `</tbody>`;
            document.getElementById('pdf-history-content').innerHTML = `<table class="w-full text-center border-collapse border border-slate-300">${pdfHtml}</table>`;
        }

        function calcVar(arr) { let m=arr.reduce((a,b)=>a+b,0)/arr.length; return arr.map(v=>Math.pow(v-m,2)).reduce((a,b)=>a+b,0)/arr.length; }

        function endGame() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('event-banner').classList.add('hidden');
            document.getElementById('chat-toggle-btn').classList.add('hidden');
            document.getElementById('chat-widget').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('hidden');
            
            document.getElementById('final-cost').innerText = state.myTotalCost.toFixed(0);
            document.getElementById('final-cost-inv').innerText = state.myTotalInvCost.toFixed(0);
            document.getElementById('final-cost-backlog').innerText = state.myTotalBacklogCost.toFixed(0);
            document.getElementById('final-system-cost').innerText = state.systemTotalCost.toFixed(0);

            const dVar = calcVar(state.chartData.demand);
            let vars = {}; CONFIG.roles.forEach(r => vars[r] = calcVar(state.chartData.orders[r]));
            let mRole = Object.keys(vars).reduce((a, b) => vars[a] > vars[b] ? a : b);

            // åŠ¨æ€è§’è‰²éš¾åº¦è¯„çº§è®¡ç®—
            let userVRatio = dVar === 0 ? 1 : vars[state.userRole] / dVar;
            let costRatio = state.systemTotalCost > 0 ? (state.myTotalCost / state.systemTotalCost * 100) : 0;
            
            let thresh = GRADE_THRESHOLDS[state.userRole];
            let grade = 'C';
            if (userVRatio < thresh.S.var && costRatio < thresh.S.cost) grade = 'S';
            else if (userVRatio < thresh.A.var && costRatio < thresh.A.cost) grade = 'A';
            else if (userVRatio < thresh.B.var && costRatio < thresh.B.cost) grade = 'B';

            document.getElementById('final-grade').innerText = grade;
            document.getElementById('grade-var-ratio').innerText = userVRatio.toFixed(1) + "x";
            document.getElementById('grade-cost-ratio').innerText = costRatio.toFixed(1) + "%";

            // åŠ¨æ€æ˜¾ç¤ºé’ˆå¯¹è¯¥è§’è‰²çš„è¯„ä»·æ ‡å‡†
            document.getElementById('ui-grade-s').innerText = t('grade_s_fmt').replace('{v}', thresh.S.var.toFixed(1)).replace('{c}', thresh.S.cost);
            document.getElementById('ui-grade-a').innerText = t('grade_a_fmt').replace('{v}', thresh.A.var.toFixed(1)).replace('{c}', thresh.A.cost);
            document.getElementById('ui-grade-b').innerText = t('grade_b_fmt').replace('{v}', thresh.B.var.toFixed(1)).replace('{c}', thresh.B.cost);

            const varContainer = document.getElementById('variance-cards-container');
            varContainer.innerHTML = '';
            CONFIG.roles.forEach(r => {
                let vRatio = dVar === 0 ? 1 : vars[r] / dVar;
                let isMe = r === state.userRole;
                varContainer.innerHTML += `
                    <div class="p-3 rounded-lg border ${isMe ? 'bg-blue-600 text-white border-blue-700' : 'bg-white border-blue-200 text-blue-900'} text-center shadow-sm">
                        <div class="text-xs font-bold uppercase mb-1 ${isMe ? 'text-blue-200' : 'text-slate-400'}">${getRoleName(r)}</div>
                        <div class="text-2xl font-black">${vRatio.toFixed(2)}x</div>
                    </div>`;
            });
            
            let evalTxt = t('eval_p1').replace('{dvar}', dVar.toFixed(1));
            evalTxt += t('eval_p2').replace('{mrole}', getRoleName(mRole)).replace('{ratio}', (dVar===0?0:(vars[mRole]/dVar)).toFixed(1));
            evalTxt += t('eval_p3');
            document.getElementById('variance-evaluation').innerHTML = evalTxt;

            // æ¸²æŸ“å›¾è¡¨
            const costCtx = document.getElementById('costChart').getContext('2d');
            new Chart(costCtx, {
                type: 'bar',
                data: { labels: state.chartData.labels, datasets: [
                        { type: 'line', label: t('total_cost_label'), data: state.chartData.cumCosts, yAxisID: 'y1', borderColor: '#ef4444', backgroundColor: '#ef4444', borderWidth: 2, tension: 0.1 },
                        { type: 'bar', label: t('table_cost'), data: state.chartData.periodCosts, yAxisID: 'y', backgroundColor: '#94a3b8' }
                ]},
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: { x: { grid: { display: false } }, y: { type: 'linear', display: true, position: 'left' }, y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } } }
                }
            });

            const bullwhipCtx = document.getElementById('bullwhipChart').getContext('2d');
            const datasets = [
                { label: t('role_con'), data: state.chartData.demand, borderColor: '#1f2937', borderDash: [5, 5], borderWidth: 3 },
                { label: getRoleName('retailer'), data: state.chartData.orders.retailer, borderColor: '#3b82f6', borderWidth: state.userRole==='retailer'?4:2 },
                { label: getRoleName('wholesaler'), data: state.chartData.orders.wholesaler, borderColor: '#10b981', borderWidth: state.userRole==='wholesaler'?4:2 },
                { label: getRoleName('distributor'), data: state.chartData.orders.distributor, borderColor: '#8b5cf6', borderWidth: state.userRole==='distributor'?4:2 },
                { label: getRoleName('factory'), data: state.chartData.orders.factory, borderColor: '#ef4444', backgroundColor:'rgba(239,68,68,0.1)', fill:true, borderWidth: state.userRole==='factory'?4:2 }
            ];
            new Chart(bullwhipCtx, {
                type: 'line',
                data: { labels: state.chartData.labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function exportToPDF() {
            const btn = document.getElementById('btn-export');
            btn.innerHTML = '...'; btn.disabled = true;
            document.getElementById('pdf-history-table').classList.remove('hidden');
            
            setTimeout(() => {
                html2pdf().set({ margin: 10, filename: `BeerGame_${state.playerName}.pdf` }).from(document.getElementById('pdf-content-wrapper')).save().then(() => {
                    btn.innerHTML = `ğŸ“¥ ${t('btn_export')}`; btn.disabled = false;
                    document.getElementById('pdf-history-table').classList.add('hidden');
                });
            }, 300);
        }
    </script>
</body>
</html>