<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•¤é…’æ¸¸æˆ æ——èˆ°ç‰ˆ - ä¾›åº”é“¾æ²™ç›˜</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .chart-container { position: relative; width: 100%; height: 350px; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        
        @keyframes pulseAlert { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .event-alert { animation: pulseAlert 2.5s infinite; }

        .step-hidden { opacity: 0; transform: translateX(-20px); transition: all 0.5s ease; }
        .step-visible { opacity: 1; transform: translateX(0); }

        #event-banner {
            transition: max-height 0.6s ease-in-out, opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            max-height: 0;
            opacity: 0;
            transform: translateY(-20px);
            overflow: hidden;
            border-bottom-width: 0;
        }
        #event-banner.active {
            max-height: 100px;
            opacity: 1;
            transform: translateY(0);
            border-bottom-width: 1px;
        }

        .hidden { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-slate-900 text-white shadow-md z-10 sticky top-0">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ğŸº</span>
                <h1 class="text-lg font-bold tracking-widest" data-i18n="app_title">BEER GAME PRO</h1>
            </div>
            
            <div id="lang-selector" class="flex gap-2 text-sm">
                <button onclick="setLanguage('zh')" class="lang-btn px-2 py-1 rounded bg-blue-600 text-white font-bold transition-colors">ä¸­æ–‡</button>
                <button onclick="setLanguage('en')" class="lang-btn px-2 py-1 rounded bg-slate-800 text-slate-400 hover:text-white transition-colors">EN</button>
                <button onclick="setLanguage('es')" class="lang-btn px-2 py-1 rounded bg-slate-800 text-slate-400 hover:text-white transition-colors">ES</button>
            </div>

            <div id="header-status" class="hidden flex items-center gap-4 md:gap-6 text-xs md:text-sm">
                <div class="flex items-center gap-1">
                    <span class="text-slate-400" data-i18n="player">ç©å®¶:</span>
                    <span id="ui-player-name" class="font-bold text-amber-400 tracking-wide">--</span>
                </div>
                <div class="bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700 shadow-inner">
                    <span data-i18n="week">å‘¨æ¬¡</span> <span id="ui-week-counter" class="text-blue-400 font-bold text-lg mx-1">1</span> / 36
                </div>
            </div>
        </div>
    </header>

    <!-- Animated Event Banner -->
    <div id="event-banner" class="bg-amber-50 border-amber-200 text-amber-900 px-4 py-3 shadow-sm relative z-0">
        <div class="max-w-6xl mx-auto flex items-center gap-3">
            <span class="text-2xl event-alert">ğŸ“°</span>
            <div>
                <strong id="event-title" class="font-black text-amber-800 tracking-wide" data-i18n="news_title">å•†ä¸šè§†ç‚¹</strong>
                <div id="event-desc" class="text-sm font-medium text-amber-900 mt-0.5"></div>
            </div>
        </div>
    </div>

    <main class="flex-grow w-full max-w-6xl mx-auto px-4 py-8 relative">

        <!-- SCREEN 1: SETUP -->
        <div id="screen-setup" class="slide-in max-w-3xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-8 text-white text-center">
                <h2 class="text-3xl font-black mb-2 tracking-wide" data-i18n="setup_title">ä¾›åº”é“¾æ²™ç›˜æ¨¡æ‹Ÿ</h2>
                <p class="text-slate-300 text-sm" data-i18n="setup_desc">è®¾å®šæ‚¨çš„èº«ä»½å¹¶é…ç½®å„èŠ‚ç‚¹çš„ AI è¡Œä¸ºæ¨¡å¼</p>
            </div>
            
            <div class="p-8 space-y-8">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2" data-i18n="setup_step1">1. ç©å®¶ç½²åï¼š</label>
                    <input type="text" id="input-player-name" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-0 outline-none text-lg transition-colors">
                </div>

                <div>
                    <h3 class="text-sm font-bold text-slate-700 mb-3" data-i18n="setup_step2">2. é€‰æ‹©æ‰®æ¼”è§’è‰²ï¼š</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="role-selector-container"></div>
                </div>

                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 shadow-inner">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <span>ğŸ¤–</span> <span data-i18n="setup_step3">3. é…ç½®å…¶å®ƒé˜Ÿå‹ (AI) çš„æ€§æ ¼ï¼š</span>
                    </h3>
                    <div id="ai-configs-container" class="space-y-4"></div>
                </div>

                <button onclick="attemptStartGame()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl text-xl transition-all active:scale-[0.98] shadow-lg shadow-blue-600/30" data-i18n="btn_start">
                    å¼€å§‹æ¨¡æ‹Ÿ
                </button>
            </div>
        </div>

        <!-- SCREEN 2: GAMEPLAY DASHBOARD -->
        <div id="screen-game" class="hidden slide-in space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-indigo-500"></div>
                    <div class="text-center mb-6 border-b border-slate-100 pb-4">
                        <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest" data-i18n="upstream">ä¾›è´§æ–¹ (ä¸Šæ¸¸)</span>
                        <h3 id="ui-upstream-name" class="text-xl font-black text-slate-800 mt-1 tracking-wide">--</h3>
                    </div>
                    
                    <div class="flex-grow flex flex-col justify-center space-y-4">
                        <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 shadow-inner">
                            <div class="text-xs text-slate-500 font-bold mb-3 uppercase tracking-wider text-center" data-i18n="transit_title">ğŸšš åœ¨é€”å®ç‰©æ˜ç»†</div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-200">
                                <span class="text-sm text-slate-600 font-medium" data-i18n="transit_1">ä¸‹å‘¨åˆ°è¾¾:</span>
                                <span id="ui-transit-1" class="text-2xl font-black text-green-600">0</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-sm text-slate-600 font-medium" data-i18n="transit_2">ä¸¤å‘¨ååˆ°è¾¾:</span>
                                <span id="ui-transit-2" class="text-xl font-bold text-slate-400">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="hidden lg:flex absolute top-1/2 -right-4 transform -translate-y-1/2 w-8 h-8 bg-white rounded-full items-center justify-center border border-slate-200 shadow-md z-10 text-slate-400 font-bold">â”</div>
                </div>

                <div class="lg:col-span-6 bg-white rounded-2xl shadow-xl border-2 border-blue-500 p-6 flex flex-col relative z-10 lg:scale-[1.02]">
                    <div class="absolute top-0 right-0 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-bl-xl font-bold tracking-wider" data-i18n="my_dash">æˆ‘çš„æ§åˆ¶å°</div>
                    
                    <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4 mt-2">
                        <div>
                            <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest" data-i18n="current_role">å½“å‰æ‰®æ¼”</span>
                            <h3 id="ui-my-role-name" class="text-2xl font-black text-blue-700 mt-1 tracking-wide">--</h3>
                        </div>
                        <button onclick="toggleHistoryModal()" class="text-xs md:text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg flex items-center gap-2 font-bold transition-colors shadow-sm border border-slate-200">
                            <span>ğŸ“Š</span> <span data-i18n="btn_history">åº“å­˜æ˜ç»†</span>
                        </button>
                    </div>

                    <div class="flex justify-center items-stretch gap-4 mb-4">
                        <div class="w-1/2 bg-blue-50/50 rounded-xl border border-blue-200 flex flex-col overflow-hidden shadow-sm">
                            <div class="p-4 text-center flex-grow">
                                <div class="text-xs text-blue-600 font-bold mb-1 uppercase tracking-wider" data-i18n="curr_inv">ğŸ“¦ å½“å‰å¯ç”¨åº“å­˜</div>
                                <div id="ui-my-inventory" class="text-6xl font-black text-slate-800">12</div>
                            </div>
                            <div class="bg-blue-100/50 border-t border-blue-200 py-2 text-center">
                                <div class="text-[10px] text-blue-600/80 font-bold" data-i18n="cost_inv_label">ä»“å‚¨æˆæœ¬ ({c}0.5/ä»¶)</div>
                                <div class="text-sm font-black text-slate-700"><span class="curr-symbol">Â¥</span><span id="ui-cost-inv">6.0</span></div>
                            </div>
                        </div>

                        <div class="w-1/2 bg-red-50/50 rounded-xl border border-red-200 flex flex-col overflow-hidden shadow-sm">
                            <div class="p-4 text-center flex-grow">
                                <div class="text-xs text-red-600 font-bold mb-1 uppercase tracking-wider" data-i18n="curr_backlog">âš ï¸ ç§¯å‹çš„æ¬ å•</div>
                                <div id="ui-my-backlog" class="text-6xl font-black text-red-600">0</div>
                            </div>
                            <div class="bg-red-100/50 border-t border-red-200 py-2 text-center">
                                <div class="text-[10px] text-red-600/80 font-bold" data-i18n="cost_backlog_label">è¿çº¦æˆæœ¬ ({c}1.0/ä»¶)</div>
                                <div class="text-sm font-black text-red-700"><span class="curr-symbol">Â¥</span><span id="ui-cost-backlog">0.0</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-6">
                        <span class="inline-block bg-slate-100 text-slate-600 text-xs font-bold px-4 py-1.5 rounded-full border border-slate-200">
                            <span data-i18n="last_cost">ä¸Šå‘¨äº§ç”Ÿçš„æ€»ç»´æŒæˆæœ¬:</span> <span class="curr-symbol text-slate-800 font-black text-sm ml-1">Â¥</span><span id="ui-last-week-cost" class="text-slate-800 font-black text-sm">6.0</span>
                        </span>
                    </div>

                    <div class="pt-6 border-t border-slate-200">
                        <label class="block text-sm font-bold text-slate-800 mb-3 text-center" data-i18n="order_prompt">æœ¬å‘¨å†³å®šå‘ä¸Šæ¸¸è®¢è´§ï¼š</label>
                        <div class="flex flex-col items-center max-w-sm mx-auto">
                            <div class="flex gap-2 w-full relative">
                                <input type="number" id="ui-order-input" min="0" class="w-full text-center text-3xl font-black font-mono border-2 border-slate-300 rounded-xl focus:border-blue-500 focus:ring-0 outline-none p-3 shadow-inner text-slate-800 bg-white">
                                <button onclick="triggerTurnProcess()" class="bg-blue-600 hover:bg-blue-700 text-white font-black px-8 py-3 rounded-xl shadow-lg shadow-blue-600/30 transition-transform active:scale-95 whitespace-nowrap text-lg tracking-wide" data-i18n="btn_submit">
                                    æäº¤
                                </button>
                            </div>
                            <div class="mt-3 text-[11px] text-slate-500 font-medium bg-slate-50 px-3 py-1.5 rounded-md border border-slate-200 w-full text-center flex items-center justify-center gap-1.5">
                                <span>â³</span>
                                <span data-i18n="order_delay_note">æç¤ºï¼šè®¢å•å‘å‡ºåéœ€ 1 å‘¨é€è¾¾ã€‚</span>
                                <span class="text-blue-600 font-bold bg-blue-100 px-1.5 rounded">
                                    <span data-i18n="intransit_order">åœ¨é€”è®¢å•:</span> <span id="ui-intransit-order">4</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="hidden lg:flex absolute top-1/2 -right-4 transform -translate-y-1/2 w-8 h-8 bg-white rounded-full items-center justify-center border border-slate-200 shadow-md z-10 text-slate-400 font-bold">â”</div>
                </div>

                <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-1.5 h-full bg-orange-500"></div>
                    <div class="text-center mb-6 border-b border-slate-100 pb-4">
                        <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest" data-i18n="downstream">éœ€æ±‚æ–¹ (ä¸‹æ¸¸)</span>
                        <h3 id="ui-downstream-name" class="text-xl font-black text-slate-800 mt-1 tracking-wide">--</h3>
                    </div>
                    
                    <div class="flex-grow flex flex-col justify-center">
                        <div class="bg-orange-50/50 rounded-xl p-6 text-center border border-orange-200 shadow-inner relative overflow-hidden">
                            <div class="absolute -right-4 -top-4 text-5xl opacity-10">ğŸ“„</div>
                            <div class="text-xs text-orange-800 font-bold mb-3 uppercase tracking-wider relative z-10" data-i18n="incoming_order">ğŸ“¥ æœ¬å‘¨æ”¶åˆ°çš„æ–°è®¢å•</div>
                            <div id="ui-incoming-order" class="text-6xl font-black text-orange-600 relative z-10">4</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- SCREEN 3: RESULTS / DEBRIEF -->
        <div id="screen-result" class="hidden slide-in space-y-6">
            
            <div id="pdf-content-wrapper" class="bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
                
                <div class="flex justify-between items-start mb-8 border-b border-slate-100 pb-6">
                    <div>
                        <h2 class="text-4xl font-black text-slate-900 mb-2 tracking-tight" data-i18n="result_title">æ¨¡æ‹Ÿç»“æŸï¼šå…¨é“¾è·¯å¤ç›˜</h2>
                        <p class="text-slate-500 text-lg" data-i18n="result_desc">ä¸Šå¸è§†è§’å·²å¼€å¯ï¼ŒæŸ¥çœ‹ä¾›åº”é“¾æ·±å¤„çš„æ•°æ®çœŸç›¸ã€‚</p>
                    </div>
                    <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center gap-2" id="btn-export">
                        <span>ğŸ“¥</span> <span data-i18n="btn_export">å¯¼å‡º PDF æŠ¥å‘Š</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 class="text-xl font-black text-slate-800 mb-2" data-i18n="cost_chart_title">ğŸ“Š æˆæœ¬èµ°åŠ¿åˆ†æ (åŒè½´)</h3>
                        <div class="flex gap-6 mb-4 text-sm font-bold text-slate-600">
                            <div><span data-i18n="total_cost_label">ç´¯è®¡æ€»æˆæœ¬:</span> <span class="curr-symbol text-red-600 text-lg">Â¥</span><span class="text-red-600 text-lg" id="final-cost">0</span></div>
                            <div><span data-i18n="inv_cost_label">ä»“å‚¨:</span> <span class="curr-symbol">Â¥</span><span id="final-cost-inv">0</span></div>
                            <div><span data-i18n="backlog_cost_label">è¿çº¦:</span> <span class="curr-symbol">Â¥</span><span id="final-cost-backlog">0</span></div>
                        </div>
                        <div class="chart-container">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="mb-4">
                            <h3 class="text-xl font-black text-slate-800" data-i18n="bullwhip_chart_title">ğŸ“ˆ ç‰›é­æ•ˆåº”æ£€æµ‹å›¾</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="bullwhipChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-6 rounded-2xl border border-blue-200 shadow-sm mb-8">
                    <h3 class="text-lg font-black text-blue-900 mb-4" data-i18n="variance_title">ğŸ“‰ å…¨é“¾è·¯æ³¢åŠ¨æ–¹å·®å¯¹æ¯”ä¸è¯„ä»·</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4" id="variance-cards-container"></div>
                    <div class="bg-white p-5 rounded-xl border border-blue-100 text-blue-900 text-sm leading-relaxed font-medium" id="variance-evaluation">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- AI Teacher Insights -->
                <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-200 text-indigo-900 text-sm leading-relaxed shadow-sm">
                    <h3 class="text-lg font-black text-indigo-800 mb-3" data-i18n="ai_teacher_title">ğŸ’¡ AI æ•™å¸ˆæ´å¯Ÿï¼š</h3>
                    <strong class="block mb-1 text-base" data-i18n="ai_insight_q">ç–‘é—®ï¼šä¸ºä»€ä¹ˆæœ‰æ—¶å€™åˆ°è´§æ˜¯ 0ï¼Œéšåçªç„¶å¤§é‡åˆ°è´§ï¼Ÿ</strong>
                    <p class="mt-2 font-medium" data-i18n="ai_insight_a">å¦‚æœæ‚¨æ˜¯åŒ€é€Ÿä¸‹å•çš„ï¼Œå´é‡åˆ°äº†ä¸Šè¿°æƒ…å†µï¼Œè¯·ä¸è¦æƒŠè®¶ã€‚è¿™æ­£æ˜¯<strong>ç‰›é­æ•ˆåº”å¯¼è‡´çš„â€œæ–­ä¾›ä¸æŠ¥å¤æ€§å‘è´§â€</strong>ã€‚å½“å¾®å°çš„æ³¢åŠ¨ä¼ å¯¼åˆ°æ‚¨çš„ä¸Šæ¸¸æ—¶è¢«æ”¾å¤§äº†ï¼Œå¯¼è‡´ä¸Šæ¸¸ä¸¥é‡ç¼ºè´§ï¼ˆå˜ä¸º0ï¼‰ï¼Œç›´åˆ°æ›´ä¸Šæ¸¸çš„è´§ç‰©é›†ä¸­æŠµè¾¾ï¼Œä»–ä»¬æ‰æŠŠç§¯å‹çš„å•å­ä¸€æ¬¡æ€§å‘ç»™æ‚¨ï¼Œé€ æˆäº†å·¨å¤§çš„åˆ°è´§æ´ªå³°ã€‚</p>
                </div>

                <!-- Hidden History for PDF export -->
                <div id="pdf-history-table" class="hidden pt-8 border-t border-slate-200 mt-8">
                    <h3 class="text-2xl font-black text-slate-800 mb-4" data-i18n="history_title">æ‚¨çš„åº“å­˜æµæ°´è´¦</h3>
                    <div id="pdf-history-content"></div>
                </div>
            </div>

            <div class="text-center pt-4 pb-8">
                <button onclick="location.reload()" class="bg-slate-900 hover:bg-black text-white font-black py-4 px-10 rounded-2xl transition-all shadow-xl hover:-translate-y-1 text-lg" data-i18n="btn_restart">
                    å¼€å¯æ–°çš„ä¸€å±€
                </button>
            </div>
        </div>

    </main>

    <!-- Turn Processing Animation Overlay -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-blue-500"></div>
            <h3 class="text-2xl font-black text-center mb-8 text-slate-800"><span data-i18n="processing">å¤„ç†ç¬¬</span> <span id="anim-week" class="text-blue-600 mx-1"></span> <span data-i18n="week_suffix">å‘¨</span></h3>
            
            <div class="space-y-6 font-bold text-lg mb-8 px-4">
                <div id="anim-step-1" class="step-hidden flex items-center justify-between text-green-600 bg-green-50 p-3 rounded-lg border border-green-100">
                    <div class="flex items-center gap-3"><span class="text-2xl">ğŸšš</span> <span data-i18n="anim_receive">å…¥åº“ (æ”¶è´§)</span></div>
                    <span class="text-2xl font-black">+<span id="anim-val-1"></span></span>
                </div>
                <div id="anim-step-2" class="step-hidden flex items-center justify-between text-orange-600 bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“¦</span> <span data-i18n="anim_ship">å‡ºåº“ (å‘è´§)</span></div>
                    <span class="text-2xl font-black">-<span id="anim-val-2"></span></span>
                </div>
                <div id="anim-step-3" class="step-hidden flex items-center justify-between text-purple-600 bg-purple-50 p-3 rounded-lg border border-purple-100">
                    <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“„</span> <span data-i18n="anim_order">å‘å‡ºè®¢å•</span></div>
                    <span class="text-2xl font-black"><span id="anim-val-3"></span></span>
                </div>
            </div>

            <button id="btn-confirm-turn" class="hidden w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-3.5 rounded-xl shadow-lg transition-transform active:scale-95 text-lg" onclick="finalizeTurn()" data-i18n="btn_confirm">
                ç¡®è®¤ç»“ç®—ï¼Œè¿›å…¥ä¸‹ä¸€å‘¨
            </button>
        </div>
    </div>

    <!-- History Table Modal -->
    <div id="history-modal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[85vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-slate-50">
                <h3 class="text-2xl font-black text-slate-800 flex items-center gap-3"><span>ğŸ“Š</span> <span data-i18n="history_title">æ‚¨çš„åº“å­˜æµæ°´è´¦</span></h3>
                <button onclick="toggleHistoryModal()" class="text-slate-400 hover:text-red-500 text-4xl font-black leading-none transition-colors">&times;</button>
            </div>
            <div class="p-0 overflow-y-auto custom-scroll flex-grow bg-white">
                <table class="w-full text-center" id="main-history-table">
                    <!-- Populated by JS -->
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- 1. I18N Engine ---
        const DICT = {
            zh: {
                app_title: "BEER GAME PRO", setup_title: "ä¾›åº”é“¾æ²™ç›˜æ¨¡æ‹Ÿ", setup_desc: "è®¾å®šæ‚¨çš„èº«ä»½å¹¶é…ç½®å„èŠ‚ç‚¹çš„ AI è¡Œä¸ºæ¨¡å¼",
                player: "ç©å®¶:", week: "å‘¨æ¬¡", setup_step1: "1. ç©å®¶ç½²åï¼š", setup_step2: "2. é€‰æ‹©æ‰®æ¼”è§’è‰²ï¼š", setup_step3: "3. é…ç½®å…¶å®ƒé˜Ÿå‹ (AI) çš„æ€§æ ¼ï¼š",
                role_ret: "é›¶å”®å•†", role_who: "æ‰¹å‘å•†", role_dis: "åˆ†é”€å•†", role_fac: "å·¥å‚", role_con: "ç»ˆç«¯æ¶ˆè´¹è€…", role_sup: "å¤–éƒ¨ä¾›åº”å•†",
                ai_panic: "æ‹ŸçœŸäººç±» (æ˜“ææ…Œ)", ai_rational: "ç»å¯¹ç†æ€§ (å¹³æ»‘)", btn_start: "å¼€å§‹æ¨¡æ‹Ÿ", btn_confirm: "ç¡®è®¤ç»“ç®—ï¼Œè¿›å…¥ä¸‹ä¸€å‘¨",
                upstream: "ä¾›è´§æ–¹ (ä¸Šæ¸¸)", transit_title: "ğŸšš åœ¨é€”å®ç‰©æ˜ç»†", transit_1: "ä¸‹å‘¨åˆ°è¾¾:", transit_2: "ä¸¤å‘¨ååˆ°è¾¾:",
                my_dash: "æˆ‘çš„æ§åˆ¶å°", current_role: "å½“å‰æ‰®æ¼”", btn_history: "åº“å­˜æ˜ç»†", curr_inv: "ğŸ“¦ å½“å‰å¯ç”¨åº“å­˜", curr_backlog: "âš ï¸ ç§¯å‹çš„æ¬ å•",
                cost_inv_label: "ä»“å‚¨æˆæœ¬ ({c}0.5/ä»¶)", cost_backlog_label: "è¿çº¦æˆæœ¬ ({c}1.0/ä»¶)", last_cost: "ä¸Šå‘¨äº§ç”Ÿçš„æ€»ç»´æŒæˆæœ¬:",
                order_prompt: "æœ¬å‘¨å†³å®šå‘ä¸Šæ¸¸è®¢è´§ï¼š", btn_submit: "æäº¤", order_delay_note: "æç¤ºï¼šè®¢å•å‘å‡ºåéœ€ 1 å‘¨é€è¾¾ã€‚", intransit_order: "åœ¨é€”è®¢å•:",
                downstream: "éœ€æ±‚æ–¹ (ä¸‹æ¸¸)", incoming_order: "ğŸ“¥ æœ¬å‘¨æ”¶åˆ°çš„æ–°è®¢å•", result_title: "æ¨¡æ‹Ÿç»“æŸï¼šå…¨é“¾è·¯å¤ç›˜", result_desc: "ä¸Šå¸è§†è§’å·²å¼€å¯ï¼ŒæŸ¥çœ‹ä¾›åº”é“¾æ·±å¤„çš„æ•°æ®çœŸç›¸ã€‚",
                btn_export: "å¯¼å‡º PDF æŠ¥å‘Š", cost_chart_title: "ğŸ“Š æˆæœ¬èµ°åŠ¿åˆ†æ (åŒè½´)", total_cost_label: "ç´¯è®¡æ€»æˆæœ¬:", inv_cost_label: "ä»“å‚¨:", backlog_cost_label: "è¿çº¦:",
                bullwhip_chart_title: "ğŸ“ˆ ç‰›é­æ•ˆåº”æ£€æµ‹å›¾", variance_title: "ğŸ“‰ å…¨é“¾è·¯æ³¢åŠ¨æ–¹å·®å¯¹æ¯”ä¸è¯„ä»·", history_title: "æ‚¨çš„åº“å­˜æµæ°´è´¦", btn_restart: "å¼€å¯æ–°çš„ä¸€å±€",
                processing: "å¤„ç†ç¬¬", week_suffix: "å‘¨", anim_receive: "å…¥åº“ (æ”¶è´§)", anim_ship: "å‡ºåº“ (å‘è´§)", anim_order: "å‘å‡ºè®¢å•",
                table_w: "å‘¨æ¬¡", table_start: "æœŸåˆåº“å­˜", table_in: "å…¥åº“ (+åˆ°è´§)", table_out: "å‡ºåº“ (-å‘è´§)", table_end: "æœŸæœ«åº“å­˜", table_backlog: "æœŸæœ«æ¬ å•", table_order: "å‘å‡ºè®¢å•", table_cost: "æœ¬å‘¨æˆæœ¬",
                eval_prefix: "è¯„ä»·ï¼š", summary_prefix: "å…¨é“¾è·¯æ€»ç»“ï¼š",
                summary_text: "åœ¨æ•´ä¸ªä¾›åº”é“¾ä¸­ï¼Œæ³¢åŠ¨æœ€å¤§çš„æ˜¯ <strong>{role}</strong>ï¼Œå…¶è®¢å•æ–¹å·®æ˜¯ç»ˆç«¯éœ€æ±‚çš„ {ratio} å€ã€‚è¿™ç›´è§‚åœ°è¯æ˜äº†ç‰›é­æ•ˆåº”çš„é€çº§æ”¾å¤§ç‰¹æ€§ã€‚",
                eval_1: "å¤ªä¸å¯æ€è®®äº†ï¼æ‚¨ä¸ä»…æ²¡æœ‰æ”¾å¤§æ³¢åŠ¨ï¼Œåè€Œå¸æ”¶äº†æ¶ˆè´¹è€…çš„éœ€æ±‚éœ‡è¡ã€‚æ‚¨é‡‡ç”¨äº†éå¸¸é«˜çº§çš„å¹³æ»‘è®¢è´§ç­–ç•¥ã€‚",
                eval_2: "è¡¨ç°æä½³ï¼æ‚¨æœ‰æ•ˆæ§åˆ¶äº†ææ…Œæƒ…ç»ªï¼Œè€ƒè™‘åˆ°æ—¶é—´å»¶è¿Ÿï¼Œåšå‡ºäº†ç†æ€§çš„è¡¥è´§å†³ç­–ã€‚",
                eval_3: "æ‚¨è¡¨ç°å‡ºäº†äººç±»å…¸å‹çš„è¡Œä¸ºç‰¹å¾ã€‚å½“é¢ä¸´åº“å­˜çŸ­ç¼ºå’Œç§¯å‹æ—¶ï¼Œè®¢å•å‡ºç°äº†æ˜æ˜¾çš„æŒ¯è¡ï¼Œå¯¼è‡´äº†éœ€æ±‚æ”¾å¤§ã€‚",
                eval_4: "è­¦å‘Šï¼ä¾›åº”é“¾äº§ç”Ÿäº†æç«¯çš„ç‰›é­æ•ˆåº”ã€‚ä»”ç»†æŸ¥çœ‹å›¾è¡¨ï¼Œçœ‹çœ‹ææ…Œæ˜¯å¦‚ä½•å¼•å‘æ•´ä¸ªé“¾æ¡å´©æºƒçš„ã€‚",
                news_title: "å•†ä¸šè§†ç‚¹", evt_sport_prep: "ä¸šç•Œä¼ é—»ï¼šå¬è¯´è¿‘æœŸå°†æœ‰å¤§å‹èµ›äº‹ä¸¾åŠï¼Œä¹Ÿè®¸ä¼šå¸¦åŠ¨æ¶ˆè´¹æ°›å›´ã€‚", evt_sport: "èµ›äº‹ç«çƒ­è¿›è¡Œä¸­ï¼šéœ€æ±‚å‡ºç°æ˜æ˜¾ä¸Šæ¶¨ã€‚",
                evt_weather_prep: "æ°”è±¡é¢„è­¦ï¼šæ°”è±¡å°å‘å¸ƒç½•è§å¯’æ½®é¢„è­¦ã€‚", evt_weather: "å¯’æ½®æ¥è¢­ï¼šæ¶ˆè´¹è€…å¤§å¹…å‡å°‘å¤–å‡ºã€‚",
                evt_normal: "å¤©æ°”å›æš–ï¼šåŸå¸‚æ¢å¤å¾€å¸¸è¿ä½œã€‚", evt_promo_prep: "å•†ä¸šä¼åˆ’ï¼šå¹´åº¦è´­ç‰©ç‹‚æ¬¢èŠ‚å³å°†å¼€å¯ã€‚", evt_promo: "ç‹‚æ¬¢èŠ‚å¼•çˆ†ï¼šéœ€æ±‚å‰§å¢ï¼",
                ai_teacher_title: "ğŸ’¡ AI æ•™å¸ˆæ´å¯Ÿï¼š", ai_insight_q: "ç–‘é—®ï¼šä¸ºä»€ä¹ˆæœ‰æ—¶å€™åˆ°è´§æ˜¯ 0ï¼Œéšåçªç„¶å¤§é‡åˆ°è´§ï¼Ÿ", ai_insight_a: "å¦‚æœæ‚¨æ˜¯åŒ€é€Ÿä¸‹å•çš„ï¼Œå´é‡åˆ°äº†ä¸Šè¿°æƒ…å†µï¼Œè¯·ä¸è¦æƒŠè®¶ã€‚è¿™æ­£æ˜¯<strong>ç‰›é­æ•ˆåº”å¯¼è‡´çš„â€œæ–­ä¾›ä¸æŠ¥å¤æ€§å‘è´§â€</strong>ã€‚å½“å¾®å°çš„æ³¢åŠ¨ä¼ å¯¼åˆ°æ‚¨çš„ä¸Šæ¸¸æ—¶è¢«æ”¾å¤§äº†ï¼Œå¯¼è‡´ä¸Šæ¸¸ä¸¥é‡ç¼ºè´§ï¼ˆå˜ä¸º0ï¼‰ï¼Œç›´åˆ°æ›´ä¸Šæ¸¸çš„è´§ç‰©é›†ä¸­æŠµè¾¾ï¼Œä»–ä»¬æ‰æŠŠç§¯å‹çš„å•å­ä¸€æ¬¡æ€§å‘ç»™æ‚¨ï¼Œé€ æˆäº†å·¨å¤§çš„åˆ°è´§æ´ªå³°ã€‚"
            },
            en: {
                app_title: "BEER GAME PRO", setup_title: "Supply Chain Simulator", setup_desc: "Set your identity and configure AI behavior",
                player: "Player:", week: "Week", setup_step1: "1. Player Name:", setup_step2: "2. Select Role:", setup_step3: "3. Configure AI Personalities:",
                role_ret: "Retailer", role_who: "Wholesaler", role_dis: "Distributor", role_fac: "Factory", role_con: "Consumer", role_sup: "Supplier",
                ai_panic: "Human-like (Panic)", ai_rational: "Rational (Smooth)", btn_start: "Start Simulation", btn_confirm: "Confirm & Next Week",
                upstream: "Upstream (Supplier)", transit_title: "ğŸšš In-Transit Details", transit_1: "Arriving Next Wk:", transit_2: "Arriving in 2 Wks:",
                my_dash: "My Dashboard", current_role: "Current Role", btn_history: "Inventory Log", curr_inv: "ğŸ“¦ Available Inventory", curr_backlog: "âš ï¸ Backlog",
                cost_inv_label: "Holding ({c}0.5/unit)", cost_backlog_label: "Backlog ({c}1.0/unit)", last_cost: "Total Cost Last Week:",
                order_prompt: "Place order to upstream this week:", btn_submit: "Submit", order_delay_note: "Note: Orders take 1 week to reach upstream.", intransit_order: "In-Transit Orders:",
                downstream: "Downstream (Demand)", incoming_order: "ğŸ“¥ New Incoming Order", result_title: "Simulation Debrief", result_desc: "God-mode unlocked. Let's look at the data.",
                btn_export: "Export PDF", cost_chart_title: "ğŸ“Š Cost Trend (Dual-Axis)", total_cost_label: "Total Cum. Cost:", inv_cost_label: "Holding:", backlog_cost_label: "Backlog:",
                bullwhip_chart_title: "ğŸ“ˆ Bullwhip Effect Chart", variance_title: "ğŸ“‰ Variance Comparison & Evaluation", history_title: "Your Inventory Log", btn_restart: "Start New Game",
                processing: "Processing Week", week_suffix: "", anim_receive: "Received Goods", anim_ship: "Shipped Goods", anim_order: "Order Placed",
                table_w: "Week", table_start: "Start Inv", table_in: "Received (+)", table_out: "Shipped (-)", table_end: "End Inv", table_backlog: "Backlog", table_order: "Order Placed", table_cost: "Weekly Cost",
                eval_prefix: "Evaluation: ", summary_prefix: "Chain Summary: ",
                summary_text: "Across the supply chain, the most volatile node is <strong>{role}</strong>, whose order variance is {ratio} times the end consumer demand. This visually proves the Bullwhip Effect.",
                eval_1: "Incredible! You absorbed the demand shock instead of amplifying it. Excellent smoothing strategy.",
                eval_2: "Great job! You controlled panic, considered delays, and made rational replenishment decisions.",
                eval_3: "You showed typical human behavior. Facing shortages, you oscillated orders, amplifying demand.",
                eval_4: "Warning! Extreme Bullwhip Effect detected. See how panic caused the chain to collapse.",
                news_title: "Business News", evt_sport_prep: "Rumor: Big sports event coming up. Might boost sales.", evt_sport: "Event Ongoing: Demand is visibly up.",
                evt_weather_prep: "Weather Alert: Severe cold wave forecasted.", evt_weather: "Cold Wave: Consumers are staying home.",
                evt_normal: "Weather warming: Business back to normal.", evt_promo_prep: "Promo Prep: Mega sale event coming soon.", evt_promo: "Mega Sale: Demand is skyrocketing!",
                ai_teacher_title: "ğŸ’¡ Insights from AI Teacher:", ai_insight_q: "Q: Why do deliveries sometimes drop to 0, then suddenly arrive in huge batches?", ai_insight_a: "If you ordered steadily but experienced this, don't be surprised. This is the <strong>'supply disruption and retaliatory shipping'</strong> caused by the Bullwhip Effect. Small fluctuations amplified upstream cause severe stockouts (dropping to 0). When upstream finally receives their delayed bulk shipments, they send all backlogged orders at once, causing a massive flood of inventory."
            },
            es: {
                app_title: "BEER GAME PRO", setup_title: "Simulador de Cadena", setup_desc: "Configure su identidad y la IA",
                player: "Jugador:", week: "Semana", setup_step1: "1. Nombre:", setup_step2: "2. Seleccione Rol:", setup_step3: "3. Configure IA:",
                role_ret: "Minorista", role_who: "Mayorista", role_dis: "Distribuidor", role_fac: "FÃ¡brica", role_con: "Consumidor", role_sup: "Proveedor",
                ai_panic: "Humano (PÃ¡nico)", ai_rational: "Racional (Suave)", btn_start: "Iniciar SimulaciÃ³n", btn_confirm: "Confirmar y Siguiente",
                upstream: "Proveedor (Aguas arriba)", transit_title: "ğŸšš TrÃ¡nsito", transit_1: "Llega prÃ³x. sem:", transit_2: "Llega en 2 sem:",
                my_dash: "Mi Panel", current_role: "Rol Actual", btn_history: "Historial", curr_inv: "ğŸ“¦ Inventario", curr_backlog: "âš ï¸ Pedidos Pendientes",
                cost_inv_label: "Almacenaje ({c}0.5/u)", cost_backlog_label: "Pendientes ({c}1.0/u)", last_cost: "Costo de la semana pasada:",
                order_prompt: "Hacer pedido esta semana:", btn_submit: "Enviar", order_delay_note: "Nota: Los pedidos tardan 1 sem en llegar.", intransit_order: "Pedidos en trÃ¡nsito:",
                downstream: "Demanda (Aguas abajo)", incoming_order: "ğŸ“¥ Nuevo Pedido", result_title: "AnÃ¡lisis Final", result_desc: "Modo Dios activado. Veamos los datos.",
                btn_export: "Exportar PDF", cost_chart_title: "ğŸ“Š Tendencia de Costos", total_cost_label: "Costo Total:", inv_cost_label: "AlmacÃ©n:", backlog_cost_label: "Falta:",
                bullwhip_chart_title: "ğŸ“ˆ Efecto LÃ¡tigo", variance_title: "ğŸ“‰ ComparaciÃ³n de Varianza y EvaluaciÃ³n", history_title: "Historial de Inventario", btn_restart: "Nuevo Juego",
                processing: "Procesando Semana", week_suffix: "", anim_receive: "Recibido", anim_ship: "Enviado", anim_order: "Pedido Enviado",
                table_w: "Sem", table_start: "Inv. Inicial", table_in: "Recibido (+)", table_out: "Enviado (-)", table_end: "Inv. Final", table_backlog: "Pendientes", table_order: "Pedido", table_cost: "Costo Semanal",
                eval_prefix: "EvaluaciÃ³n: ", summary_prefix: "Resumen de la Cadena: ",
                summary_text: "En toda la cadena de suministro, el nodo mÃ¡s inestable es <strong>{role}</strong>, cuya varianza de pedidos es {ratio} veces la demanda final. Esto demuestra visualmente el Efecto LÃ¡tigo.",
                eval_1: "Â¡IncreÃ­ble! AbsorbiÃ³ el impacto en lugar de amplificarlo. Excelente estrategia.",
                eval_2: "Â¡Buen trabajo! ControlÃ³ el pÃ¡nico considerando los retrasos de tiempo.",
                eval_3: "Comportamiento humano tÃ­pico. OscilÃ³ los pedidos amplificando la demanda.",
                eval_4: "Â¡Advertencia! Efecto LÃ¡tigo extremo. Mire cÃ³mo el pÃ¡nico colapsÃ³ la cadena.",
                news_title: "Noticias Comerciales", evt_sport_prep: "Rumor: Evento deportivo prÃ³ximo.", evt_sport: "Evento activo: Demanda al alza.",
                evt_weather_prep: "Alerta: Ola de frÃ­o severa.", evt_weather: "Ola de frÃ­o: Consumidores en casa.",
                evt_normal: "Clima normal: Negocios como siempre.", evt_promo_prep: "Promo: Gran venta anual pronto.", evt_promo: "Â¡Gran Venta: Demanda por las nubes!",
                ai_teacher_title: "ğŸ’¡ Perspectivas del Profesor IA:", ai_insight_q: "P: Â¿Por quÃ© a veces las entregas caen a 0 y luego llegan en grandes lotes de repente?", ai_insight_a: "Si ordenÃ³ de manera constante pero experimentÃ³ esto, no se sorprenda. Esta es la <strong>'interrupciÃ³n del suministro y envÃ­o de represalia'</strong> causada por el Efecto LÃ¡tigo. Las pequeÃ±as fluctuaciones amplificadas aguas arriba causan graves desabastecimientos (cayendo a 0). Cuando aguas arriba finalmente recibe sus envÃ­os masivos retrasados, envÃ­an todos los pedidos atrasados a la vez, causando una inundaciÃ³n masiva de inventario."
            }
        };

        let currentLang = 'zh';
        function c() { return { zh: 'Â¥', en: '$', es: 'â‚¬' }[currentLang]; }
        function t(key) { return DICT[currentLang][key] || key; }

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                let translated = t(key).replace('{c}', c());
                if (el.tagName === 'INPUT' && el.type === 'text') { el.placeholder = translated; }
                else { el.innerHTML = translated; }
            });
            document.querySelectorAll('.curr-symbol').forEach(el => el.innerText = c());
            
            renderRoleSelector();
            renderAIConfigs();
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                if(btn.innerText.toLowerCase().includes(lang) || (lang==='zh' && btn.innerText==='ä¸­æ–‡')) {
                    btn.classList.replace('bg-slate-800', 'bg-blue-600');
                    btn.classList.replace('text-slate-400', 'text-white');
                } else {
                    btn.classList.replace('bg-blue-600', 'bg-slate-800');
                    btn.classList.replace('text-white', 'text-slate-400');
                }
            });
        }

        const CONFIG = { maxWeeks: 36, baseDemand: 4, costInv: 0.5, costBacklog: 1.0, initialInv: 12, initialOrder: 4, roles: ['retailer', 'wholesaler', 'distributor', 'factory'] };
        const EVENTS = [
            { start: 4, end: 4, effect: 0, key: "evt_sport_prep" }, { start: 5, end: 10, effect: 4, key: "evt_sport" },
            { start: 17, end: 17, effect: 0, key: "evt_weather_prep" }, { start: 18, end: 20, effect: -2, key: "evt_weather" },
            { start: 21, end: 21, effect: 0, key: "evt_normal" }, { start: 27, end: 27, effect: 0, key: "evt_promo_prep" },
            { start: 28, end: 30, effect: 8, key: "evt_promo" }
        ];

        let state = {
            playerName: '', userRole: 'retailer', aiSettings: {}, week: 1, 
            myTotalCost: 0, myTotalInvCost: 0, myTotalBacklogCost: 0, lastWeekCost: 0, nodes: {}, myHistoryLog: [], 
            chartData: { labels: [], demand: [], periodCosts: [], cumCosts: [], orders: { retailer: [], wholesaler: [], distributor: [], factory: [] } },
            tempTurnData: null, currentEventKey: null 
        };

        let bullwhipChartInstance = null; let costChartInstance = null;
        function getRoleName(roleKey) { const map = { 'retailer': 'role_ret', 'wholesaler': 'role_who', 'distributor': 'role_dis', 'factory': 'role_fac' }; return t(map[roleKey]); }

        window.onload = function() { setLanguage('zh'); };

        function renderRoleSelector() {
            const container = document.getElementById('role-selector-container');
            const icons = ['ğŸª', 'ğŸ¢', 'ğŸš›', 'ğŸ­'];
            let html = '';
            CONFIG.roles.forEach((role, i) => {
                let checked = state.userRole === role ? 'checked' : '';
                html += `
                    <label class="relative cursor-pointer">
                        <input type="radio" name="role" value="${role}" class="peer sr-only" ${checked} onchange="updateSelectedRole(this.value)">
                        <div class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-slate-50 transition-all text-center shadow-sm">
                            <div class="text-3xl mb-2">${icons[i]}</div><div class="font-bold text-slate-800">${getRoleName(role)}</div>
                        </div>
                    </label>`;
            });
            container.innerHTML = html;
        }

        function updateSelectedRole(val) { state.userRole = val; renderAIConfigs(); }

        function renderAIConfigs() {
            const container = document.getElementById('ai-configs-container');
            container.innerHTML = '';
            CONFIG.roles.forEach(role => {
                if (role !== state.userRole) {
                    container.innerHTML += `
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center p-3.5 bg-white border border-slate-200 rounded-xl shadow-sm">
                            <span class="font-black text-slate-800 mb-2 sm:mb-0 text-sm tracking-wide w-24">${getRoleName(role)}</span>
                            <div class="flex-grow flex gap-6 sm:justify-end">
                                <label class="flex items-center gap-2 cursor-pointer text-sm font-bold text-slate-600 hover:text-purple-700">
                                    <input type="radio" name="ai_type_${role}" value="panic" checked class="accent-purple-600 w-4 h-4">
                                    <span>${t('ai_panic')}</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer text-sm font-bold text-slate-600 hover:text-green-700">
                                    <input type="radio" name="ai_type_${role}" value="rational" class="accent-green-600 w-4 h-4">
                                    <span>${t('ai_rational')}</span>
                                </label>
                            </div>
                        </div>`;
                }
            });
        }

        function attemptStartGame() {
            const nameInput = document.getElementById('input-player-name').value.trim();
            if (!nameInput) { alert("Please enter your name."); return; }
            state.playerName = nameInput;

            CONFIG.roles.forEach(role => {
                if (role !== state.userRole) { state.aiSettings[role] = document.querySelector(`input[name="ai_type_${role}"]:checked`).value; }
            });

            initEngine();
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('lang-selector').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('header-status').classList.remove('hidden');
            document.getElementById('header-status').classList.add('flex');
            document.getElementById('ui-player-name').innerText = state.playerName;

            setupDashboardLabels(); updateDashboardUI();
        }

        function initEngine() {
            CONFIG.roles.forEach(role => {
                state.nodes[role] = { inv: CONFIG.initialInv, backlog: 0, incomingShipmentQueue: [CONFIG.initialOrder, CONFIG.initialOrder], incomingOrderQueue: [CONFIG.initialOrder], lastOrderPlaced: CONFIG.initialOrder, inTransitOrderVisible: CONFIG.initialOrder };
            });
        }

        function getDemandForWeek(week) {
            let demand = CONFIG.baseDemand;
            let activeEvent = EVENTS.find(e => week >= e.start && week <= e.end);
            if (activeEvent) demand += activeEvent.effect;
            return Math.max(0, demand);
        }

        function processBannerAnimation(week) {
            const banner = document.getElementById('event-banner');
            let activeEvent = EVENTS.find(e => week >= e.start && week <= e.end);
            
            if (activeEvent) {
                if (state.currentEventKey !== activeEvent.key) {
                    document.getElementById('event-desc').innerText = t(activeEvent.key);
                    banner.classList.add('active');
                    state.currentEventKey = activeEvent.key;
                }
            } else if (state.currentEventKey !== null) {
                banner.classList.remove('active');
                state.currentEventKey = null;
            }
        }

        function setupDashboardLabels() {
            document.getElementById('ui-my-role-name').innerText = getRoleName(state.userRole);
            let idx = CONFIG.roles.indexOf(state.userRole);
            document.getElementById('ui-downstream-name').innerText = idx === 0 ? t('role_con') : getRoleName(CONFIG.roles[idx-1]);
            document.getElementById('ui-upstream-name').innerText = idx === CONFIG.roles.length - 1 ? t('role_sup') : getRoleName(CONFIG.roles[idx+1]);
        }

        function updateDashboardUI() {
            document.getElementById('ui-week-counter').innerText = state.week;
            processBannerAnimation(state.week);

            let myNode = state.nodes[state.userRole];
            document.getElementById('ui-my-inventory').innerText = myNode.inv;
            document.getElementById('ui-my-backlog').innerText = myNode.backlog;
            
            document.getElementById('ui-cost-inv').innerText = (myNode.inv * CONFIG.costInv).toFixed(1);
            document.getElementById('ui-cost-backlog').innerText = (myNode.backlog * CONFIG.costBacklog).toFixed(1);
            document.getElementById('ui-last-week-cost').innerText = state.lastWeekCost.toFixed(1);

            document.getElementById('ui-transit-1').innerText = myNode.incomingShipmentQueue[0] || 0;
            document.getElementById('ui-transit-2').innerText = myNode.incomingShipmentQueue[1] || 0;
            document.getElementById('ui-intransit-order').innerText = myNode.inTransitOrderVisible;

            document.getElementById('ui-incoming-order').innerText = state.userRole === 'retailer' ? getDemandForWeek(state.week) : myNode.incomingOrderQueue[0];
            document.getElementById('ui-order-input').value = myNode.lastOrderPlaced;
        }

        function calcAIOrder(role, currentIncomingDemand) {
            let node = state.nodes[role];
            let targetInv = CONFIG.initialInv;
            let gap = targetInv - (node.inv - node.backlog);
            let pipeline = node.incomingShipmentQueue.reduce((a, b) => a + b, 0);
            
            let behavior = state.aiSettings[role];
            let alpha = behavior === 'panic' ? 1.0 : 0.5; 
            let beta = behavior === 'panic' ? 0.2 : 1.0; 

            let rawOrder = currentIncomingDemand + (gap * alpha) - (pipeline * beta);
            if (behavior === 'panic' && node.backlog > 5) rawOrder += 4;
            return Math.min(Math.max(0, Math.round(rawOrder)), 100);
        }

        function triggerTurnProcess() {
            let userOrderInput = parseInt(document.getElementById('ui-order-input').value);
            if (isNaN(userOrderInput) || userOrderInput < 0) return;

            let arrivingThisWeek = state.nodes[state.userRole].incomingShipmentQueue[0];
            let currentDemand = state.userRole === 'retailer' ? getDemandForWeek(state.week) : state.nodes[state.userRole].incomingOrderQueue[0];
            let shippedThisWeek = Math.min(state.nodes[state.userRole].inv + arrivingThisWeek, currentDemand + state.nodes[state.userRole].backlog);

            state.tempTurnData = { userOrderInput };

            document.getElementById('anim-week').innerText = state.week;
            document.getElementById('anim-val-1').innerText = arrivingThisWeek;
            document.getElementById('anim-val-2').innerText = shippedThisWeek;
            document.getElementById('anim-val-3').innerText = userOrderInput;

            const overlay = document.getElementById('processing-overlay');
            const btn = document.getElementById('btn-confirm-turn');
            const s1 = document.getElementById('anim-step-1'); const s2 = document.getElementById('anim-step-2'); const s3 = document.getElementById('anim-step-3');
            
            s1.className = 'step-hidden flex items-center justify-between text-green-600 bg-green-50 p-3 rounded-lg border border-green-100';
            s2.className = 'step-hidden flex items-center justify-between text-orange-600 bg-orange-50 p-3 rounded-lg border border-orange-100';
            s3.className = 'step-hidden flex items-center justify-between text-purple-600 bg-purple-50 p-3 rounded-lg border border-purple-100';
            btn.classList.add('hidden'); overlay.classList.remove('hidden');

            setTimeout(() => { s1.classList.replace('step-hidden', 'step-visible'); }, 300);
            setTimeout(() => { s2.classList.replace('step-hidden', 'step-visible'); }, 900);
            setTimeout(() => { s3.classList.replace('step-hidden', 'step-visible'); }, 1500);
            setTimeout(() => { btn.classList.remove('hidden'); }, 2000);
        }

        function finalizeTurn() {
            document.getElementById('processing-overlay').classList.add('hidden');
            executeTurnLogic(state.tempTurnData.userOrderInput);
            state.tempTurnData = null;
        }

        function executeTurnLogic(userOrderInput) {
            let consumerDemandThisWeek = getDemandForWeek(state.week);
            let startStates = {};
            CONFIG.roles.forEach(r => startStates[r] = { inv: state.nodes[r].inv, backlog: state.nodes[r].backlog });

            let incomingOrdersForFulfillment = {};
            CONFIG.roles.forEach(role => { incomingOrdersForFulfillment[role] = role === 'retailer' ? consumerDemandThisWeek : state.nodes[role].incomingOrderQueue.shift(); });

            let arrivingGoods = {};
            CONFIG.roles.forEach(role => { arrivingGoods[role] = state.nodes[role].incomingShipmentQueue.shift(); state.nodes[role].inv += arrivingGoods[role]; });

            let shippedQuantities = {};
            CONFIG.roles.forEach(role => {
                let totalNeed = incomingOrdersForFulfillment[role] + state.nodes[role].backlog;
                let shipped = Math.min(state.nodes[role].inv, totalNeed);
                state.nodes[role].inv -= shipped; state.nodes[role].backlog = totalNeed - shipped; shippedQuantities[role] = shipped;
            });

            let placedOrders = {};
            CONFIG.roles.forEach(role => {
                if (role === state.userRole) { placedOrders[role] = userOrderInput; state.nodes[role].inTransitOrderVisible = userOrderInput; } 
                else { placedOrders[role] = calcAIOrder(role, incomingOrdersForFulfillment[role]); }
                state.nodes[role].lastOrderPlaced = placedOrders[role];
            });

            state.nodes.distributor.incomingShipmentQueue.push(shippedQuantities.factory);
            state.nodes.wholesaler.incomingShipmentQueue.push(shippedQuantities.distributor);
            state.nodes.retailer.incomingShipmentQueue.push(shippedQuantities.wholesaler);
            state.nodes.factory.incomingShipmentQueue.push(placedOrders.factory); 

            state.nodes.wholesaler.incomingOrderQueue.push(placedOrders.retailer);
            state.nodes.distributor.incomingOrderQueue.push(placedOrders.wholesaler);
            state.nodes.factory.incomingOrderQueue.push(placedOrders.distributor);

            let myNode = state.nodes[state.userRole];
            let turnTotalCost = (myNode.inv * CONFIG.costInv) + (myNode.backlog * CONFIG.costBacklog);
            state.lastWeekCost = turnTotalCost;
            state.myTotalInvCost += (myNode.inv * CONFIG.costInv);
            state.myTotalBacklogCost += (myNode.backlog * CONFIG.costBacklog);
            state.myTotalCost += turnTotalCost;

            state.myHistoryLog.push({ week: state.week, startInv: startStates[state.userRole].inv, received: arrivingGoods[state.userRole], shipped: shippedQuantities[state.userRole], endInv: myNode.inv, backlog: myNode.backlog, orderPlaced: placedOrders[state.userRole], cost: turnTotalCost });
            generateHistoryTableHTML('main-history-table');

            state.chartData.labels.push(`W${state.week}`); state.chartData.demand.push(consumerDemandThisWeek);
            state.chartData.periodCosts.push(turnTotalCost); state.chartData.cumCosts.push(state.myTotalCost);
            CONFIG.roles.forEach(r => state.chartData.orders[r].push(placedOrders[r]));

            state.week++;
            if (state.week > CONFIG.maxWeeks) { endGame(); } else { updateDashboardUI(); }
        }

        function toggleHistoryModal() { document.getElementById('history-modal').classList.toggle('hidden'); }

        function generateHistoryTableHTML(targetId) {
            let html = `<thead class="bg-slate-100 text-slate-600 sticky top-0 shadow-sm text-sm font-bold tracking-wider">
                    <tr><th class="py-3 px-3">${t('table_w')}</th><th class="py-3 px-3">${t('table_start')}</th><th class="py-3 px-3 text-green-700">${t('table_in')}</th><th class="py-3 px-3 text-orange-700">${t('table_out')}</th><th class="py-3 px-3 bg-slate-200/80">${t('table_end')}</th><th class="py-3 px-3 text-red-600">${t('table_backlog')}</th><th class="py-3 px-3 text-blue-700 border-l border-slate-200">${t('table_order')}</th><th class="py-3 px-3 text-slate-700 border-l border-slate-200 bg-slate-50">${t('table_cost')}</th></tr>
                </thead><tbody class="divide-y divide-slate-100 font-mono text-sm">`;
            
            let source = targetId === 'pdf-history-content' ? state.myHistoryLog : [...state.myHistoryLog].reverse();
            source.forEach(row => {
                html += `<tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="py-2 px-3 font-bold">W${row.week}</td><td class="py-2 px-3">${row.startInv}</td><td class="py-2 px-3 text-green-600 font-bold">+${row.received}</td><td class="py-2 px-3 text-orange-600 font-bold">-${row.shipped}</td><td class="py-2 px-3 bg-slate-50 font-black">${row.endInv}</td><td class="py-2 px-3 text-red-600 font-bold">${row.backlog}</td><td class="py-2 px-3 text-blue-700 font-black border-l border-slate-200">${row.orderPlaced}</td><td class="py-2 px-3 text-slate-800 font-bold border-l border-slate-200 bg-slate-50">${c()}${row.cost.toFixed(1)}</td></tr>`;
            });
            html += `</tbody>`;
            if(targetId === 'pdf-history-content') { document.getElementById(targetId).innerHTML = `<table class="w-full text-center border-collapse border border-slate-200">${html}</table>`; } 
            else { document.getElementById(targetId).innerHTML = html; }
        }

        function calcVariance(arr) {
            if (arr.length === 0) return 0;
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            return arr.map(v => Math.pow(v - mean, 2)).reduce((a, b) => a + b, 0) / arr.length;
        }

        function endGame() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('event-banner').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('hidden');
            
            document.getElementById('final-cost').innerText = state.myTotalCost.toFixed(1);
            document.getElementById('final-cost-inv').innerText = state.myTotalInvCost.toFixed(1);
            document.getElementById('final-cost-backlog').innerText = state.myTotalBacklogCost.toFixed(1);

            const demandVar = calcVariance(state.chartData.demand);
            let variances = {}; CONFIG.roles.forEach(r => { variances[r] = calcVariance(state.chartData.orders[r]); });

            const varContainer = document.getElementById('variance-cards-container');
            varContainer.innerHTML = '';
            CONFIG.roles.forEach(r => {
                let vRatio = demandVar === 0 ? 1 : variances[r] / demandVar;
                let isMe = r === state.userRole;
                varContainer.innerHTML += `
                    <div class="p-3 rounded-lg border ${isMe ? 'bg-blue-600 text-white border-blue-700' : 'bg-white border-blue-200 text-blue-900'} text-center shadow-sm">
                        <div class="text-xs font-bold uppercase mb-1 ${isMe ? 'text-blue-200' : 'text-slate-400'}">${getRoleName(r)}</div>
                        <div class="text-2xl font-black">${vRatio.toFixed(2)}x</div>
                    </div>`;
            });

            let userVRatio = demandVar === 0 ? 1 : variances[state.userRole] / demandVar;
            let evalKey = userVRatio < 1.0 ? 'eval_1' : (userVRatio <= 1.5 ? 'eval_2' : (userVRatio <= 3.0 ? 'eval_3' : 'eval_4'));
            
            let maxRole = Object.keys(variances).reduce((a, b) => variances[a] > variances[b] ? a : b);
            let summaryFilled = t('summary_text').replace('{role}', getRoleName(maxRole)).replace('{ratio}', (variances[maxRole]/demandVar).toFixed(2));
            document.getElementById('variance-evaluation').innerHTML = `<strong>${t('eval_prefix')}</strong>${t(evalKey)}<br><br><strong>${t('summary_prefix')}</strong>${summaryFilled}`;

            renderCostChart(); renderBullwhipChart(); generateHistoryTableHTML('pdf-history-content');
        }

        function renderCostChart() {
            const ctx = document.getElementById('costChart').getContext('2d');
            costChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: state.chartData.labels, datasets: [
                        { type: 'line', label: t('total_cost_label'), data: state.chartData.cumCosts, yAxisID: 'y1', borderColor: '#ef4444', backgroundColor: '#ef4444', borderWidth: 2, tension: 0.1 },
                        { type: 'bar', label: t('table_cost'), data: state.chartData.periodCosts, yAxisID: 'y', backgroundColor: '#94a3b8' }
                ]},
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: { x: { grid: { display: false } }, y: { type: 'linear', display: true, position: 'left' }, y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } } }
                }
            });
        }

        function renderBullwhipChart() {
            const ctx = document.getElementById('bullwhipChart').getContext('2d');
            const datasets = [
                { label: t('role_con'), data: state.chartData.demand, borderColor: '#64748b', borderDash: [5, 5], borderWidth: 2, fill: false, tension: 0 },
                { label: getRoleName('retailer'), data: state.chartData.orders.retailer, borderColor: '#3b82f6', borderWidth: state.userRole==='retailer'?4:2, tension: 0.2 },
                { label: getRoleName('wholesaler'), data: state.chartData.orders.wholesaler, borderColor: '#10b981', borderWidth: state.userRole==='wholesaler'?4:2, tension: 0.2 },
                { label: getRoleName('distributor'), data: state.chartData.orders.distributor, borderColor: '#8b5cf6', borderWidth: state.userRole==='distributor'?4:2, tension: 0.2 },
                { label: getRoleName('factory'), data: state.chartData.orders.factory, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.05)', borderWidth: state.userRole==='factory'?4:2, fill: true, tension: 0.2 }
            ];

            bullwhipChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: state.chartData.labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });
        }

        function exportToPDF() {
            const btn = document.getElementById('btn-export');
            btn.innerHTML = 'Generating...'; btn.disabled = true;

            document.getElementById('pdf-history-table').classList.remove('hidden');
            const element = document.getElementById('pdf-content-wrapper');

            html2pdf().set({
                margin: 10, filename: `BeerGame_Report_${state.playerName}_${new Date().getTime()}.pdf`, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save().then(() => {
                btn.innerHTML = `<span>ğŸ“¥</span> <span>${t('btn_export')}</span>`;
                btn.disabled = false;
                document.getElementById('pdf-history-table').classList.add('hidden');
            });
        }
    </script>
</body>
</html>
